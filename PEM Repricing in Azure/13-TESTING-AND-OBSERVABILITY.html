<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>13-TESTING-AND-OBSERVABILITY</title>
  <style>
    /* Default styles provided by pandoc.
    ** See https://pandoc.org/MANUAL.html#variables-for-html for config info.
    */
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
    <style>
    /* ========== FinThrive Theme Styles (Embedded) ========== */
/* Load Google Font */
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');

body {
  font-family: 'Plus Jakarta Sans', sans-serif;
}
/* Typography Variables */
:root {
  /* Font Families */
  --font--headlines: 'Plus Jakarta Sans', sans-serif;
  --font--body-text: 'Plus Jakarta Sans', sans-serif;
  --font--accent: 'Plus Jakarta Sans', sans-serif;
  
  /* Font Weights */
  --weight--headlines: 500;
  --weight--body: normal;
  
  /* Display Sizes (Responsive) */
  --d-l: clamp(3.375rem, 4.464vi + 1.232rem, 5.250rem);
  --d-m: clamp(2.625rem, 5.060vi + 0.196rem, 4.750rem);
  --d-s: clamp(2.375rem, 2.381vi + 1.232rem, 3.375rem);
  --d-xs: clamp(2.375rem, 2.381vi + 1.232rem, 3.375rem);
  
  /* Heading Sizes (Responsive) */
  --h-xxl: clamp(2.375rem, 2.381vi + 1.232rem, 3.375rem);
  --h-xl: clamp(2.25rem, 0.893vi + 1.821rem, 2.625rem);
  --h-l: clamp(1.5rem, 1.786vi + 0.643rem, 2.250rem);
  --h-m: clamp(1.5rem, 0.595vi + 1.214rem, 1.750rem);
  --h-s: 1.3125rem;
  --h-xs: 1.125rem;
  
  /* Body Text Sizes */
  --b-l: clamp(1.25rem, 0.298vi + 1.107rem, 1.375rem);
  --b-m: 1.125rem;
  --b-s: 1.0rem;
  --b-xs: 0.875rem;
  
  /* Spacing Scale (Responsive) */
  --s-12: clamp(4.0rem, 20.238vi + -5.714rem, 12.500rem);
  --s-11: clamp(3.0rem, 16.667vi + -5.000rem, 10.000rem);
  --s-10: clamp(3.0rem, 11.905vi + -2.714rem, 8.000rem);
  --s-9: clamp(2.375rem, 8.631vi + -1.768rem, 6.000rem);
  --s-8: clamp(2.375rem, 3.869vi + 0.518rem, 4.000rem);
  --s-7: clamp(2.0rem, 2.381vi + 0.857rem, 3.000rem);
  --s-6: clamp(2.0rem, 0.595vi + 1.714rem, 2.250rem);
  --s-5: clamp(1.125rem, 0.893vi + 0.696rem, 1.500rem);
  --s-4: 1.125rem;
  --s-3: 0.75rem;
  --s-2: 0.5rem;
  --s-1: 0.25rem;
  --s-0: 0.0rem;
}

/* Light Mode Color Theme (Default) */
:root,
.light-mode {
  /* Primary Colors */
  --primary: #00E091;
  --primary--medium: #80F2C3;
  --primary--light: #C0F9E1;
  --primary--extra-light: #EBFBF7;
  --primary--dark: #005654;
  
  /* Secondary Colors */
  --secondary: #FF9B5C;
  --secondary--medium: #F87A3A;
  --secondary--light: #FFCA98;
  --secondary--extra-light: #fff2e5;
  --secondary--dark: #663E25;
  
  /* Tertiary Colors */
  --tertiary: #3E69FA;
  --tertiary--medium: #3356CC;
  --tertiary--light: #CAD6FF;
  --tertiary--dark: #13204D;
  
  /* Accent Color */
  --accent: #9efb21;
  
  /* Neutral Colors */
  --neutral--black: #005654;
  --neutral--dark: #005654;
  --neutral--medium-dark: #545757;
  --neutral--medium: #A8ABAB;
  --neutral--medium-light: #D4D6D6;
  --neutral--light: #F5F5F5;
  --neutral--white: #FFFFFF;
  
  /* Neutral Color Transparency Variants */
  --neutral--dark-80: rgba(0, 86, 84, 0.8);
  --neutral--dark-60: rgba(0, 86, 84, 0.6);
  --neutral--dark-40: rgba(0, 86, 84, 0.4);
  --neutral--dark-20: rgba(0, 86, 84, 0.2);
  --neutral--dark-10: rgba(0, 86, 84, 0.1);
  --neutral--white-80: rgba(255, 255, 255, 0.8);
  --neutral--white-60: rgba(255, 255, 255, 0.6);
  --neutral--white-40: rgba(255, 255, 255, 0.4);
  --neutral--white-20: rgba(255, 255, 255, 0.2);
  --neutral--white-10: rgba(255, 255, 255, 0.1);
  
  /* Card Styles */
  --card-border: var(--neutral--medium-light);
  --card-background-light: var(--neutral--white);
  --card-background-dark: var(--neutral--dark);
  --card-border-hover: var(--neutral--medium-dark);
  
  /* Input Styles */
  --input--border: var(--neutral--medium);
  --input--border-focused: var(--inline-links);
  --input--border-active: var(--neutral--medium-dark);
  --input--border-disabled: var(--neutral--medium-light);
  
  /* Text Colors */
  --headlines: #005654;
  --text: #005654;
  --text--80: rgba(0, 86, 84, 0.8);
  --text--60: rgba(0, 86, 84, 0.6);
  --text-input: #005654;
  
  /* UI Elements */
  --hr: var(--neutral--medium-light);
  
  /* Link Colors */
  --inline-links: #3254c8;
  --inline-links--hover: #7393FF;
  --inline-links--visited: #8C3EFA;
  --menu-links: #005654;
  --menu-links--hover: #00E091;
  --menu-links--active: #005654;
  
  /* Primary Button */
  --btn--primary-fg: var(--neutral--white);
  --btn--primary-fg-hover: var(--neutral--white);
  --btn--primary-bg: var(--primary);
  --btn--primary-bg-hover: var(--primary--medium);
  --btn--primary-stroke: var(--primary--dark);
  
  /* Secondary Button */
  --btn--secondary-fg: var(--neutral--white);
  --btn--secondary-fg-hover: var(--neutral--white);
  --btn--secondary-bg: var(--secondary);
  --btn--secondary-bg-hover: var(--secondary--medium);
  --btn--secondary-stroke: var(--neutral-dark);
  
  /* Tertiary Button */
  --btn--tertiary-fg: var(--neutral--white);
  --btn--tertiary-fg-hover: var(--neutral--white);
  --btn--tertiary-bg: var(--tertiary);
  --btn--tertiary-bg-hover: var(--tertiary--medium);
  --btn--tertiary-stroke: var(--neutral-dark);
  
  /* White Button */
  --btn--white-fg: var(--primary);
  --btn--white-fg-hover: var(--neutral--white);
  --btn--white-bg: var(--neutral--white);
  --btn--white-bg-hover: var(--primary);
  --btn--white-stroke: var(--neutral--white);
  
  color: var(--text);
}

/* Dark Mode Color Theme */
.dark-mode {
  /* Text Colors */
  --headlines: #FFFFFF;
  --text: #FFFFFF;
  --text-input: #FFFFFF;
  
  /* UI Elements */
  --hr: var(--neutral--medium-dark);
  
  /* Link Colors */
  --inline-links: #FFFFFF;
  --inline-links--hover: #70BAFE;
  --inline-links--visited: #FFFFFF;
  --menu-links: #FFFFFF;
  --menu-links--hover: #C0F9E1;
  --menu-links--active: #FFFFFF;
  
  /* Card Styles */
  --card-border: var(--neutral--white);
  --card-background-light: var(--neutral--light);
  --card-border-hover: var(--neutral--white);
  
  /* Button Strokes */
  --btn--primary-stroke: var(--neutral--white);
  --btn--secondary-stroke: var(--neutral--white);
  --btn--tertiary-stroke: var(--neutral--white);
  
  color: var(--text);
}

/* ========== Table Styles ========== */

table {
  width: 100%;
  border-collapse: collapse;
  margin: var(--s-5) 0;
  font-size: var(--b-s);
  font-family: var(--font--body-text);
  background-color: var(--neutral--white);
  border: 1px solid var(--neutral--medium-light);
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0, 86, 84, 0.08);
}

/* Table Header */
thead {
  background-color: var(--primary--extra-light);
}

thead tr {
  border-bottom: 2px solid var(--primary--medium);
}

th {
  padding: var(--s-3) var(--s-4);
  text-align: left;
  font-weight: var(--weight--headlines);
  color: var(--primary--dark);
  font-size: var(--b-s);
  letter-spacing: 0.02em;
  white-space: nowrap;
}

/* Table Body */
tbody tr {
  border-bottom: 1px solid var(--neutral--medium-light);
  transition: background-color 0.15s ease;
}

tbody tr:last-child {
  border-bottom: none;
}

/* Zebra Striping */
tbody tr:nth-child(even) {
  background-color: var(--neutral--light);
}

tbody tr:nth-child(odd) {
  background-color: var(--neutral--white);
}

/* Row Hover Effect */
tbody tr:hover {
  background-color: var(--primary--extra-light);
}

/* Table Cells */
td {
  padding: var(--s-3) var(--s-4);
  color: var(--text);
  vertical-align: top;
  line-height: 1.5;
}

/* Code in Table Cells */
td code,
th code {
  background-color: var(--neutral--light);
  padding: 0.15em 0.4em;
  border-radius: 4px;
  font-size: 0.9em;
  color: var(--tertiary--dark);
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
}

/* Bold text in first column */
td:first-child strong,
td strong {
  color: var(--primary--dark);
  font-weight: 600;
}

/* Column Groups - ensure proper column widths */
colgroup col {
  min-width: 80px;
}

/* Responsive Table Wrapper */
@media screen and (max-width: 768px) {
  table {
    display: block;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  th, td {
    min-width: 120px;
    padding: var(--s-2) var(--s-3);
    font-size: var(--b-xs);
  }
}

/* Dark Mode Table Styles */
.dark-mode table {
  background-color: var(--neutral--dark);
  border-color: var(--neutral--medium-dark);
}

.dark-mode thead {
  background-color: rgba(0, 224, 145, 0.15);
}

.dark-mode thead tr {
  border-bottom-color: var(--primary--medium);
}

.dark-mode th {
  color: var(--primary--medium);
}

.dark-mode tbody tr:nth-child(even) {
  background-color: rgba(255, 255, 255, 0.05);
}

.dark-mode tbody tr:nth-child(odd) {
  background-color: transparent;
}

.dark-mode tbody tr:hover {
  background-color: rgba(0, 224, 145, 0.1);
}

.dark-mode tbody tr {
  border-bottom-color: var(--neutral--medium-dark);
}

.dark-mode td {
  color: var(--text);
}

.dark-mode td code,
.dark-mode th code {
  background-color: rgba(255, 255, 255, 0.1);
  color: var(--primary--light);
}

/* ========== Additional Layout Styles ========== */

/* Body max-width and padding for readability */
body {
  max-width: 1200px;
  margin: 0 auto;
  padding: var(--s-6) var(--s-5);
  line-height: 1.6;
  background-color: var(--neutral--white);
}

/* Headings */
h1, h2, h3, h4, h5, h6 {
  font-family: var(--font--headlines);
  font-weight: var(--weight--headlines);
  color: var(--headlines);
  margin-top: var(--s-6);
  margin-bottom: var(--s-4);
  line-height: 1.3;
}

h1 {
  font-size: var(--h-xxl);
  color: var(--primary--dark);
  border-bottom: 3px solid var(--primary);
  padding-bottom: var(--s-3);
  margin-bottom: var(--s-5);
}

h2 {
  font-size: var(--h-xl);
  color: var(--primary--dark);
  border-bottom: 2px solid var(--primary--medium);
  padding-bottom: var(--s-2);
}

h3 {
  font-size: var(--h-l);
  color: var(--primary--dark);
}

h4 {
  font-size: var(--h-m);
}

h5 {
  font-size: var(--h-s);
}

h6 {
  font-size: var(--h-xs);
}

/* Horizontal Rules */
hr {
  border: none;
  border-top: 2px solid var(--hr);
  margin: var(--s-6) 0;
}

/* Paragraphs */
p {
  margin-bottom: var(--s-4);
  font-size: var(--b-m);
}

/* Links */
a {
  color: var(--inline-links);
  text-decoration: none;
  transition: color 0.15s ease;
}

a:hover {
  color: var(--inline-links--hover);
  text-decoration: underline;
}

a:visited {
  color: var(--inline-links--visited);
}

/* Blockquotes */
blockquote {
  border-left: 4px solid var(--primary);
  background-color: var(--primary--extra-light);
  padding: var(--s-4) var(--s-5);
  margin: var(--s-5) 0;
  border-radius: 0 8px 8px 0;
}

blockquote p {
  margin-bottom: 0;
}

/* Lists */
ul, ol {
  margin-bottom: var(--s-4);
  padding-left: var(--s-5);
}

li {
  margin-bottom: var(--s-2);
  line-height: 1.6;
}

/* Nested lists */
ul ul, ol ol, ul ol, ol ul {
  margin-top: var(--s-2);
  margin-bottom: 0;
}

/* Task Lists */
ul.task-list {
  list-style: none;
  padding-left: 0;
}

ul.task-list li {
  padding-left: var(--s-1);
}

/* Inline code */
code {
  background-color: var(--neutral--light);
  padding: 0.15em 0.4em;
  border-radius: 4px;
  font-size: 0.9em;
  color: var(--tertiary--dark);
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
}

/* Code blocks */
pre {
  background-color: #f8f9fa;
  color: #333333;
  border: 1px solid var(--neutral--medium-light);
  padding: var(--s-4);
  border-radius: 8px;
  overflow-x: auto;
  margin: var(--s-5) 0;
  font-size: var(--b-xs);
  line-height: 1.5;
}

pre code {
  background-color: transparent;
  padding: 0;
  color: inherit;
}

/* Mermaid diagrams */
.mermaid {
  margin: var(--s-5) 0;
  text-align: center;
  background-color: var(--neutral--white);
  padding: var(--s-4);
  border-radius: 8px;
  border: 1px solid var(--neutral--medium-light);
}
  </style>
  <!-- ========== Prism.JS Syntax Highlighting ========== -->

  <!-- Prism theme (choose one theme below) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/prismjs/themes/prism.css"
  />

  <!-- Core Prism library -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs/prism.min.js"></script>

  <!-- Add languages you need -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-csharp.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-json.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-sql.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-typescript.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-yaml.js"></script>

  <!-- Automatically highlight code after page load -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      if (window.Prism) {
        Prism.highlightAll();
      }
    });
  </script>

  <!-- ========== Mermaid Rendering ========== -->

  <!-- Use stable UMD build -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Find code blocks that came from ```mermaid fences
      const mermaidCodeBlocks = document.querySelectorAll(
        'pre.mermaid > code, pre > code.language-mermaid'
      );

      mermaidCodeBlocks.forEach(code => {
        const pre = code.parentElement;
        const parent = pre?.parentElement;
        if (!pre || !parent) return;

        const text = (code.textContent || '').trim();
        if (!text) return;

        // Replace <pre><code> with <div class="mermaid">...</div>
        const div = document.createElement('div');
        div.className = 'mermaid';
        div.textContent = text;

        parent.replaceChild(div, pre);
      });

      mermaid.initialize({
        startOnLoad: true
      });
    });
  </script>
  <!-- Navigation CSS and JS -->
  <link rel="stylesheet" href="navigation.css" />
  <script src="navigation.js" defer></script>
  <script src="/auth-check.js"></script>
</head>
<body>
<h1
id="testing-and-observability-strategy-for-containerized-repricing">Testing
and Observability Strategy for Containerized Repricing</h1>
<p><strong>Version:</strong> 1.0<br />
<strong>Last Updated:</strong> January 16, 2026<br />
<strong>Author:</strong> Andy Bratton<br />
<strong>Status:</strong> Phase 1 Requirement</p>
<hr />
<h2 id="overview">Overview</h2>
<p>This document defines the testing and observability strategy for the
containerized repricing engine. Given that we’re wrapping native C++
DLLs in a cloud-native architecture, special attention is required
for:</p>
<ol type="1">
<li><strong>Parity Testing</strong> - Ensuring container results match
legacy Contract Manager</li>
<li><strong>Native Code Observability</strong> - Tracing through
P/Invoke boundary</li>
<li><strong>Error Handling</strong> - Graceful handling of native
failures</li>
<li><strong>Performance Baselines</strong> - Establishing throughput
benchmarks</li>
</ol>
<hr />
<h2 id="testing-strategy">1. Testing Strategy</h2>
<h3 id="test-pyramid-for-repricing">Test Pyramid for Repricing</h3>
<pre><code>                        ▲
                       /▲\      E2E Parity Tests (~5%)
                      / ▲ \     Full claim comparison vs CM
                     /─────\
                    /  ◆◆◆  \   Performance Tests (~5%)
                   / ◆◆◆◆◆◆◆ \  Throughput &amp; latency
                  /───────────\
                 /  ◆◆◆◆◆◆◆◆◆  \   Integration Tests (~20%)
                / ◆◆◆◆◆◆◆◆◆◆◆◆◆ \  Bridge + Pricer + Cache
               /─────────────────\
              /  ███████████████  \   Unit Tests (~70%)
             / ███████████████████ \  Serialization, providers, wrapper
            /_______________________\</code></pre>
<table>
<thead>
<tr>
<th>Level</th>
<th>Test Type</th>
<th>% of Tests</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Top</td>
<td>E2E Parity Tests</td>
<td>~5%</td>
<td>Full claim comparison vs CM</td>
</tr>
<tr>
<td>2</td>
<td>Performance Tests</td>
<td>~5%</td>
<td>Throughput &amp; latency</td>
</tr>
<tr>
<td>3</td>
<td>Integration Tests</td>
<td>~20%</td>
<td>Bridge + Pricer + Cache</td>
</tr>
<tr>
<td>Base</td>
<td>Unit Tests</td>
<td>~70%</td>
<td>Serialization, providers, wrapper</td>
</tr>
</tbody>
</table>
<h3 id="test-categories">Test Categories</h3>
<table>
<colgroup>
<col style="width: 22%" />
<col style="width: 20%" />
<col style="width: 24%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Category</th>
<th>Purpose</th>
<th>Framework</th>
<th>Run Frequency</th>
</tr>
</thead>
<tbody>
<tr>
<td>Unit Tests</td>
<td>.NET wrapper logic, serializers</td>
<td>xUnit, Moq</td>
<td>Every commit</td>
</tr>
<tr>
<td>Integration Tests</td>
<td>Bridge + Native DLLs</td>
<td>xUnit + TestContainers</td>
<td>Every PR</td>
</tr>
<tr>
<td>Parity Tests</td>
<td>Compare vs legacy CM</td>
<td>Custom harness</td>
<td>Nightly</td>
</tr>
<tr>
<td>Performance Tests</td>
<td>Throughput benchmarks</td>
<td>BenchmarkDotNet, k6</td>
<td>Weekly</td>
</tr>
<tr>
<td>Smoke Tests</td>
<td>Container health</td>
<td>PowerShell/bash</td>
<td>Every deployment</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="unit-tests">2. Unit Tests</h2>
<h3 id="serialization-tests">Serialization Tests</h3>
<div class="sourceCode" id="cb2"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// EpisodeSerializerTests.cs</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> EpisodeSerializerTests</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>Fact<span class="op">]</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Deserialize_ValidJson_CreatesEpisode</span><span class="op">()</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Arrange</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> json <span class="op">=</span> <span class="fu">LoadTestFile</span><span class="op">(</span><span class="st">&quot;valid-medicare-ip-claim.json&quot;</span><span class="op">);</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Act</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> episode <span class="op">=</span> EpisodeSerializer<span class="op">.</span><span class="fu">Deserialize</span><span class="op">(</span>json<span class="op">);</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Assert</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">NotNull</span><span class="op">(</span>episode<span class="op">);</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">Equal</span><span class="op">(</span><span class="st">&quot;I&quot;</span><span class="op">,</span> episode<span class="op">.</span><span class="fu">PatientType</span><span class="op">);</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">Equal</span><span class="op">(</span><span class="st">&quot;I2101&quot;</span><span class="op">,</span> episode<span class="op">.</span><span class="fu">PrincipalDiagnosis</span><span class="op">);</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">Equal</span><span class="op">(</span><span class="dv">5</span><span class="op">,</span> episode<span class="op">.</span><span class="fu">LengthOfStay</span><span class="op">);</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">Equal</span><span class="op">(</span><span class="dv">12</span><span class="op">,</span> episode<span class="op">.</span><span class="fu">Diagnoses</span><span class="op">.</span><span class="fu">Count</span><span class="op">);</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>Theory<span class="op">]</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">InlineData</span><span class="op">(</span><span class="st">&quot;missing-admit-date.json&quot;</span><span class="op">)]</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">InlineData</span><span class="op">(</span><span class="st">&quot;invalid-bill-type.json&quot;</span><span class="op">)]</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">InlineData</span><span class="op">(</span><span class="st">&quot;null-charges.json&quot;</span><span class="op">)]</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Deserialize_InvalidJson_ThrowsValidationException</span><span class="op">(</span><span class="dt">string</span> testFile<span class="op">)</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> json <span class="op">=</span> <span class="fu">LoadTestFile</span><span class="op">(</span>testFile<span class="op">);</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">Throws</span><span class="op">&lt;</span>EpisodeValidationException<span class="op">&gt;(()</span> <span class="op">=&gt;</span> </span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>            EpisodeSerializer<span class="op">.</span><span class="fu">Deserialize</span><span class="op">(</span>json<span class="op">));</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>Fact<span class="op">]</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Serialize_PricingResult_RoundTrips</span><span class="op">()</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> result <span class="op">=</span> <span class="fu">CreateSamplePricingResult</span><span class="op">();</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> json <span class="op">=</span> EpisodeSerializer<span class="op">.</span><span class="fu">Serialize</span><span class="op">(</span>result<span class="op">);</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> deserialized <span class="op">=</span> JsonSerializer<span class="op">.</span><span class="fu">Deserialize</span><span class="op">&lt;</span>PricingResult<span class="op">&gt;(</span>json<span class="op">);</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">Equal</span><span class="op">(</span>result<span class="op">.</span><span class="fu">TotalPayment</span><span class="op">,</span> deserialized<span class="op">.</span><span class="fu">TotalPayment</span><span class="op">);</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">Equal</span><span class="op">(</span>result<span class="op">.</span><span class="fu">DrgCode</span><span class="op">,</span> deserialized<span class="op">.</span><span class="fu">DrgCode</span><span class="op">);</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="cache-provider-tests">Cache Provider Tests</h3>
<div class="sourceCode" id="cb3"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// DrgWeightProviderTests.cs</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> DrgWeightProviderTests</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> Mock<span class="op">&lt;</span>IMemoryCache<span class="op">&gt;</span> _memoryCache<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> Mock<span class="op">&lt;</span>IDistributedCache<span class="op">&gt;</span> _distCache<span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>Fact<span class="op">]</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">GetWeight_CacheHit_ReturnsWithoutDbCall</span><span class="op">()</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Arrange</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        _memoryCache<span class="op">.</span><span class="fu">Setup</span><span class="op">(</span>c <span class="op">=&gt;</span> c<span class="op">.</span><span class="fu">TryGetValue</span><span class="op">(</span><span class="st">&quot;drg:v43.0:470&quot;</span><span class="op">,</span> <span class="kw">out</span> It<span class="op">.</span><span class="fu">Ref</span><span class="op">&lt;</span><span class="dt">object</span><span class="op">&gt;.</span><span class="fu">IsAny</span><span class="op">))</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">Callback</span><span class="op">((</span><span class="dt">object</span> key<span class="op">,</span> <span class="kw">out</span> <span class="dt">object</span> value<span class="op">)</span> <span class="op">=&gt;</span> value <span class="op">=</span> <span class="kw">new</span> DrgWeight <span class="op">{</span> Weight <span class="op">=</span> <span class="fl">1.8766m</span> <span class="op">})</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">Returns</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> provider <span class="op">=</span> <span class="kw">new</span> <span class="fu">DrgWeightProvider</span><span class="op">(</span>_memoryCache<span class="op">.</span><span class="fu">Object</span><span class="op">,</span> _distCache<span class="op">.</span><span class="fu">Object</span><span class="op">,</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Act</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> weight <span class="op">=</span> await provider<span class="op">.</span><span class="fu">GetWeightAsync</span><span class="op">(</span><span class="st">&quot;470&quot;</span><span class="op">,</span> <span class="st">&quot;v43.0&quot;</span><span class="op">);</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Assert</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">Equal</span><span class="op">(</span><span class="fl">1.8766m</span><span class="op">,</span> weight<span class="op">);</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// No DB call made</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>Fact<span class="op">]</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">GetWeight_CacheMiss_QueriesDbAndCaches</span><span class="op">()</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Arrange</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        _memoryCache<span class="op">.</span><span class="fu">Setup</span><span class="op">(</span>c <span class="op">=&gt;</span> c<span class="op">.</span><span class="fu">TryGetValue</span><span class="op">(</span>It<span class="op">.</span><span class="fu">IsAny</span><span class="op">&lt;</span><span class="dt">object</span><span class="op">&gt;(),</span> <span class="kw">out</span> It<span class="op">.</span><span class="fu">Ref</span><span class="op">&lt;</span><span class="dt">object</span><span class="op">&gt;.</span><span class="fu">IsAny</span><span class="op">))</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">Returns</span><span class="op">(</span><span class="kw">false</span><span class="op">);</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>        _distCache<span class="op">.</span><span class="fu">Setup</span><span class="op">(</span>c <span class="op">=&gt;</span> c<span class="op">.</span><span class="fu">GetAsync</span><span class="op">(</span>It<span class="op">.</span><span class="fu">IsAny</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">&gt;(),</span> It<span class="op">.</span><span class="fu">IsAny</span><span class="op">&lt;</span>CancellationToken<span class="op">&gt;()))</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">ReturnsAsync</span><span class="op">((</span><span class="dt">byte</span><span class="op">[])</span><span class="kw">null</span><span class="op">);</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ... setup DB mock</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Act</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> weight <span class="op">=</span> await provider<span class="op">.</span><span class="fu">GetWeightAsync</span><span class="op">(</span><span class="st">&quot;470&quot;</span><span class="op">,</span> <span class="st">&quot;v43.0&quot;</span><span class="op">);</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Assert - verify cache was populated</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>        _memoryCache<span class="op">.</span><span class="fu">Verify</span><span class="op">(</span>c <span class="op">=&gt;</span> c<span class="op">.</span><span class="fu">Set</span><span class="op">(</span>It<span class="op">.</span><span class="fu">IsAny</span><span class="op">&lt;</span><span class="dt">object</span><span class="op">&gt;(),</span> It<span class="op">.</span><span class="fu">IsAny</span><span class="op">&lt;</span><span class="dt">object</span><span class="op">&gt;(),</span> </span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>            It<span class="op">.</span><span class="fu">IsAny</span><span class="op">&lt;</span>MemoryCacheEntryOptions<span class="op">&gt;()),</span> Times<span class="op">.</span><span class="fu">Once</span><span class="op">);</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="integration-tests">3. Integration Tests</h2>
<h3 id="native-bridge-integration-tests">Native Bridge Integration
Tests</h3>
<div class="sourceCode" id="cb4"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// NativeBridgeIntegrationTests.cs</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Collection</span><span class="op">(</span><span class="st">&quot;NativeBridge&quot;</span><span class="op">)]</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> NativeBridgeIntegrationTests <span class="op">:</span> IClassFixture<span class="op">&lt;</span>NativeBridgeFixture<span class="op">&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> NativeBridgeFixture _fixture<span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">NativeBridgeIntegrationTests</span><span class="op">(</span>NativeBridgeFixture fixture<span class="op">)</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        _fixture <span class="op">=</span> fixture<span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>Fact<span class="op">]</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">PriceEpisode_MedicareIP_ReturnsValidDrg</span><span class="op">()</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Arrange</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> claim <span class="op">=</span> <span class="fu">LoadTestClaim</span><span class="op">(</span><span class="st">&quot;medicare-ip-simple.json&quot;</span><span class="op">);</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Act</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> result <span class="op">=</span> await _fixture<span class="op">.</span><span class="fu">Bridge</span><span class="op">.</span><span class="fu">PriceAsync</span><span class="op">(</span>claim<span class="op">);</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Assert</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">True</span><span class="op">(</span>result<span class="op">.</span><span class="fu">Success</span><span class="op">);</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">NotEmpty</span><span class="op">(</span>result<span class="op">.</span><span class="fu">DrgCode</span><span class="op">);</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">True</span><span class="op">(</span>result<span class="op">.</span><span class="fu">TotalPayment</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>Fact<span class="op">]</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">PriceEpisode_MedicareOP_ReturnsValidApc</span><span class="op">()</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> claim <span class="op">=</span> <span class="fu">LoadTestClaim</span><span class="op">(</span><span class="st">&quot;medicare-op-simple.json&quot;</span><span class="op">);</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> result <span class="op">=</span> await _fixture<span class="op">.</span><span class="fu">Bridge</span><span class="op">.</span><span class="fu">PriceAsync</span><span class="op">(</span>claim<span class="op">);</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">True</span><span class="op">(</span>result<span class="op">.</span><span class="fu">Success</span><span class="op">);</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">NotEmpty</span><span class="op">(</span>result<span class="op">.</span><span class="fu">ApcAssignments</span><span class="op">);</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">All</span><span class="op">(</span>result<span class="op">.</span><span class="fu">ApcAssignments</span><span class="op">,</span> a <span class="op">=&gt;</span> Assert<span class="op">.</span><span class="fu">NotEmpty</span><span class="op">(</span>a<span class="op">.</span><span class="fu">ApcCode</span><span class="op">));</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>Theory<span class="op">]</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">InlineData</span><span class="op">(</span><span class="st">&quot;AZ&quot;</span><span class="op">)]</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">InlineData</span><span class="op">(</span><span class="st">&quot;IL&quot;</span><span class="op">)]</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">InlineData</span><span class="op">(</span><span class="st">&quot;TX&quot;</span><span class="op">)]</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">PriceEpisode_Medicaid_ByState</span><span class="op">(</span><span class="dt">string</span> state<span class="op">)</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> claim <span class="op">=</span> <span class="fu">LoadTestClaim</span><span class="op">(</span>$<span class="st">&quot;medicaid-{state.ToLower()}.json&quot;</span><span class="op">);</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> result <span class="op">=</span> await _fixture<span class="op">.</span><span class="fu">Bridge</span><span class="op">.</span><span class="fu">PriceAsync</span><span class="op">(</span>claim<span class="op">);</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">True</span><span class="op">(</span>result<span class="op">.</span><span class="fu">Success</span><span class="op">);</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">Equal</span><span class="op">(</span>state<span class="op">,</span> result<span class="op">.</span><span class="fu">StateCode</span><span class="op">);</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>Fact<span class="op">]</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">PriceEpisode_InvalidEpisode_ReturnsError</span><span class="op">()</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> claim <span class="op">=</span> <span class="kw">new</span> ClaimInput <span class="op">{</span> EpisodeId <span class="op">=</span> <span class="st">&quot;invalid&quot;</span> <span class="op">};</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> result <span class="op">=</span> await _fixture<span class="op">.</span><span class="fu">Bridge</span><span class="op">.</span><span class="fu">PriceAsync</span><span class="op">(</span>claim<span class="op">);</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">False</span><span class="op">(</span>result<span class="op">.</span><span class="fu">Success</span><span class="op">);</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">NotEmpty</span><span class="op">(</span>result<span class="op">.</span><span class="fu">ErrorCode</span><span class="op">);</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">NotEmpty</span><span class="op">(</span>result<span class="op">.</span><span class="fu">ErrorMessage</span><span class="op">);</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="container-integration-tests-testcontainers">Container
Integration Tests (TestContainers)</h3>
<div class="sourceCode" id="cb5"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ContainerIntegrationTests.cs</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ContainerIntegrationTests <span class="op">:</span> IAsyncLifetime</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> IContainer _pricingContainer<span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> IContainer _redisContainer<span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">InitializeAsync</span><span class="op">()</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Start Redis</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        _redisContainer <span class="op">=</span> <span class="kw">new</span> <span class="fu">ContainerBuilder</span><span class="op">()</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">WithImage</span><span class="op">(</span><span class="st">&quot;redis:7-alpine&quot;</span><span class="op">)</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">WithPortBinding</span><span class="op">(</span><span class="dv">6379</span><span class="op">,</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">Build</span><span class="op">();</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        await _redisContainer<span class="op">.</span><span class="fu">StartAsync</span><span class="op">();</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Start Pricing Worker</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        _pricingContainer <span class="op">=</span> <span class="kw">new</span> <span class="fu">ContainerBuilder</span><span class="op">()</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">WithImage</span><span class="op">(</span><span class="st">&quot;pricing-worker:test&quot;</span><span class="op">)</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">WithEnvironment</span><span class="op">(</span><span class="st">&quot;Redis__ConnectionString&quot;</span><span class="op">,</span> </span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>                $<span class="st">&quot;localhost:{_redisContainer.GetMappedPublicPort(6379)}&quot;</span><span class="op">)</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">WithPortBinding</span><span class="op">(</span><span class="dv">8080</span><span class="op">,</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">WithWaitStrategy</span><span class="op">(</span>Wait<span class="op">.</span><span class="fu">ForUnixContainer</span><span class="op">().</span><span class="fu">UntilHttpRequestIsSucceeded</span><span class="op">(</span>r <span class="op">=&gt;</span> </span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>                r<span class="op">.</span><span class="fu">ForPath</span><span class="op">(</span><span class="st">&quot;/health&quot;</span><span class="op">).</span><span class="fu">ForPort</span><span class="op">(</span><span class="dv">8080</span><span class="op">)))</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">Build</span><span class="op">();</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        await _pricingContainer<span class="op">.</span><span class="fu">StartAsync</span><span class="op">();</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>Fact<span class="op">]</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">Container_HealthCheck_ReturnsHealthy</span><span class="op">()</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> client <span class="op">=</span> <span class="kw">new</span> <span class="fu">HttpClient</span><span class="op">();</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> response <span class="op">=</span> await client<span class="op">.</span><span class="fu">GetAsync</span><span class="op">(</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>            $<span class="st">&quot;http://localhost:{_pricingContainer.GetMappedPublicPort(8080)}/health&quot;</span><span class="op">);</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">Equal</span><span class="op">(</span>HttpStatusCode<span class="op">.</span><span class="fu">OK</span><span class="op">,</span> response<span class="op">.</span><span class="fu">StatusCode</span><span class="op">);</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>Fact<span class="op">]</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">Container_PriceClaim_ReturnsResult</span><span class="op">()</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> client <span class="op">=</span> <span class="kw">new</span> <span class="fu">HttpClient</span><span class="op">();</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> claim <span class="op">=</span> <span class="fu">LoadTestClaim</span><span class="op">(</span><span class="st">&quot;medicare-ip-simple.json&quot;</span><span class="op">);</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> response <span class="op">=</span> await client<span class="op">.</span><span class="fu">PostAsJsonAsync</span><span class="op">(</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>            $<span class="st">&quot;http://localhost:{_pricingContainer.GetMappedPublicPort(8080)}/api/price&quot;</span><span class="op">,</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>            claim<span class="op">);</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">True</span><span class="op">(</span>response<span class="op">.</span><span class="fu">IsSuccessStatusCode</span><span class="op">);</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> result <span class="op">=</span> await response<span class="op">.</span><span class="fu">Content</span><span class="op">.</span><span class="fu">ReadFromJsonAsync</span><span class="op">&lt;</span>PricingResult<span class="op">&gt;();</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">True</span><span class="op">(</span>result<span class="op">.</span><span class="fu">Success</span><span class="op">);</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">DisposeAsync</span><span class="op">()</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>        await _pricingContainer<span class="op">.</span><span class="fu">StopAsync</span><span class="op">();</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>        await _redisContainer<span class="op">.</span><span class="fu">StopAsync</span><span class="op">();</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="parity-testing-critical">4. Parity Testing (CRITICAL)</h2>
<h3 id="purpose">Purpose</h3>
<p>Ensure containerized repricing produces <strong>identical
results</strong> to legacy Contract Manager. This is the most critical
test category.</p>
<h3 id="parity-test-framework">Parity Test Framework</h3>
<div class="sourceCode" id="cb6"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ParityTestHarness.cs</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ParityTestHarness</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> ILegacyCMClient _legacyClient<span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IContainerPricingClient _containerClient<span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> ITestOutputHelper _output<span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>Theory<span class="op">]</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">MemberData</span><span class="op">(</span><span class="fu">nameof</span><span class="op">(</span>GetGoldenEpisodes<span class="op">))]</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">Parity_GoldenEpisode_MatchesLegacy</span><span class="op">(</span><span class="dt">string</span> episodeId<span class="op">)</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Load episode from golden dataset</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> episode <span class="op">=</span> await <span class="fu">LoadGoldenEpisodeAsync</span><span class="op">(</span>episodeId<span class="op">);</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Price with legacy CM</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> legacyResult <span class="op">=</span> await _legacyClient<span class="op">.</span><span class="fu">PriceAsync</span><span class="op">(</span>episode<span class="op">);</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Price with container</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> containerResult <span class="op">=</span> await _containerClient<span class="op">.</span><span class="fu">PriceAsync</span><span class="op">(</span>episode<span class="op">);</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Compare results</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">AssertParityResults</span><span class="op">(</span>legacyResult<span class="op">,</span> containerResult<span class="op">,</span> episode<span class="op">);</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">AssertParityResults</span><span class="op">(</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        PricingResult legacy<span class="op">,</span> </span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        PricingResult container<span class="op">,</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        Episode episode<span class="op">)</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// DRG/APC must match exactly</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">Equal</span><span class="op">(</span>legacy<span class="op">.</span><span class="fu">DrgCode</span><span class="op">,</span> container<span class="op">.</span><span class="fu">DrgCode</span><span class="op">,</span> </span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>            $<span class="st">&quot;DRG mismatch for episode {episode.Id}&quot;</span><span class="op">);</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">Equal</span><span class="op">(</span>legacy<span class="op">.</span><span class="fu">MdcCode</span><span class="op">,</span> container<span class="op">.</span><span class="fu">MdcCode</span><span class="op">,</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>            $<span class="st">&quot;MDC mismatch for episode {episode.Id}&quot;</span><span class="op">);</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Payment must match within tolerance (floating point)</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> paymentDiff <span class="op">=</span> Math<span class="op">.</span><span class="fu">Abs</span><span class="op">(</span>legacy<span class="op">.</span><span class="fu">TotalPayment</span> <span class="op">-</span> container<span class="op">.</span><span class="fu">TotalPayment</span><span class="op">);</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">True</span><span class="op">(</span>paymentDiff <span class="op">&lt;</span> <span class="fl">0.01m</span><span class="op">,</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>            $<span class="st">&quot;Payment mismatch for episode {episode.Id}: &quot;</span> <span class="op">+</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>            $<span class="st">&quot;Legacy=${legacy.TotalPayment}, Container=${container.TotalPayment}&quot;</span><span class="op">);</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">// All component payments</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">Equal</span><span class="op">(</span>legacy<span class="op">.</span><span class="fu">DrgPayment</span><span class="op">,</span> container<span class="op">.</span><span class="fu">DrgPayment</span><span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">Equal</span><span class="op">(</span>legacy<span class="op">.</span><span class="fu">OutlierPayment</span><span class="op">,</span> container<span class="op">.</span><span class="fu">OutlierPayment</span><span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">Equal</span><span class="op">(</span>legacy<span class="op">.</span><span class="fu">ImePayment</span><span class="op">,</span> container<span class="op">.</span><span class="fu">ImePayment</span><span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">Equal</span><span class="op">(</span>legacy<span class="op">.</span><span class="fu">DshPayment</span><span class="op">,</span> container<span class="op">.</span><span class="fu">DshPayment</span><span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>        _output<span class="op">.</span><span class="fu">WriteLine</span><span class="op">(</span>$<span class="st">&quot;✓ Episode {episode.Id}: &quot;</span> <span class="op">+</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>            $<span class="st">&quot;DRG={legacy.DrgCode}, Payment=${legacy.TotalPayment}&quot;</span><span class="op">);</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> IEnumerable<span class="op">&lt;</span><span class="dt">object</span><span class="op">[]&gt;</span> <span class="fu">GetGoldenEpisodes</span><span class="op">()</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Load 10,000+ golden episodes from test data</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> episodes <span class="op">=</span> File<span class="op">.</span><span class="fu">ReadAllLines</span><span class="op">(</span><span class="st">&quot;golden-episodes.txt&quot;</span><span class="op">);</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> episodes<span class="op">.</span><span class="fu">Select</span><span class="op">(</span>e <span class="op">=&gt;</span> <span class="kw">new</span> <span class="dt">object</span><span class="op">[]</span> <span class="op">{</span> e <span class="op">});</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="golden-dataset-requirements">Golden Dataset Requirements</h3>
<table>
<thead>
<tr>
<th>Category</th>
<th>Count</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Medicare IP (simple)</td>
<td>2,000</td>
<td>Basic DRG grouping</td>
</tr>
<tr>
<td>Medicare IP (outlier)</td>
<td>500</td>
<td>Outlier calculations</td>
</tr>
<tr>
<td>Medicare IP (HAC)</td>
<td>200</td>
<td>HAC reduction testing</td>
</tr>
<tr>
<td>Medicare OP</td>
<td>2,000</td>
<td>APC grouping &amp; packaging</td>
</tr>
<tr>
<td>Medicaid (per state)</td>
<td>500/state</td>
<td>State-specific rules</td>
</tr>
<tr>
<td>TRICARE</td>
<td>500</td>
<td>Military pricing</td>
</tr>
<tr>
<td>Edge cases</td>
<td>1,000</td>
<td>Boundary conditions</td>
</tr>
<tr>
<td><strong>Total</strong></td>
<td><strong>~10,000</strong></td>
<td>Comprehensive parity</td>
</tr>
</tbody>
</table>
<h3 id="parity-test-reporting">Parity Test Reporting</h3>
<div class="sourceCode" id="cb7"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ParityReportGenerator.cs</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ParityReportGenerator</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ParityReport <span class="fu">GenerateReport</span><span class="op">(</span>IEnumerable<span class="op">&lt;</span>ParityTestResult<span class="op">&gt;</span> results<span class="op">)</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> report <span class="op">=</span> <span class="kw">new</span> ParityReport</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>            TotalTests <span class="op">=</span> results<span class="op">.</span><span class="fu">Count</span><span class="op">(),</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>            Passed <span class="op">=</span> results<span class="op">.</span><span class="fu">Count</span><span class="op">(</span>r <span class="op">=&gt;</span> r<span class="op">.</span><span class="fu">Success</span><span class="op">),</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>            Failed <span class="op">=</span> results<span class="op">.</span><span class="fu">Count</span><span class="op">(</span>r <span class="op">=&gt;</span> <span class="op">!</span>r<span class="op">.</span><span class="fu">Success</span><span class="op">),</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>            PassRate <span class="op">=</span> results<span class="op">.</span><span class="fu">Count</span><span class="op">(</span>r <span class="op">=&gt;</span> r<span class="op">.</span><span class="fu">Success</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="dt">decimal</span><span class="op">)</span>results<span class="op">.</span><span class="fu">Count</span><span class="op">()</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Group failures by category</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        report<span class="op">.</span><span class="fu">FailuresByCategory</span> <span class="op">=</span> results</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">Where</span><span class="op">(</span>r <span class="op">=&gt;</span> <span class="op">!</span>r<span class="op">.</span><span class="fu">Success</span><span class="op">)</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">GroupBy</span><span class="op">(</span>r <span class="op">=&gt;</span> r<span class="op">.</span><span class="fu">FailureCategory</span><span class="op">)</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">ToDictionary</span><span class="op">(</span>g <span class="op">=&gt;</span> g<span class="op">.</span><span class="fu">Key</span><span class="op">,</span> g <span class="op">=&gt;</span> g<span class="op">.</span><span class="fu">ToList</span><span class="op">());</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Generate HTML report</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GenerateHtmlReport</span><span class="op">(</span>report<span class="op">,</span> <span class="st">&quot;parity-report.html&quot;</span><span class="op">);</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> report<span class="op">;</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="parity-test-pipeline">Parity Test Pipeline</h3>
<div class="sourceCode" id="cb8"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># azure-pipelines-parity.yml</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">trigger</span><span class="kw">:</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">schedules</span><span class="kw">:</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">cron</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;0 2 * * *&quot;</span><span class="co">  # Run at 2 AM daily</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">displayName</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;Nightly Parity Tests&quot;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">branches</span><span class="kw">:</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">include</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">main</span><span class="kw">]</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="fu">stages</span><span class="kw">:</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">stage</span><span class="kw">:</span><span class="at"> ParityTest</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">job</span><span class="kw">:</span><span class="at"> RunParityTests</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">timeoutInMinutes</span><span class="kw">:</span><span class="at"> </span><span class="dv">180</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">pool</span><span class="kw">:</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">vmImage</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;windows-2022&#39;</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">task</span><span class="kw">:</span><span class="at"> DockerCompose@0</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">inputs</span><span class="kw">:</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">containerregistrytype</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;Azure Container Registry&#39;</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">dockerComposeFile</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;docker-compose.parity.yml&#39;</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">action</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;Run services&#39;</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="at">          </span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">task</span><span class="kw">:</span><span class="at"> DotNetCoreCLI@2</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">inputs</span><span class="kw">:</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;test&#39;</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">projects</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;**/Parity.Tests.csproj&#39;</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">arguments</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;--logger &quot;trx;LogFileName=parity-results.trx&quot;&#39;</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="at">          </span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">task</span><span class="kw">:</span><span class="at"> PublishTestResults@2</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">inputs</span><span class="kw">:</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">testResultsFormat</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;VSTest&#39;</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">testResultsFiles</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;**/parity-results.trx&#39;</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="at">          </span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="kw">          - </span><span class="fu">script</span><span class="kw">:</span><span class="at"> </span><span class="ch">|</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>              dotnet run --project ParityReporter -- parity-results.trx</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">displayName</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;Generate Parity Report&#39;</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="at">          </span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">task</span><span class="kw">:</span><span class="at"> PublishPipelineArtifact@1</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">inputs</span><span class="kw">:</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">targetPath</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;parity-report.html&#39;</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">artifact</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;parity-report&#39;</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="at">          </span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a><span class="co">          # Fail pipeline if parity rate &lt; 99.9%</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span class="kw">          - </span><span class="fu">script</span><span class="kw">:</span><span class="at"> </span><span class="ch">|</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>              $passRate = (Get-Content parity-summary.json | ConvertFrom-Json).PassRate</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>              if ($passRate -lt 0.999) {</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>                Write-Error &quot;Parity rate $passRate is below 99.9% threshold&quot;</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>                exit 1</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">displayName</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;Check Parity Threshold&#39;</span></span></code></pre></div>
<hr />
<h2 id="performance-testing">5. Performance Testing</h2>
<h3 id="throughput-benchmarks">Throughput Benchmarks</h3>
<div class="sourceCode" id="cb9"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// PricingBenchmarks.cs</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span>MemoryDiagnoser<span class="op">]</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">SimpleJob</span><span class="op">(</span>RuntimeMoniker<span class="op">.</span><span class="fu">Net80</span><span class="op">)]</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> PricingBenchmarks</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> IPricingBridge _bridge<span class="op">;</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> List<span class="op">&lt;</span>ClaimInput<span class="op">&gt;</span> _testClaims<span class="op">;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>GlobalSetup<span class="op">]</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Setup</span><span class="op">()</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        _bridge <span class="op">=</span> <span class="fu">CreatePricingBridge</span><span class="op">();</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        _testClaims <span class="op">=</span> <span class="fu">LoadTestClaims</span><span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>Benchmark<span class="op">]</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task<span class="op">&lt;</span>PricingResult<span class="op">&gt;</span> <span class="fu">PriceSingleClaim</span><span class="op">()</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> await _bridge<span class="op">.</span><span class="fu">PriceAsync</span><span class="op">(</span>_testClaims<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>Benchmark<span class="op">]</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">Arguments</span><span class="op">(</span><span class="dv">10</span><span class="op">)]</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">Arguments</span><span class="op">(</span><span class="dv">100</span><span class="op">)]</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">Arguments</span><span class="op">(</span><span class="dv">1000</span><span class="op">)]</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">PriceBatch</span><span class="op">(</span><span class="dt">int</span> batchSize<span class="op">)</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> tasks <span class="op">=</span> _testClaims<span class="op">.</span><span class="fu">Take</span><span class="op">(</span>batchSize<span class="op">)</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">Select</span><span class="op">(</span>c <span class="op">=&gt;</span> _bridge<span class="op">.</span><span class="fu">PriceAsync</span><span class="op">(</span>c<span class="op">));</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>        await Task<span class="op">.</span><span class="fu">WhenAll</span><span class="op">(</span>tasks<span class="op">);</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="load-testing-k6">Load Testing (k6)</h3>
<div class="sourceCode" id="cb10"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// load-test.js</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> http <span class="im">from</span> <span class="st">&#39;k6/http&#39;</span><span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { check<span class="op">,</span> sleep } <span class="im">from</span> <span class="st">&#39;k6&#39;</span><span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { Rate<span class="op">,</span> Trend } <span class="im">from</span> <span class="st">&#39;k6/metrics&#39;</span><span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> errorRate <span class="op">=</span> <span class="kw">new</span> <span class="fu">Rate</span>(<span class="st">&#39;errors&#39;</span>)<span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pricingDuration <span class="op">=</span> <span class="kw">new</span> <span class="fu">Trend</span>(<span class="st">&#39;pricing_duration&#39;</span>)<span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> options <span class="op">=</span> {</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">stages</span><span class="op">:</span> [</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        { <span class="dt">duration</span><span class="op">:</span> <span class="st">&#39;1m&#39;</span><span class="op">,</span> <span class="dt">target</span><span class="op">:</span> <span class="dv">10</span> }<span class="op">,</span>   <span class="co">// Ramp up</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        { <span class="dt">duration</span><span class="op">:</span> <span class="st">&#39;5m&#39;</span><span class="op">,</span> <span class="dt">target</span><span class="op">:</span> <span class="dv">50</span> }<span class="op">,</span>   <span class="co">// Sustained load</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        { <span class="dt">duration</span><span class="op">:</span> <span class="st">&#39;2m&#39;</span><span class="op">,</span> <span class="dt">target</span><span class="op">:</span> <span class="dv">100</span> }<span class="op">,</span>  <span class="co">// Peak load</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        { <span class="dt">duration</span><span class="op">:</span> <span class="st">&#39;1m&#39;</span><span class="op">,</span> <span class="dt">target</span><span class="op">:</span> <span class="dv">0</span> }<span class="op">,</span>    <span class="co">// Ramp down</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">,</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">thresholds</span><span class="op">:</span> {</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;http_req_duration&#39;</span><span class="op">:</span> [<span class="st">&#39;p(95)&lt;100&#39;</span>]<span class="op">,</span>  <span class="co">// 95th percentile &lt; 100ms</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;errors&#39;</span><span class="op">:</span> [<span class="st">&#39;rate&lt;0.01&#39;</span>]<span class="op">,</span>              <span class="co">// Error rate &lt; 1%</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> claims <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(<span class="fu">open</span>(<span class="st">&#39;./test-claims.json&#39;</span>))<span class="op">;</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> <span class="kw">function</span>() {</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> claim <span class="op">=</span> claims[<span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(<span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">*</span> claims<span class="op">.</span><span class="at">length</span>)]<span class="op">;</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> start <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> res <span class="op">=</span> http<span class="op">.</span><span class="fu">post</span>(</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        <span class="vs">`</span><span class="sc">${</span>__ENV<span class="op">.</span><span class="at">PRICING_URL</span><span class="sc">}</span><span class="vs">/api/price`</span><span class="op">,</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(claim)<span class="op">,</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>        { <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> } }</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> duration <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> start<span class="op">;</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    pricingDuration<span class="op">.</span><span class="fu">add</span>(duration)<span class="op">;</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">check</span>(res<span class="op">,</span> {</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;status is 200&#39;</span><span class="op">:</span> (r) <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">status</span> <span class="op">===</span> <span class="dv">200</span><span class="op">,</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;has pricing result&#39;</span><span class="op">:</span> (r) <span class="kw">=&gt;</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(r<span class="op">.</span><span class="at">body</span>)<span class="op">.</span><span class="at">success</span> <span class="op">===</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    errorRate<span class="op">.</span><span class="fu">add</span>(res<span class="op">.</span><span class="at">status</span> <span class="op">!==</span> <span class="dv">200</span>)<span class="op">;</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sleep</span>(<span class="fl">0.1</span>)<span class="op">;</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="performance-baselines">Performance Baselines</h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Target</th>
<th>Acceptable</th>
<th>Unacceptable</th>
</tr>
</thead>
<tbody>
<tr>
<td>P50 Latency</td>
<td>&lt; 20 ms</td>
<td>&lt; 50 ms</td>
<td>&gt; 100 ms</td>
</tr>
<tr>
<td>P95 Latency</td>
<td>&lt; 50 ms</td>
<td>&lt; 100 ms</td>
<td>&gt; 250 ms</td>
</tr>
<tr>
<td>P99 Latency</td>
<td>&lt; 100 ms</td>
<td>&lt; 200 ms</td>
<td>&gt; 500 ms</td>
</tr>
<tr>
<td>Throughput (per container)</td>
<td>&gt; 200/sec</td>
<td>&gt; 100/sec</td>
<td>&lt; 50/sec</td>
</tr>
<tr>
<td>Error Rate</td>
<td>&lt; 0.01%</td>
<td>&lt; 0.1%</td>
<td>&gt; 1%</td>
</tr>
<tr>
<td>Memory Usage</td>
<td>&lt; 500 MB</td>
<td>&lt; 1 GB</td>
<td>&gt; 2 GB</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="detailed-function-timing">6. Detailed Function Timing</h2>
<h3 id="timing-architecture">Timing Architecture</h3>
<p>Every containerized function can be instrumented with precise timing.
The key is using <strong>OpenTelemetry spans</strong> that trace through
both .NET and native code.</p>
<p><strong>Detailed Timing Trace:</strong></p>
<table>
<thead>
<tr>
<th>Time</th>
<th>Span</th>
<th>From</th>
<th>To</th>
<th>Action</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>T+0ms</td>
<td>ProcessClaim</td>
<td>Service Bus</td>
<td>Worker</td>
<td>Receive message</td>
<td>-</td>
</tr>
<tr>
<td>T+2ms</td>
<td>Deserialize</td>
<td>Worker</td>
<td>Worker</td>
<td>JSON → ClaimInput</td>
<td>2ms</td>
</tr>
<tr>
<td>T+3ms</td>
<td>LoadCachedData</td>
<td>Worker</td>
<td>Cache</td>
<td>Get provider rates</td>
<td>-</td>
</tr>
<tr>
<td>T+4ms</td>
<td></td>
<td>Cache</td>
<td>Worker</td>
<td>Cached data</td>
<td>1ms</td>
</tr>
<tr>
<td>T+5ms</td>
<td>NativePricing</td>
<td>Worker</td>
<td>Bridge</td>
<td>P/Invoke call</td>
<td>-</td>
</tr>
<tr>
<td>T+6ms</td>
<td>EpisodeToNative</td>
<td>Bridge</td>
<td>Bridge</td>
<td>JSON → HEpisode</td>
<td>1ms</td>
</tr>
<tr>
<td>T+7ms</td>
<td>DrgGrouping</td>
<td>Bridge</td>
<td>DRG Grouper</td>
<td>hadgrp.dll</td>
<td>-</td>
</tr>
<tr>
<td>T+12ms</td>
<td></td>
<td>DRG Grouper</td>
<td>Bridge</td>
<td>DRG result</td>
<td>5ms</td>
</tr>
<tr>
<td>T+13ms</td>
<td>MedicarePricing</td>
<td>Bridge</td>
<td>Pricer DLL</td>
<td>Price claim</td>
<td>-</td>
</tr>
<tr>
<td>T+18ms</td>
<td></td>
<td>Pricer DLL</td>
<td>Bridge</td>
<td>Payment</td>
<td>5ms</td>
</tr>
<tr>
<td>T+19ms</td>
<td>ResultToJson</td>
<td>Bridge</td>
<td>Bridge</td>
<td>Result → JSON</td>
<td>1ms</td>
</tr>
<tr>
<td>T+20ms</td>
<td></td>
<td>Bridge</td>
<td>Worker</td>
<td>Result</td>
<td>-</td>
</tr>
</tbody>
</table>
<pre><code>ProcessClaim (20ms total)
├── Deserialize (2ms)
├── LoadCachedData (1ms)
└── NativePricing (15ms)
    ├── EpisodeToNative (1ms)
    ├── DrgGrouping (5ms)
    ├── MedicarePricing (5ms)
    └── ResultToJson (1ms)</code></pre>
<pre><code>Note over Worker: End Span: &quot;NativePricing&quot; 15ms

Note over Worker: Start Span: &quot;SendResult&quot;
Worker-&gt;&gt;SB: Send result (T+21ms)
Note over Worker: End Span: 1ms

Note over Worker: End Span: &quot;ProcessClaim&quot; 21ms</code></pre>
<pre><code>
### Timing Implementation

#### .NET Wrapper Timing

```csharp
// PricingInstrumentation.cs
public static class PricingInstrumentation
{
    public static readonly ActivitySource Source = 
        new(&quot;PEM.Repricing&quot;, &quot;1.0.0&quot;);
    
    // Metric counters
    private static readonly Histogram&lt;double&gt; DeserializeDuration = 
        Metrics.CreateHistogram&lt;double&gt;(&quot;repricing_deserialize_ms&quot;);
    private static readonly Histogram&lt;double&gt; CacheLoadDuration = 
        Metrics.CreateHistogram&lt;double&gt;(&quot;repricing_cache_load_ms&quot;);
    private static readonly Histogram&lt;double&gt; NativePricingDuration = 
        Metrics.CreateHistogram&lt;double&gt;(&quot;repricing_native_pricing_ms&quot;);
    private static readonly Histogram&lt;double&gt; DrgGroupingDuration = 
        Metrics.CreateHistogram&lt;double&gt;(&quot;repricing_drg_grouping_ms&quot;);
    private static readonly Histogram&lt;double&gt; MedicarePricingDuration = 
        Metrics.CreateHistogram&lt;double&gt;(&quot;repricing_medicare_pricing_ms&quot;);
    private static readonly Histogram&lt;double&gt; SerializeDuration = 
        Metrics.CreateHistogram&lt;double&gt;(&quot;repricing_serialize_ms&quot;);
    private static readonly Histogram&lt;double&gt; TotalDuration = 
        Metrics.CreateHistogram&lt;double&gt;(&quot;repricing_total_ms&quot;);
}</code></pre>
<h4 id="instrumented-claim-processor">Instrumented Claim Processor</h4>
<div class="sourceCode" id="cb14"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// InstrumentedClaimProcessor.cs</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> InstrumentedClaimProcessor</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IPricingBridge _bridge<span class="op">;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> ICacheManager _cache<span class="op">;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> TelemetryClient _telemetry<span class="op">;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task<span class="op">&lt;</span>PricingResult<span class="op">&gt;</span> <span class="fu">ProcessClaimAsync</span><span class="op">(</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        ClaimInput claim<span class="op">,</span> </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        CancellationToken ct<span class="op">)</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> timings <span class="op">=</span> <span class="kw">new</span> <span class="fu">PricingTimings</span><span class="op">();</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> totalSw <span class="op">=</span> Stopwatch<span class="op">.</span><span class="fu">StartNew</span><span class="op">();</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">using</span> <span class="dt">var</span> activity <span class="op">=</span> PricingInstrumentation<span class="op">.</span><span class="fu">Source</span><span class="op">.</span><span class="fu">StartActivity</span><span class="op">(</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;ProcessClaim&quot;</span><span class="op">,</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>            ActivityKind<span class="op">.</span><span class="fu">Server</span><span class="op">);</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        activity<span class="op">?.</span><span class="fu">SetTag</span><span class="op">(</span><span class="st">&quot;claim.id&quot;</span><span class="op">,</span> claim<span class="op">.</span><span class="fu">ClaimId</span><span class="op">);</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>        activity<span class="op">?.</span><span class="fu">SetTag</span><span class="op">(</span><span class="st">&quot;claim.payer_program&quot;</span><span class="op">,</span> claim<span class="op">.</span><span class="fu">PayerProgram</span><span class="op">);</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">try</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 1. Deserialize / Validate</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">using</span> <span class="op">(</span><span class="dt">var</span> deserializeSpan <span class="op">=</span> PricingInstrumentation<span class="op">.</span><span class="fu">Source</span><span class="op">.</span><span class="fu">StartActivity</span><span class="op">(</span><span class="st">&quot;Deserialize&quot;</span><span class="op">))</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>                <span class="dt">var</span> sw <span class="op">=</span> Stopwatch<span class="op">.</span><span class="fu">StartNew</span><span class="op">();</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ValidateInput</span><span class="op">(</span>claim<span class="op">);</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>                timings<span class="op">.</span><span class="fu">DeserializeMs</span> <span class="op">=</span> sw<span class="op">.</span><span class="fu">ElapsedMilliseconds</span><span class="op">;</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>                deserializeSpan<span class="op">?.</span><span class="fu">SetTag</span><span class="op">(</span><span class="st">&quot;duration_ms&quot;</span><span class="op">,</span> timings<span class="op">.</span><span class="fu">DeserializeMs</span><span class="op">);</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 2. Load cached data</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>            CachedPricingData cachedData<span class="op">;</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>            <span class="kw">using</span> <span class="op">(</span><span class="dt">var</span> cacheSpan <span class="op">=</span> PricingInstrumentation<span class="op">.</span><span class="fu">Source</span><span class="op">.</span><span class="fu">StartActivity</span><span class="op">(</span><span class="st">&quot;LoadCachedData&quot;</span><span class="op">))</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>                <span class="dt">var</span> sw <span class="op">=</span> Stopwatch<span class="op">.</span><span class="fu">StartNew</span><span class="op">();</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>                cachedData <span class="op">=</span> await <span class="fu">LoadCachedDataAsync</span><span class="op">(</span>claim<span class="op">,</span> ct<span class="op">);</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>                timings<span class="op">.</span><span class="fu">CacheLoadMs</span> <span class="op">=</span> sw<span class="op">.</span><span class="fu">ElapsedMilliseconds</span><span class="op">;</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>                cacheSpan<span class="op">?.</span><span class="fu">SetTag</span><span class="op">(</span><span class="st">&quot;duration_ms&quot;</span><span class="op">,</span> timings<span class="op">.</span><span class="fu">CacheLoadMs</span><span class="op">);</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>                cacheSpan<span class="op">?.</span><span class="fu">SetTag</span><span class="op">(</span><span class="st">&quot;cache.provider_hit&quot;</span><span class="op">,</span> cachedData<span class="op">.</span><span class="fu">ProviderRatesFromCache</span><span class="op">);</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>                cacheSpan<span class="op">?.</span><span class="fu">SetTag</span><span class="op">(</span><span class="st">&quot;cache.fee_schedule_hit&quot;</span><span class="op">,</span> cachedData<span class="op">.</span><span class="fu">FeeScheduleFromCache</span><span class="op">);</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 3. Native pricing (detailed timing from bridge)</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>            PricingResult result<span class="op">;</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>            NativeTimings nativeTimings<span class="op">;</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>            <span class="kw">using</span> <span class="op">(</span><span class="dt">var</span> nativeSpan <span class="op">=</span> PricingInstrumentation<span class="op">.</span><span class="fu">Source</span><span class="op">.</span><span class="fu">StartActivity</span><span class="op">(</span><span class="st">&quot;NativePricing&quot;</span><span class="op">))</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>                <span class="dt">var</span> sw <span class="op">=</span> Stopwatch<span class="op">.</span><span class="fu">StartNew</span><span class="op">();</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>                <span class="op">(</span>result<span class="op">,</span> nativeTimings<span class="op">)</span> <span class="op">=</span> await _bridge<span class="op">.</span><span class="fu">PriceWithTimingsAsync</span><span class="op">(</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>                    claim<span class="op">,</span> cachedData<span class="op">,</span> ct<span class="op">);</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>                timings<span class="op">.</span><span class="fu">NativeTotalMs</span> <span class="op">=</span> sw<span class="op">.</span><span class="fu">ElapsedMilliseconds</span><span class="op">;</span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>                timings<span class="op">.</span><span class="fu">Native</span> <span class="op">=</span> nativeTimings<span class="op">;</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>                nativeSpan<span class="op">?.</span><span class="fu">SetTag</span><span class="op">(</span><span class="st">&quot;duration_ms&quot;</span><span class="op">,</span> timings<span class="op">.</span><span class="fu">NativeTotalMs</span><span class="op">);</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>                nativeSpan<span class="op">?.</span><span class="fu">SetTag</span><span class="op">(</span><span class="st">&quot;native.episode_conversion_ms&quot;</span><span class="op">,</span> nativeTimings<span class="op">.</span><span class="fu">EpisodeConversionMs</span><span class="op">);</span></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>                nativeSpan<span class="op">?.</span><span class="fu">SetTag</span><span class="op">(</span><span class="st">&quot;native.drg_grouping_ms&quot;</span><span class="op">,</span> nativeTimings<span class="op">.</span><span class="fu">DrgGroupingMs</span><span class="op">);</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>                nativeSpan<span class="op">?.</span><span class="fu">SetTag</span><span class="op">(</span><span class="st">&quot;native.medicare_pricing_ms&quot;</span><span class="op">,</span> nativeTimings<span class="op">.</span><span class="fu">MedicarePricingMs</span><span class="op">);</span></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>                nativeSpan<span class="op">?.</span><span class="fu">SetTag</span><span class="op">(</span><span class="st">&quot;native.result_serialization_ms&quot;</span><span class="op">,</span> nativeTimings<span class="op">.</span><span class="fu">ResultSerializationMs</span><span class="op">);</span></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 4. Serialize result</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>            <span class="kw">using</span> <span class="op">(</span><span class="dt">var</span> serializeSpan <span class="op">=</span> PricingInstrumentation<span class="op">.</span><span class="fu">Source</span><span class="op">.</span><span class="fu">StartActivity</span><span class="op">(</span><span class="st">&quot;SerializeResult&quot;</span><span class="op">))</span></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>                <span class="dt">var</span> sw <span class="op">=</span> Stopwatch<span class="op">.</span><span class="fu">StartNew</span><span class="op">();</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>                <span class="fu">SerializeResult</span><span class="op">(</span>result<span class="op">);</span></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>                timings<span class="op">.</span><span class="fu">SerializeMs</span> <span class="op">=</span> sw<span class="op">.</span><span class="fu">ElapsedMilliseconds</span><span class="op">;</span></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>                serializeSpan<span class="op">?.</span><span class="fu">SetTag</span><span class="op">(</span><span class="st">&quot;duration_ms&quot;</span><span class="op">,</span> timings<span class="op">.</span><span class="fu">SerializeMs</span><span class="op">);</span></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>            timings<span class="op">.</span><span class="fu">TotalMs</span> <span class="op">=</span> totalSw<span class="op">.</span><span class="fu">ElapsedMilliseconds</span><span class="op">;</span></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Record all metrics</span></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>            <span class="fu">RecordTimingMetrics</span><span class="op">(</span>claim<span class="op">,</span> timings<span class="op">);</span></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Add timing breakdown to result</span></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>            result<span class="op">.</span><span class="fu">Timings</span> <span class="op">=</span> timings<span class="op">;</span></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> result<span class="op">;</span></span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>        <span class="kw">catch</span> <span class="op">(</span>Exception ex<span class="op">)</span></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>            activity<span class="op">?.</span><span class="fu">SetStatus</span><span class="op">(</span>ActivityStatusCode<span class="op">.</span><span class="fu">Error</span><span class="op">,</span> ex<span class="op">.</span><span class="fu">Message</span><span class="op">);</span></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throw</span><span class="op">;</span></span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">RecordTimingMetrics</span><span class="op">(</span>ClaimInput claim<span class="op">,</span> PricingTimings timings<span class="op">)</span></span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> tags <span class="op">=</span> <span class="kw">new</span> TagList</span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span> <span class="st">&quot;payer_program&quot;</span><span class="op">,</span> claim<span class="op">.</span><span class="fu">PayerProgram</span> <span class="op">},</span></span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span> <span class="st">&quot;state&quot;</span><span class="op">,</span> claim<span class="op">.</span><span class="fu">StateCode</span> <span class="op">??</span> <span class="st">&quot;N/A&quot;</span> <span class="op">}</span></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>        PricingInstrumentation<span class="op">.</span><span class="fu">DeserializeDuration</span><span class="op">.</span><span class="fu">Record</span><span class="op">(</span>timings<span class="op">.</span><span class="fu">DeserializeMs</span><span class="op">,</span> tags<span class="op">);</span></span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>        PricingInstrumentation<span class="op">.</span><span class="fu">CacheLoadDuration</span><span class="op">.</span><span class="fu">Record</span><span class="op">(</span>timings<span class="op">.</span><span class="fu">CacheLoadMs</span><span class="op">,</span> tags<span class="op">);</span></span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>        PricingInstrumentation<span class="op">.</span><span class="fu">NativePricingDuration</span><span class="op">.</span><span class="fu">Record</span><span class="op">(</span>timings<span class="op">.</span><span class="fu">NativeTotalMs</span><span class="op">,</span> tags<span class="op">);</span></span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>        PricingInstrumentation<span class="op">.</span><span class="fu">DrgGroupingDuration</span><span class="op">.</span><span class="fu">Record</span><span class="op">(</span>timings<span class="op">.</span><span class="fu">Native</span><span class="op">.</span><span class="fu">DrgGroupingMs</span><span class="op">,</span> tags<span class="op">);</span></span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>        PricingInstrumentation<span class="op">.</span><span class="fu">MedicarePricingDuration</span><span class="op">.</span><span class="fu">Record</span><span class="op">(</span>timings<span class="op">.</span><span class="fu">Native</span><span class="op">.</span><span class="fu">MedicarePricingMs</span><span class="op">,</span> tags<span class="op">);</span></span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>        PricingInstrumentation<span class="op">.</span><span class="fu">SerializeDuration</span><span class="op">.</span><span class="fu">Record</span><span class="op">(</span>timings<span class="op">.</span><span class="fu">SerializeMs</span><span class="op">,</span> tags<span class="op">);</span></span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>        PricingInstrumentation<span class="op">.</span><span class="fu">TotalDuration</span><span class="op">.</span><span class="fu">Record</span><span class="op">(</span>timings<span class="op">.</span><span class="fu">TotalMs</span><span class="op">,</span> tags<span class="op">);</span></span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Also send to Application Insights</span></span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a>        _telemetry<span class="op">.</span><span class="fu">TrackMetric</span><span class="op">(</span><span class="st">&quot;DeserializeMs&quot;</span><span class="op">,</span> timings<span class="op">.</span><span class="fu">DeserializeMs</span><span class="op">);</span></span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>        _telemetry<span class="op">.</span><span class="fu">TrackMetric</span><span class="op">(</span><span class="st">&quot;CacheLoadMs&quot;</span><span class="op">,</span> timings<span class="op">.</span><span class="fu">CacheLoadMs</span><span class="op">);</span></span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>        _telemetry<span class="op">.</span><span class="fu">TrackMetric</span><span class="op">(</span><span class="st">&quot;NativeTotalMs&quot;</span><span class="op">,</span> timings<span class="op">.</span><span class="fu">NativeTotalMs</span><span class="op">);</span></span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>        _telemetry<span class="op">.</span><span class="fu">TrackMetric</span><span class="op">(</span><span class="st">&quot;DrgGroupingMs&quot;</span><span class="op">,</span> timings<span class="op">.</span><span class="fu">Native</span><span class="op">.</span><span class="fu">DrgGroupingMs</span><span class="op">);</span></span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a>        _telemetry<span class="op">.</span><span class="fu">TrackMetric</span><span class="op">(</span><span class="st">&quot;MedicarePricingMs&quot;</span><span class="op">,</span> timings<span class="op">.</span><span class="fu">Native</span><span class="op">.</span><span class="fu">MedicarePricingMs</span><span class="op">);</span></span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a>        _telemetry<span class="op">.</span><span class="fu">TrackMetric</span><span class="op">(</span><span class="st">&quot;SerializeMs&quot;</span><span class="op">,</span> timings<span class="op">.</span><span class="fu">SerializeMs</span><span class="op">);</span></span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a>        _telemetry<span class="op">.</span><span class="fu">TrackMetric</span><span class="op">(</span><span class="st">&quot;TotalMs&quot;</span><span class="op">,</span> timings<span class="op">.</span><span class="fu">TotalMs</span><span class="op">);</span></span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="timing-data-structures">Timing Data Structures</h3>
<div class="sourceCode" id="cb15"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// PricingTimings.cs</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> PricingTimings</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// High-level .NET timings</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> TotalMs <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> DeserializeMs <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> CacheLoadMs <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> NativeTotalMs <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> SerializeMs <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Detailed native timings (from bridge)</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> NativeTimings Native <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span> <span class="op">=</span> <span class="kw">new</span><span class="op">();</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Computed properties</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> OverheadMs <span class="op">=&gt;</span> TotalMs <span class="op">-</span> NativeTotalMs<span class="op">;</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">double</span> NativePercent <span class="op">=&gt;</span> <span class="op">(</span><span class="dt">double</span><span class="op">)</span>NativeTotalMs <span class="op">/</span> TotalMs <span class="op">*</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> NativeTimings</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Bridge layer</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> EpisodeConversionMs <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> ResultSerializationMs <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Grouper timings</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> DrgGroupingMs <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> ApcGroupingMs <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Pricer timings</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> MedicarePricingMs <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> MedicaidPricingMs <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> TricarePricingMs <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Database lookups (if not cached)</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> DbLookupMs <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Total native time</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> TotalNativeMs <span class="op">=&gt;</span> EpisodeConversionMs <span class="op">+</span> DrgGroupingMs <span class="op">+</span> ApcGroupingMs <span class="op">+</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>        MedicarePricingMs <span class="op">+</span> MedicaidPricingMs <span class="op">+</span> TricarePricingMs <span class="op">+</span> </span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>        ResultSerializationMs <span class="op">+</span> DbLookupMs<span class="op">;</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="native-bridge-timing">Native Bridge Timing</h3>
<div class="sourceCode" id="cb16"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// CboPricingBridge.cpp - Timing instrumentation</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> PricingTimingsNative</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    LONGLONG EpisodeConversionMs<span class="op">;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    LONGLONG DrgGroupingMs<span class="op">;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    LONGLONG ApcGroupingMs<span class="op">;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    LONGLONG MedicarePricingMs<span class="op">;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    LONGLONG MedicaidPricingMs<span class="op">;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    LONGLONG ResultSerializationMs<span class="op">;</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>LONGLONG GetTimestampMs<span class="op">()</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    LARGE_INTEGER freq<span class="op">,</span> count<span class="op">;</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    QueryPerformanceFrequency<span class="op">(&amp;</span>freq<span class="op">);</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    QueryPerformanceCounter<span class="op">(&amp;</span>count<span class="op">);</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">(</span>count<span class="op">.</span>QuadPart <span class="op">*</span> <span class="dv">1000</span><span class="op">)</span> <span class="op">/</span> freq<span class="op">.</span>QuadPart<span class="op">;</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="at">extern</span> <span class="st">&quot;C&quot;</span> <span class="ex">__declspec(dllexport)</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>HRESULT PriceEpisodeWithTimings<span class="op">(</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    _In_ LPCWSTR episodeJson<span class="op">,</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    _In_ LPCWSTR cachedDataJson<span class="op">,</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    _Out_ LPWSTR<span class="op">*</span> resultJson<span class="op">,</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    _Out_ DWORD<span class="op">*</span> resultLength<span class="op">,</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    _Out_ PricingTimingsNative<span class="op">*</span> timings<span class="op">)</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    LONGLONG startTime<span class="op">,</span> endTime<span class="op">;</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 1. Episode conversion timing</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    startTime <span class="op">=</span> GetTimestampMs<span class="op">();</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> episode <span class="op">=</span> EpisodeSerializer<span class="op">::</span>DeserializeFromJson<span class="op">(</span>episodeJson<span class="op">);</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    endTime <span class="op">=</span> GetTimestampMs<span class="op">();</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    timings<span class="op">-&gt;</span>EpisodeConversionMs <span class="op">=</span> endTime <span class="op">-</span> startTime<span class="op">;</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 2. DRG grouping timing (if inpatient)</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>episode<span class="op">-&gt;</span>GetPatientType<span class="op">()</span> <span class="op">==</span> <span class="st">L&quot;I&quot;</span><span class="op">)</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>        startTime <span class="op">=</span> GetTimestampMs<span class="op">();</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span> drgResult <span class="op">=</span> <span class="bu">std::</span>make_shared<span class="op">&lt;</span>HBillInvDRG<span class="op">&gt;();</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>        HDRGGrouper grouper<span class="op">(</span><span class="va">g_Logger</span><span class="op">);</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>        grouper<span class="op">.</span>ProcessDRGGrouper<span class="op">(</span>episode<span class="op">,</span> episode<span class="op">-&gt;</span>GetConeffKey<span class="op">(),</span> drgResult<span class="op">);</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>        endTime <span class="op">=</span> GetTimestampMs<span class="op">();</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>        timings<span class="op">-&gt;</span>DrgGroupingMs <span class="op">=</span> endTime <span class="op">-</span> startTime<span class="op">;</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 3. APC grouping timing (if outpatient)</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>episode<span class="op">-&gt;</span>GetPatientType<span class="op">()</span> <span class="op">==</span> <span class="st">L&quot;O&quot;</span><span class="op">)</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>        startTime <span class="op">=</span> GetTimestampMs<span class="op">();</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>        <span class="co">// APC grouping logic...</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>        endTime <span class="op">=</span> GetTimestampMs<span class="op">();</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>        timings<span class="op">-&gt;</span>ApcGroupingMs <span class="op">=</span> endTime <span class="op">-</span> startTime<span class="op">;</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 4. Medicare pricing timing</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>    startTime <span class="op">=</span> GetTimestampMs<span class="op">();</span></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>    HPricingResult pricingResult<span class="op">;</span></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>    MedicareInpatientServiceInvoker invoker<span class="op">;</span></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>    invoker<span class="op">.</span>PriceEpisode<span class="op">(</span>episode<span class="op">,</span> drgResult<span class="op">,</span> pricingResult<span class="op">);</span></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>    endTime <span class="op">=</span> GetTimestampMs<span class="op">();</span></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>    timings<span class="op">-&gt;</span>MedicarePricingMs <span class="op">=</span> endTime <span class="op">-</span> startTime<span class="op">;</span></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 5. Result serialization timing</span></span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>    startTime <span class="op">=</span> GetTimestampMs<span class="op">();</span></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>wstring result <span class="op">=</span> EpisodeSerializer<span class="op">::</span>SerializeToJson<span class="op">(</span>episode<span class="op">,</span> pricingResult<span class="op">);</span></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>    endTime <span class="op">=</span> GetTimestampMs<span class="op">();</span></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>    timings<span class="op">-&gt;</span>ResultSerializationMs <span class="op">=</span> endTime <span class="op">-</span> startTime<span class="op">;</span></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Copy result to output buffer...</span></span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> S_OK<span class="op">;</span></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="net-pinvoke-with-timings">.NET P/Invoke with Timings</h3>
<div class="sourceCode" id="cb17"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">// NativePricingBridge.cs</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> NativePricingBridge <span class="op">:</span> IPricingBridge</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">StructLayout</span><span class="op">(</span>LayoutKind<span class="op">.</span><span class="fu">Sequential</span><span class="op">)]</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">struct</span> NativeTimingsStruct</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">long</span> EpisodeConversionMs<span class="op">;</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">long</span> DrgGroupingMs<span class="op">;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">long</span> ApcGroupingMs<span class="op">;</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">long</span> MedicarePricingMs<span class="op">;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">long</span> MedicaidPricingMs<span class="op">;</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">long</span> ResultSerializationMs<span class="op">;</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">DllImport</span><span class="op">(</span><span class="st">&quot;CboPricingBridge.dll&quot;</span><span class="op">,</span> CharSet <span class="op">=</span> CharSet<span class="op">.</span><span class="fu">Unicode</span><span class="op">)]</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">static</span> <span class="kw">extern</span> <span class="dt">int</span> <span class="fu">PriceEpisodeWithTimings</span><span class="op">(</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">string</span> episodeJson<span class="op">,</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">string</span> cachedDataJson<span class="op">,</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">out</span> IntPtr resultJson<span class="op">,</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">out</span> <span class="dt">uint</span> resultLength<span class="op">,</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">out</span> NativeTimingsStruct timings<span class="op">);</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task<span class="op">&lt;(</span>PricingResult<span class="op">,</span> NativeTimings<span class="op">)&gt;</span> <span class="fu">PriceWithTimingsAsync</span><span class="op">(</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        ClaimInput claim<span class="op">,</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        CachedPricingData cachedData<span class="op">,</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        CancellationToken ct<span class="op">)</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> episodeJson <span class="op">=</span> JsonSerializer<span class="op">.</span><span class="fu">Serialize</span><span class="op">(</span>claim<span class="op">);</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> cachedJson <span class="op">=</span> JsonSerializer<span class="op">.</span><span class="fu">Serialize</span><span class="op">(</span>cachedData<span class="op">);</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> hr <span class="op">=</span> <span class="fu">PriceEpisodeWithTimings</span><span class="op">(</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>            episodeJson<span class="op">,</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>            cachedJson<span class="op">,</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>            <span class="kw">out</span> IntPtr resultPtr<span class="op">,</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>            <span class="kw">out</span> <span class="dt">uint</span> length<span class="op">,</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>            <span class="kw">out</span> NativeTimingsStruct nativeTimings<span class="op">);</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>hr <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">NativePricingException</span><span class="op">(</span>hr<span class="op">);</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> resultJson <span class="op">=</span> Marshal<span class="op">.</span><span class="fu">PtrToStringUni</span><span class="op">(</span>resultPtr<span class="op">,</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span>length<span class="op">);</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">FreePricingResult</span><span class="op">(</span>resultPtr<span class="op">);</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> result <span class="op">=</span> JsonSerializer<span class="op">.</span><span class="fu">Deserialize</span><span class="op">&lt;</span>PricingResult<span class="op">&gt;(</span>resultJson<span class="op">);</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> timings <span class="op">=</span> <span class="kw">new</span> NativeTimings</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>            EpisodeConversionMs <span class="op">=</span> nativeTimings<span class="op">.</span><span class="fu">EpisodeConversionMs</span><span class="op">,</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>            DrgGroupingMs <span class="op">=</span> nativeTimings<span class="op">.</span><span class="fu">DrgGroupingMs</span><span class="op">,</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>            ApcGroupingMs <span class="op">=</span> nativeTimings<span class="op">.</span><span class="fu">ApcGroupingMs</span><span class="op">,</span></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>            MedicarePricingMs <span class="op">=</span> nativeTimings<span class="op">.</span><span class="fu">MedicarePricingMs</span><span class="op">,</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>            MedicaidPricingMs <span class="op">=</span> nativeTimings<span class="op">.</span><span class="fu">MedicaidPricingMs</span><span class="op">,</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>            ResultSerializationMs <span class="op">=</span> nativeTimings<span class="op">.</span><span class="fu">ResultSerializationMs</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">(</span>result<span class="op">,</span> timings<span class="op">);</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="timing-output-in-result">Timing Output in Result</h3>
<div class="sourceCode" id="cb18"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;claimId&quot;</span><span class="fu">:</span> <span class="st">&quot;CLM-2025-001&quot;</span><span class="fu">,</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;success&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;drgCode&quot;</span><span class="fu">:</span> <span class="st">&quot;470&quot;</span><span class="fu">,</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;totalPayment&quot;</span><span class="fu">:</span> <span class="fl">12500.00</span><span class="fu">,</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;timings&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;totalMs&quot;</span><span class="fu">:</span> <span class="dv">23</span><span class="fu">,</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;deserializeMs&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;cacheLoadMs&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;nativeTotalMs&quot;</span><span class="fu">:</span> <span class="dv">18</span><span class="fu">,</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;serializeMs&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;overheadMs&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;nativePercent&quot;</span><span class="fu">:</span> <span class="fl">78.3</span><span class="fu">,</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;native&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;episodeConversionMs&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;drgGroupingMs&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;apcGroupingMs&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;medicarePricingMs&quot;</span><span class="fu">:</span> <span class="dv">10</span><span class="fu">,</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;medicaidPricingMs&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;tricarePricingMs&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;resultSerializationMs&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;dbLookupMs&quot;</span><span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 id="kql-queries-for-timing-analysis">KQL Queries for Timing
Analysis</h3>
<pre class="kusto"><code>// Average timing breakdown by payer program (last hour)
customMetrics
| where timestamp &gt; ago(1h)
| where name in (&quot;DeserializeMs&quot;, &quot;CacheLoadMs&quot;, &quot;NativeTotalMs&quot;, 
                 &quot;DrgGroupingMs&quot;, &quot;MedicarePricingMs&quot;, &quot;SerializeMs&quot;, &quot;TotalMs&quot;)
| summarize AvgMs = avg(value) by name, PayerProgram = tostring(customDimensions[&quot;payer_program&quot;])
| order by PayerProgram, name

// Timing percentiles for each stage
customMetrics
| where timestamp &gt; ago(24h)
| where name == &quot;TotalMs&quot;
| summarize 
    P50 = percentile(value, 50),
    P90 = percentile(value, 90),
    P95 = percentile(value, 95),
    P99 = percentile(value, 99)
    by bin(timestamp, 1h)
| render timechart

// Identify slow stages
customMetrics
| where timestamp &gt; ago(1h)
| where name in (&quot;DrgGroupingMs&quot;, &quot;MedicarePricingMs&quot;, &quot;CacheLoadMs&quot;)
| where value &gt; 50  // &gt; 50ms is slow
| summarize SlowCount = count() by name, ClaimId = tostring(customDimensions[&quot;claim_id&quot;])
| order by SlowCount desc

// Timing breakdown pie chart
customMetrics
| where timestamp &gt; ago(1h)
| where name in (&quot;DeserializeMs&quot;, &quot;CacheLoadMs&quot;, &quot;DrgGroupingMs&quot;, 
                 &quot;MedicarePricingMs&quot;, &quot;SerializeMs&quot;)
| summarize TotalTime = sum(value) by name
| render piechart</code></pre>
<h3 id="application-insights-dashboard-widget">Application Insights
Dashboard Widget</h3>
<div class="sourceCode" id="cb20"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;MetricsChart&quot;</span><span class="fu">,</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;Pricing Stage Timing Breakdown&quot;</span><span class="fu">,</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;metrics&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;DeserializeMs&quot;</span><span class="fu">,</span> <span class="dt">&quot;aggregation&quot;</span><span class="fu">:</span> <span class="st">&quot;avg&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;CacheLoadMs&quot;</span><span class="fu">,</span> <span class="dt">&quot;aggregation&quot;</span><span class="fu">:</span> <span class="st">&quot;avg&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;DrgGroupingMs&quot;</span><span class="fu">,</span> <span class="dt">&quot;aggregation&quot;</span><span class="fu">:</span> <span class="st">&quot;avg&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;MedicarePricingMs&quot;</span><span class="fu">,</span> <span class="dt">&quot;aggregation&quot;</span><span class="fu">:</span> <span class="st">&quot;avg&quot;</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;SerializeMs&quot;</span><span class="fu">,</span> <span class="dt">&quot;aggregation&quot;</span><span class="fu">:</span> <span class="st">&quot;avg&quot;</span> <span class="fu">}</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;visualization&quot;</span><span class="fu">:</span> <span class="st">&quot;StackedBar&quot;</span><span class="fu">,</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;groupBy&quot;</span><span class="fu">:</span> <span class="st">&quot;PayerProgram&quot;</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<hr />
<h2 id="observability-architecture">7. Observability Architecture</h2>
<h3 id="telemetry-flow">Telemetry Flow</h3>
<pre><code>┌─────────────────────────────────────────┐
│ PRICING CONTAINER                        │
│  ┌──────────────────────────────────┐   │
│  │ Worker                           │───┼──→ Structured Logs ───┐
│  │   ↑                              │   │                       │
│  │   │ Native Traces                │───┼──→ Metrics ───────────┼──→ Application
│  │   ↓                              │   │                       │    Insights
│  │ Native Bridge                    │───┼──→ Traces ────────────┤       │
│  │   ↑                              │   │                       │       ▼
│  │   │ Error Codes                  │   │                  Log Analytics
│  │   ↓                              │   │                       │
│  │ Pricing DLLs                     │   │                       ├──→ Alert Rules
│  └──────────────────────────────────┘   │                       │
└─────────────────────────────────────────┘                       └──→ Dashboards</code></pre>
<p><strong>Data Flow:</strong> DLL → Bridge → Worker → Application
Insights → Log Analytics → Alerts/Dashboards</p>
<h3 id="telemetry-components">Telemetry Components</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Data Type</th>
<th>Destination</th>
</tr>
</thead>
<tbody>
<tr>
<td>Structured Logs</td>
<td>JSON logs</td>
<td>Log Analytics</td>
</tr>
<tr>
<td>Custom Metrics</td>
<td>Prometheus format</td>
<td>Application Insights</td>
</tr>
<tr>
<td>Distributed Traces</td>
<td>OpenTelemetry</td>
<td>Application Insights</td>
</tr>
<tr>
<td>Health Checks</td>
<td>HTTP endpoints</td>
<td>Container Apps</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="structured-logging">7. Structured Logging</h2>
<h3 id="log-schema">Log Schema</h3>
<div class="sourceCode" id="cb22"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">// PricingLogEntry.cs</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> record PricingLogEntry</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Correlation</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">string</span> TraceId <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">string</span> SpanId <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">string</span> ClaimId <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">string</span> EpisodeId <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Timing</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> DateTime Timestamp <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> DurationMs <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Context</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">string</span> Operation <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">string</span> PayerProgram <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">string</span> StateCode <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">string</span> ProviderId <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Result</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">bool</span> Success <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">string</span> DrgCode <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">decimal</span><span class="op">?</span> TotalPayment <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Error (if any)</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">string</span> ErrorCode <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">string</span> ErrorMessage <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">string</span> NativeErrorCode <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Performance</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> GroupingMs <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> PricingMs <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">long</span> SerializationMs <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">bool</span> CacheHit <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> init<span class="op">;</span> <span class="op">}</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="logging-configuration">Logging Configuration</h3>
<div class="sourceCode" id="cb23"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Program.cs</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Logging</span><span class="op">.</span><span class="fu">AddApplicationInsights</span><span class="op">(</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=&gt;</span> config<span class="op">.</span><span class="fu">ConnectionString</span> <span class="op">=</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>        builder<span class="op">.</span><span class="fu">Configuration</span><span class="op">[</span><span class="st">&quot;ApplicationInsights:ConnectionString&quot;</span><span class="op">],</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    options <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        options<span class="op">.</span><span class="fu">IncludeScopes</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        options<span class="op">.</span><span class="fu">TrackExceptionsAsExceptionTelemetry</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddSingleton</span><span class="op">&lt;</span>IPricingLogger<span class="op">,</span> PricingLogger<span class="op">&gt;();</span></span></code></pre></div>
<h3 id="pricing-logger-implementation">Pricing Logger
Implementation</h3>
<div class="sourceCode" id="cb24"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">// PricingLogger.cs</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> PricingLogger <span class="op">:</span> IPricingLogger</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> ILogger<span class="op">&lt;</span>PricingLogger<span class="op">&gt;</span> _logger<span class="op">;</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> TelemetryClient _telemetry<span class="op">;</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> IDisposable <span class="fu">BeginPricingScope</span><span class="op">(</span>ClaimInput claim<span class="op">)</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> _logger<span class="op">.</span><span class="fu">BeginScope</span><span class="op">(</span><span class="kw">new</span> Dictionary<span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">object</span><span class="op">&gt;</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span><span class="st">&quot;ClaimId&quot;</span><span class="op">]</span> <span class="op">=</span> claim<span class="op">.</span><span class="fu">ClaimId</span><span class="op">,</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span><span class="st">&quot;EpisodeId&quot;</span><span class="op">]</span> <span class="op">=</span> claim<span class="op">.</span><span class="fu">EpisodeId</span><span class="op">,</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span><span class="st">&quot;PayerProgram&quot;</span><span class="op">]</span> <span class="op">=</span> claim<span class="op">.</span><span class="fu">PayerProgram</span><span class="op">,</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span><span class="st">&quot;StateCode&quot;</span><span class="op">]</span> <span class="op">=</span> claim<span class="op">.</span><span class="fu">StateCode</span><span class="op">,</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span><span class="st">&quot;ProviderId&quot;</span><span class="op">]</span> <span class="op">=</span> claim<span class="op">.</span><span class="fu">ProviderId</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">LogPricingStarted</span><span class="op">(</span>ClaimInput claim<span class="op">)</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>        _logger<span class="op">.</span><span class="fu">LogInformation</span><span class="op">(</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Pricing started: ClaimId={ClaimId}, Program={PayerProgram}, State={StateCode}&quot;</span><span class="op">,</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>            claim<span class="op">.</span><span class="fu">ClaimId</span><span class="op">,</span> claim<span class="op">.</span><span class="fu">PayerProgram</span><span class="op">,</span> claim<span class="op">.</span><span class="fu">StateCode</span><span class="op">);</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>        _telemetry<span class="op">.</span><span class="fu">TrackEvent</span><span class="op">(</span><span class="st">&quot;PricingStarted&quot;</span><span class="op">,</span> <span class="kw">new</span> Dictionary<span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">string</span><span class="op">&gt;</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span><span class="st">&quot;ClaimId&quot;</span><span class="op">]</span> <span class="op">=</span> claim<span class="op">.</span><span class="fu">ClaimId</span><span class="op">,</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span><span class="st">&quot;PayerProgram&quot;</span><span class="op">]</span> <span class="op">=</span> claim<span class="op">.</span><span class="fu">PayerProgram</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">LogPricingCompleted</span><span class="op">(</span>ClaimInput claim<span class="op">,</span> PricingResult result<span class="op">,</span> TimeSpan duration<span class="op">)</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> entry <span class="op">=</span> <span class="kw">new</span> PricingLogEntry</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>            TraceId <span class="op">=</span> Activity<span class="op">.</span><span class="fu">Current</span><span class="op">?.</span><span class="fu">TraceId</span><span class="op">.</span><span class="fu">ToString</span><span class="op">(),</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>            ClaimId <span class="op">=</span> claim<span class="op">.</span><span class="fu">ClaimId</span><span class="op">,</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>            EpisodeId <span class="op">=</span> claim<span class="op">.</span><span class="fu">EpisodeId</span><span class="op">,</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>            PayerProgram <span class="op">=</span> claim<span class="op">.</span><span class="fu">PayerProgram</span><span class="op">,</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>            DurationMs <span class="op">=</span> <span class="op">(</span><span class="dt">long</span><span class="op">)</span>duration<span class="op">.</span><span class="fu">TotalMilliseconds</span><span class="op">,</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>            Success <span class="op">=</span> result<span class="op">.</span><span class="fu">Success</span><span class="op">,</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>            DrgCode <span class="op">=</span> result<span class="op">.</span><span class="fu">DrgCode</span><span class="op">,</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>            TotalPayment <span class="op">=</span> result<span class="op">.</span><span class="fu">TotalPayment</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>        _logger<span class="op">.</span><span class="fu">LogInformation</span><span class="op">(</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Pricing completed: ClaimId={ClaimId}, DRG={DrgCode}, Payment={Payment}, Duration={Duration}ms&quot;</span><span class="op">,</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>            entry<span class="op">.</span><span class="fu">ClaimId</span><span class="op">,</span> entry<span class="op">.</span><span class="fu">DrgCode</span><span class="op">,</span> entry<span class="op">.</span><span class="fu">TotalPayment</span><span class="op">,</span> entry<span class="op">.</span><span class="fu">DurationMs</span><span class="op">);</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Custom metric</span></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>        _telemetry<span class="op">.</span><span class="fu">TrackMetric</span><span class="op">(</span><span class="st">&quot;PricingDurationMs&quot;</span><span class="op">,</span> entry<span class="op">.</span><span class="fu">DurationMs</span><span class="op">,</span> <span class="kw">new</span> Dictionary<span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">string</span><span class="op">&gt;</span></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span><span class="st">&quot;PayerProgram&quot;</span><span class="op">]</span> <span class="op">=</span> entry<span class="op">.</span><span class="fu">PayerProgram</span><span class="op">,</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span><span class="st">&quot;Success&quot;</span><span class="op">]</span> <span class="op">=</span> entry<span class="op">.</span><span class="fu">Success</span><span class="op">.</span><span class="fu">ToString</span><span class="op">()</span></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">LogNativeError</span><span class="op">(</span><span class="dt">string</span> claimId<span class="op">,</span> <span class="dt">int</span> hresult<span class="op">,</span> <span class="dt">string</span> message<span class="op">)</span></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>        _logger<span class="op">.</span><span class="fu">LogError</span><span class="op">(</span></span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Native pricing error: ClaimId={ClaimId}, HRESULT={HResult:X8}, Message={Message}&quot;</span><span class="op">,</span></span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>            claimId<span class="op">,</span> hresult<span class="op">,</span> message<span class="op">);</span></span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>        _telemetry<span class="op">.</span><span class="fu">TrackException</span><span class="op">(</span><span class="kw">new</span> <span class="fu">NativePricingException</span><span class="op">(</span>hresult<span class="op">,</span> message<span class="op">));</span></span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="native-bridge-logging">Native Bridge Logging</h3>
<div class="sourceCode" id="cb25"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">// CboPricingBridge.cpp - Native logging through callback</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> <span class="op">(</span>__stdcall <span class="op">*</span>LogCallback<span class="op">)(</span><span class="dt">int</span> level<span class="op">,</span> <span class="at">const</span> <span class="dt">wchar_t</span><span class="op">*</span> message<span class="op">);</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> LogCallback <span class="va">g_LogCallback</span> <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="at">extern</span> <span class="st">&quot;C&quot;</span> <span class="ex">__declspec(dllexport)</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> SetLogCallback<span class="op">(</span>LogCallback callback<span class="op">)</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">g_LogCallback</span> <span class="op">=</span> callback<span class="op">;</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> NativeLog<span class="op">(</span><span class="dt">int</span> level<span class="op">,</span> <span class="at">const</span> <span class="dt">wchar_t</span><span class="op">*</span> format<span class="op">,</span> <span class="op">...)</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="va">g_LogCallback</span> <span class="op">==</span> <span class="kw">nullptr</span><span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">wchar_t</span> buffer<span class="op">[</span><span class="dv">2048</span><span class="op">];</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">va_list</span> args<span class="op">;</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    va_start<span class="op">(</span>args<span class="op">,</span> format<span class="op">);</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    vswprintf_s<span class="op">(</span>buffer<span class="op">,</span> <span class="dv">2048</span><span class="op">,</span> format<span class="op">,</span> args<span class="op">);</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    va_end<span class="op">(</span>args<span class="op">);</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    <span class="va">g_LogCallback</span><span class="op">(</span>level<span class="op">,</span> buffer<span class="op">);</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage in pricing code</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>HRESULT PriceEpisodeFromJson<span class="op">(</span>LPCWSTR episodeJson<span class="op">,</span> <span class="op">...)</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    NativeLog<span class="op">(</span>LOG_INFO<span class="op">,</span> <span class="st">L&quot;Starting episode pricing: </span><span class="sc">%d</span><span class="st"> bytes&quot;</span><span class="op">,</span> wcslen<span class="op">(</span>episodeJson<span class="op">));</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ... pricing logic ...</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>FAILED<span class="op">(</span>hr<span class="op">))</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>        NativeLog<span class="op">(</span>LOG_ERROR<span class="op">,</span> <span class="st">L&quot;Pricing failed: HRESULT=0x</span><span class="sc">%08X</span><span class="st">&quot;</span><span class="op">,</span> hr<span class="op">);</span></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> hr<span class="op">;</span></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>    NativeLog<span class="op">(</span>LOG_INFO<span class="op">,</span> <span class="st">L&quot;Pricing completed: DRG=</span><span class="sc">%s</span><span class="st">, Payment=</span><span class="sc">%.2f</span><span class="st">&quot;</span><span class="op">,</span> drgCode<span class="op">,</span> payment<span class="op">);</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> S_OK<span class="op">;</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="net-callback-handler">.NET Callback Handler</h3>
<div class="sourceCode" id="cb26"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">// NativeLogHandler.cs</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> NativeLogHandler</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> ILogger _logger<span class="op">;</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>UnmanagedCallersOnly<span class="op">]</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="dt">void</span> <span class="fu">LogCallback</span><span class="op">(</span><span class="dt">int</span> level<span class="op">,</span> IntPtr messagePtr<span class="op">)</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> message <span class="op">=</span> Marshal<span class="op">.</span><span class="fu">PtrToStringUni</span><span class="op">(</span>messagePtr<span class="op">);</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> logLevel <span class="op">=</span> level <span class="kw">switch</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>            <span class="dv">0</span> <span class="op">=&gt;</span> LogLevel<span class="op">.</span><span class="fu">Debug</span><span class="op">,</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>            <span class="dv">1</span> <span class="op">=&gt;</span> LogLevel<span class="op">.</span><span class="fu">Information</span><span class="op">,</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>            <span class="dv">2</span> <span class="op">=&gt;</span> LogLevel<span class="op">.</span><span class="fu">Warning</span><span class="op">,</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>            <span class="dv">3</span> <span class="op">=&gt;</span> LogLevel<span class="op">.</span><span class="fu">Error</span><span class="op">,</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>            _ <span class="op">=&gt;</span> LogLevel<span class="op">.</span><span class="fu">Information</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>        _instance<span class="op">.</span><span class="fu">_logger</span><span class="op">.</span><span class="fu">Log</span><span class="op">(</span>logLevel<span class="op">,</span> <span class="st">&quot;[Native] {Message}&quot;</span><span class="op">,</span> message<span class="op">);</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="application-insights-configuration">8. Application Insights
Configuration</h2>
<h3 id="custom-metrics">Custom Metrics</h3>
<div class="sourceCode" id="cb27"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">// CustomMetrics.cs</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> PricingMetrics</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> TelemetryClient _telemetry<span class="op">;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">RecordClaimPriced</span><span class="op">(</span><span class="dt">string</span> program<span class="op">,</span> <span class="dt">bool</span> success<span class="op">,</span> <span class="dt">double</span> durationMs<span class="op">)</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>        _telemetry<span class="op">.</span><span class="fu">TrackMetric</span><span class="op">(</span><span class="st">&quot;ClaimsPriced&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">new</span> Dictionary<span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">string</span><span class="op">&gt;</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span><span class="st">&quot;PayerProgram&quot;</span><span class="op">]</span> <span class="op">=</span> program<span class="op">,</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span><span class="st">&quot;Success&quot;</span><span class="op">]</span> <span class="op">=</span> success<span class="op">.</span><span class="fu">ToString</span><span class="op">()</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>        _telemetry<span class="op">.</span><span class="fu">TrackMetric</span><span class="op">(</span><span class="st">&quot;PricingLatencyMs&quot;</span><span class="op">,</span> durationMs<span class="op">,</span> <span class="kw">new</span> Dictionary<span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">string</span><span class="op">&gt;</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span><span class="st">&quot;PayerProgram&quot;</span><span class="op">]</span> <span class="op">=</span> program</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">RecordCacheHit</span><span class="op">(</span><span class="dt">string</span> cacheType<span class="op">,</span> <span class="dt">bool</span> hit<span class="op">)</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>        _telemetry<span class="op">.</span><span class="fu">TrackMetric</span><span class="op">(</span><span class="st">&quot;CacheAccess&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">new</span> Dictionary<span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">string</span><span class="op">&gt;</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span><span class="st">&quot;CacheType&quot;</span><span class="op">]</span> <span class="op">=</span> cacheType<span class="op">,</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span><span class="st">&quot;Hit&quot;</span><span class="op">]</span> <span class="op">=</span> hit<span class="op">.</span><span class="fu">ToString</span><span class="op">()</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">RecordNativeError</span><span class="op">(</span><span class="dt">string</span> errorType<span class="op">)</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>        _telemetry<span class="op">.</span><span class="fu">TrackMetric</span><span class="op">(</span><span class="st">&quot;NativeErrors&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">new</span> Dictionary<span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">string</span><span class="op">&gt;</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span><span class="st">&quot;ErrorType&quot;</span><span class="op">]</span> <span class="op">=</span> errorType</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="terraform-configuration">Terraform Configuration</h3>
<pre class="hcl"><code># Application Insights
resource &quot;azurerm_application_insights&quot; &quot;repricing&quot; {
  name                = &quot;ai-pem-repricing-${var.environment}&quot;
  location            = azurerm_resource_group.pem.location
  resource_group_name = azurerm_resource_group.pem.name
  workspace_id        = azurerm_log_analytics_workspace.pem.id
  application_type    = &quot;web&quot;
  
  tags = local.common_tags
}

# Log Analytics Workspace
resource &quot;azurerm_log_analytics_workspace&quot; &quot;pem&quot; {
  name                = &quot;la-pem-${var.environment}&quot;
  location            = azurerm_resource_group.pem.location
  resource_group_name = azurerm_resource_group.pem.name
  sku                 = &quot;PerGB2018&quot;
  retention_in_days   = var.environment == &quot;prod&quot; ? 90 : 30
  
  tags = local.common_tags
}</code></pre>
<hr />
<h2 id="kql-queries-for-log-analytics">9. KQL Queries for Log
Analytics</h2>
<h3 id="claims-processing-dashboard">Claims Processing Dashboard</h3>
<pre class="kusto"><code>// Claims processed per minute (last hour)
customMetrics
| where name == &quot;ClaimsPriced&quot;
| where timestamp &gt; ago(1h)
| summarize ClaimsPerMinute = sum(value) by bin(timestamp, 1m), 
    PayerProgram = tostring(customDimensions[&quot;PayerProgram&quot;])
| render timechart</code></pre>
<h3 id="latency-percentiles">Latency Percentiles</h3>
<pre class="kusto"><code>// Pricing latency percentiles (last 24 hours)
customMetrics
| where name == &quot;PricingLatencyMs&quot;
| where timestamp &gt; ago(24h)
| summarize 
    P50 = percentile(value, 50),
    P95 = percentile(value, 95),
    P99 = percentile(value, 99)
    by bin(timestamp, 5m), PayerProgram = tostring(customDimensions[&quot;PayerProgram&quot;])
| render timechart</code></pre>
<h3 id="error-analysis">Error Analysis</h3>
<pre class="kusto"><code>// Errors by type (last 24 hours)
exceptions
| where timestamp &gt; ago(24h)
| where cloud_RoleName == &quot;pricing-worker&quot;
| summarize Count = count() by type, outerMessage
| order by Count desc
| take 20</code></pre>
<h3 id="cache-hit-ratio">Cache Hit Ratio</h3>
<pre class="kusto"><code>// Cache hit ratio by type
customMetrics
| where name == &quot;CacheAccess&quot;
| where timestamp &gt; ago(1h)
| summarize 
    Hits = countif(tostring(customDimensions[&quot;Hit&quot;]) == &quot;True&quot;),
    Total = count()
    by CacheType = tostring(customDimensions[&quot;CacheType&quot;])
| extend HitRatio = round(100.0 * Hits / Total, 2)</code></pre>
<h3 id="native-error-tracking">Native Error Tracking</h3>
<pre class="kusto"><code>// Native pricing errors
traces
| where message contains &quot;[Native]&quot; and severityLevel &gt;= 3
| where timestamp &gt; ago(1h)
| project timestamp, message, customDimensions
| order by timestamp desc</code></pre>
<hr />
<h2 id="alert-rules">10. Alert Rules</h2>
<h3 id="critical-alerts">Critical Alerts</h3>
<pre class="hcl"><code># High error rate alert
resource &quot;azurerm_monitor_metric_alert&quot; &quot;high_error_rate&quot; {
  name                = &quot;alert-repricing-high-error-rate&quot;
  resource_group_name = azurerm_resource_group.pem.name
  scopes              = [azurerm_application_insights.repricing.id]
  description         = &quot;Repricing error rate exceeds 1%&quot;
  severity            = 0  # Critical
  
  criteria {
    metric_namespace = &quot;azure.applicationinsights&quot;
    metric_name      = &quot;requests/failed&quot;
    aggregation      = &quot;Average&quot;
    operator         = &quot;GreaterThan&quot;
    threshold        = 1
  }
  
  action {
    action_group_id = azurerm_monitor_action_group.critical.id
  }
}

# High latency alert
resource &quot;azurerm_monitor_metric_alert&quot; &quot;high_latency&quot; {
  name                = &quot;alert-repricing-high-latency&quot;
  resource_group_name = azurerm_resource_group.pem.name
  scopes              = [azurerm_application_insights.repricing.id]
  description         = &quot;P95 latency exceeds 200ms&quot;
  severity            = 1  # Error
  
  criteria {
    metric_namespace = &quot;azure.applicationinsights&quot;
    metric_name      = &quot;requests/duration&quot;
    aggregation      = &quot;Average&quot;
    operator         = &quot;GreaterThan&quot;
    threshold        = 200
  }
  
  action {
    action_group_id = azurerm_monitor_action_group.ops.id
  }
}

# Container health alert
resource &quot;azurerm_monitor_metric_alert&quot; &quot;container_unhealthy&quot; {
  name                = &quot;alert-repricing-container-unhealthy&quot;
  resource_group_name = azurerm_resource_group.pem.name
  scopes              = [azurerm_container_app.pricing_worker.id]
  description         = &quot;Pricing container is unhealthy&quot;
  severity            = 0  # Critical
  
  criteria {
    metric_namespace = &quot;microsoft.app/containerapps&quot;
    metric_name      = &quot;Replicas&quot;
    aggregation      = &quot;Average&quot;
    operator         = &quot;LessThan&quot;
    threshold        = 1
  }
  
  action {
    action_group_id = azurerm_monitor_action_group.critical.id
  }
}</code></pre>
<h3 id="warning-alerts">Warning Alerts</h3>
<table>
<thead>
<tr>
<th>Alert</th>
<th>Condition</th>
<th>Severity</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cache hit rate low</td>
<td>&lt; 80%</td>
<td>Warning</td>
<td>Investigate cache</td>
</tr>
<tr>
<td>Queue depth high</td>
<td>&gt; 10,000</td>
<td>Warning</td>
<td>Scale up</td>
</tr>
<tr>
<td>Memory usage high</td>
<td>&gt; 80%</td>
<td>Warning</td>
<td>Monitor scaling</td>
</tr>
<tr>
<td>Parity test failures</td>
<td>&gt; 0.1%</td>
<td>Warning</td>
<td>Review failures</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="dashboards">11. Dashboards</h2>
<h3 id="azure-dashboard-json">Azure Dashboard JSON</h3>
<div class="sourceCode" id="cb35"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;properties&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;lenses&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">{</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;parts&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>          <span class="fu">{</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;MetricsChart&quot;</span><span class="fu">,</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;Claims Processed per Minute&quot;</span><span class="fu">,</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;query&quot;</span><span class="fu">:</span> <span class="st">&quot;customMetrics | where name == &#39;ClaimsPriced&#39; | summarize sum(value) by bin(timestamp, 1m)&quot;</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>          <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>          <span class="fu">{</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;MetricsChart&quot;</span><span class="fu">,</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;Latency Percentiles&quot;</span><span class="fu">,</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;query&quot;</span><span class="fu">:</span> <span class="st">&quot;customMetrics | where name == &#39;PricingLatencyMs&#39; | summarize percentiles(value, 50, 95, 99) by bin(timestamp, 5m)&quot;</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>          <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>          <span class="fu">{</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;Table&quot;</span><span class="fu">,</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;Errors (Last Hour)&quot;</span><span class="fu">,</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;query&quot;</span><span class="fu">:</span> <span class="st">&quot;exceptions | where timestamp &gt; ago(1h) | summarize count() by type&quot;</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>          <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>          <span class="fu">{</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;PieChart&quot;</span><span class="fu">,</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;Claims by Payer Program&quot;</span><span class="fu">,</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;query&quot;</span><span class="fu">:</span> <span class="st">&quot;customMetrics | where name == &#39;ClaimsPriced&#39; | summarize count() by tostring(customDimensions[&#39;PayerProgram&#39;])&quot;</span></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>          <span class="fu">}</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>        <span class="ot">]</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<hr />
<h2 id="summary">12. Summary</h2>
<h3 id="testing-coverage">Testing Coverage</h3>
<table>
<thead>
<tr>
<th>Test Type</th>
<th>Documents Created</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Unit Tests</td>
<td>✅ Examples above</td>
<td>Ready</td>
</tr>
<tr>
<td>Integration Tests</td>
<td>✅ Examples above</td>
<td>Ready</td>
</tr>
<tr>
<td>Parity Tests</td>
<td>✅ Framework + pipeline</td>
<td><strong>Critical</strong></td>
</tr>
<tr>
<td>Performance Tests</td>
<td>✅ k6 + BenchmarkDotNet</td>
<td>Ready</td>
</tr>
</tbody>
</table>
<h3 id="observability-coverage">Observability Coverage</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Implementation</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Structured Logging</td>
<td>✅ Full schema</td>
<td>Ready</td>
</tr>
<tr>
<td>Native Bridge Logging</td>
<td>✅ Callback pattern</td>
<td>Ready</td>
</tr>
<tr>
<td>Application Insights</td>
<td>✅ Terraform + config</td>
<td>Ready</td>
</tr>
<tr>
<td>Log Analytics</td>
<td>✅ KQL queries</td>
<td>Ready</td>
</tr>
<tr>
<td>Alerts</td>
<td>✅ Critical + Warning</td>
<td>Ready</td>
</tr>
<tr>
<td>Dashboards</td>
<td>✅ JSON template</td>
<td>Ready</td>
</tr>
</tbody>
</table>
<h3 id="phase-1-effort-estimate">Phase 1 Effort Estimate</h3>
<table>
<thead>
<tr>
<th>Item</th>
<th>Effort</th>
</tr>
</thead>
<tbody>
<tr>
<td>Unit Tests</td>
<td>3-5 days</td>
</tr>
<tr>
<td>Integration Tests</td>
<td>3-5 days</td>
</tr>
<tr>
<td>Parity Test Framework</td>
<td>5-7 days</td>
</tr>
<tr>
<td>Golden Dataset Prep</td>
<td>3-5 days</td>
</tr>
<tr>
<td>Observability Setup</td>
<td>2-3 days</td>
</tr>
<tr>
<td>Alert Configuration</td>
<td>1-2 days</td>
</tr>
<tr>
<td><strong>Total</strong></td>
<td><strong>17-27 days</strong></td>
</tr>
</tbody>
</table>
<hr />
<p><strong>Document Version History:</strong></p>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 18%" />
<col style="width: 25%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Version</th>
<th>Date</th>
<th>Author</th>
<th>Changes</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.0</td>
<td>2026-01-16</td>
<td>Andy Bratton</td>
<td>Initial testing and observability strategy</td>
</tr>
</tbody>
</table>
</body>
</html>
