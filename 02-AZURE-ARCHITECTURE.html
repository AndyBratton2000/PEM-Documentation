<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>02-AZURE-ARCHITECTURE</title>
  <style>
    /* Default styles provided by pandoc.
    ** See https://pandoc.org/MANUAL.html#variables-for-html for config info.
    */
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
    <style>
    /* ========== FinThrive Theme Styles (Embedded) ========== */
/* Load Google Font */
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');

body {
  font-family: 'Plus Jakarta Sans', sans-serif;
}
/* Typography Variables */
:root {
  /* Font Families */
  --font--headlines: 'Plus Jakarta Sans', sans-serif;
  --font--body-text: 'Plus Jakarta Sans', sans-serif;
  --font--accent: 'Plus Jakarta Sans', sans-serif;
  
  /* Font Weights */
  --weight--headlines: 500;
  --weight--body: normal;
  
  /* Display Sizes (Responsive) */
  --d-l: clamp(3.375rem, 4.464vi + 1.232rem, 5.250rem);
  --d-m: clamp(2.625rem, 5.060vi + 0.196rem, 4.750rem);
  --d-s: clamp(2.375rem, 2.381vi + 1.232rem, 3.375rem);
  --d-xs: clamp(2.375rem, 2.381vi + 1.232rem, 3.375rem);
  
  /* Heading Sizes (Responsive) */
  --h-xxl: clamp(2.375rem, 2.381vi + 1.232rem, 3.375rem);
  --h-xl: clamp(2.25rem, 0.893vi + 1.821rem, 2.625rem);
  --h-l: clamp(1.5rem, 1.786vi + 0.643rem, 2.250rem);
  --h-m: clamp(1.5rem, 0.595vi + 1.214rem, 1.750rem);
  --h-s: 1.3125rem;
  --h-xs: 1.125rem;
  
  /* Body Text Sizes */
  --b-l: clamp(1.25rem, 0.298vi + 1.107rem, 1.375rem);
  --b-m: 1.125rem;
  --b-s: 1.0rem;
  --b-xs: 0.875rem;
  
  /* Spacing Scale (Responsive) */
  --s-12: clamp(4.0rem, 20.238vi + -5.714rem, 12.500rem);
  --s-11: clamp(3.0rem, 16.667vi + -5.000rem, 10.000rem);
  --s-10: clamp(3.0rem, 11.905vi + -2.714rem, 8.000rem);
  --s-9: clamp(2.375rem, 8.631vi + -1.768rem, 6.000rem);
  --s-8: clamp(2.375rem, 3.869vi + 0.518rem, 4.000rem);
  --s-7: clamp(2.0rem, 2.381vi + 0.857rem, 3.000rem);
  --s-6: clamp(2.0rem, 0.595vi + 1.714rem, 2.250rem);
  --s-5: clamp(1.125rem, 0.893vi + 0.696rem, 1.500rem);
  --s-4: 1.125rem;
  --s-3: 0.75rem;
  --s-2: 0.5rem;
  --s-1: 0.25rem;
  --s-0: 0.0rem;
}

/* Light Mode Color Theme (Default) */
:root,
.light-mode {
  /* Primary Colors */
  --primary: #00E091;
  --primary--medium: #80F2C3;
  --primary--light: #C0F9E1;
  --primary--extra-light: #EBFBF7;
  --primary--dark: #005654;
  
  /* Secondary Colors */
  --secondary: #FF9B5C;
  --secondary--medium: #F87A3A;
  --secondary--light: #FFCA98;
  --secondary--extra-light: #fff2e5;
  --secondary--dark: #663E25;
  
  /* Tertiary Colors */
  --tertiary: #3E69FA;
  --tertiary--medium: #3356CC;
  --tertiary--light: #CAD6FF;
  --tertiary--dark: #13204D;
  
  /* Accent Color */
  --accent: #9efb21;
  
  /* Neutral Colors */
  --neutral--black: #005654;
  --neutral--dark: #005654;
  --neutral--medium-dark: #545757;
  --neutral--medium: #A8ABAB;
  --neutral--medium-light: #D4D6D6;
  --neutral--light: #F5F5F5;
  --neutral--white: #FFFFFF;
  
  /* Neutral Color Transparency Variants */
  --neutral--dark-80: rgba(0, 86, 84, 0.8);
  --neutral--dark-60: rgba(0, 86, 84, 0.6);
  --neutral--dark-40: rgba(0, 86, 84, 0.4);
  --neutral--dark-20: rgba(0, 86, 84, 0.2);
  --neutral--dark-10: rgba(0, 86, 84, 0.1);
  --neutral--white-80: rgba(255, 255, 255, 0.8);
  --neutral--white-60: rgba(255, 255, 255, 0.6);
  --neutral--white-40: rgba(255, 255, 255, 0.4);
  --neutral--white-20: rgba(255, 255, 255, 0.2);
  --neutral--white-10: rgba(255, 255, 255, 0.1);
  
  /* Card Styles */
  --card-border: var(--neutral--medium-light);
  --card-background-light: var(--neutral--white);
  --card-background-dark: var(--neutral--dark);
  --card-border-hover: var(--neutral--medium-dark);
  
  /* Input Styles */
  --input--border: var(--neutral--medium);
  --input--border-focused: var(--inline-links);
  --input--border-active: var(--neutral--medium-dark);
  --input--border-disabled: var(--neutral--medium-light);
  
  /* Text Colors */
  --headlines: #005654;
  --text: #005654;
  --text--80: rgba(0, 86, 84, 0.8);
  --text--60: rgba(0, 86, 84, 0.6);
  --text-input: #005654;
  
  /* UI Elements */
  --hr: var(--neutral--medium-light);
  
  /* Link Colors */
  --inline-links: #3254c8;
  --inline-links--hover: #7393FF;
  --inline-links--visited: #8C3EFA;
  --menu-links: #005654;
  --menu-links--hover: #00E091;
  --menu-links--active: #005654;
  
  /* Primary Button */
  --btn--primary-fg: var(--neutral--white);
  --btn--primary-fg-hover: var(--neutral--white);
  --btn--primary-bg: var(--primary);
  --btn--primary-bg-hover: var(--primary--medium);
  --btn--primary-stroke: var(--primary--dark);
  
  /* Secondary Button */
  --btn--secondary-fg: var(--neutral--white);
  --btn--secondary-fg-hover: var(--neutral--white);
  --btn--secondary-bg: var(--secondary);
  --btn--secondary-bg-hover: var(--secondary--medium);
  --btn--secondary-stroke: var(--neutral-dark);
  
  /* Tertiary Button */
  --btn--tertiary-fg: var(--neutral--white);
  --btn--tertiary-fg-hover: var(--neutral--white);
  --btn--tertiary-bg: var(--tertiary);
  --btn--tertiary-bg-hover: var(--tertiary--medium);
  --btn--tertiary-stroke: var(--neutral-dark);
  
  /* White Button */
  --btn--white-fg: var(--primary);
  --btn--white-fg-hover: var(--neutral--white);
  --btn--white-bg: var(--neutral--white);
  --btn--white-bg-hover: var(--primary);
  --btn--white-stroke: var(--neutral--white);
  
  color: var(--text);
}

/* Dark Mode Color Theme */
.dark-mode {
  /* Text Colors */
  --headlines: #FFFFFF;
  --text: #FFFFFF;
  --text-input: #FFFFFF;
  
  /* UI Elements */
  --hr: var(--neutral--medium-dark);
  
  /* Link Colors */
  --inline-links: #FFFFFF;
  --inline-links--hover: #70BAFE;
  --inline-links--visited: #FFFFFF;
  --menu-links: #FFFFFF;
  --menu-links--hover: #C0F9E1;
  --menu-links--active: #FFFFFF;
  
  /* Card Styles */
  --card-border: var(--neutral--white);
  --card-background-light: var(--neutral--light);
  --card-border-hover: var(--neutral--white);
  
  /* Button Strokes */
  --btn--primary-stroke: var(--neutral--white);
  --btn--secondary-stroke: var(--neutral--white);
  --btn--tertiary-stroke: var(--neutral--white);
  
  color: var(--text);
}

/* ========== Table Styles ========== */

table {
  width: 100%;
  border-collapse: collapse;
  margin: var(--s-5) 0;
  font-size: var(--b-s);
  font-family: var(--font--body-text);
  background-color: var(--neutral--white);
  border: 1px solid var(--neutral--medium-light);
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0, 86, 84, 0.08);
}

/* Table Header */
thead {
  background-color: var(--primary--extra-light);
}

thead tr {
  border-bottom: 2px solid var(--primary--medium);
}

th {
  padding: var(--s-3) var(--s-4);
  text-align: left;
  font-weight: var(--weight--headlines);
  color: var(--primary--dark);
  font-size: var(--b-s);
  letter-spacing: 0.02em;
  white-space: nowrap;
}

/* Table Body */
tbody tr {
  border-bottom: 1px solid var(--neutral--medium-light);
  transition: background-color 0.15s ease;
}

tbody tr:last-child {
  border-bottom: none;
}

/* Zebra Striping */
tbody tr:nth-child(even) {
  background-color: var(--neutral--light);
}

tbody tr:nth-child(odd) {
  background-color: var(--neutral--white);
}

/* Row Hover Effect */
tbody tr:hover {
  background-color: var(--primary--extra-light);
}

/* Table Cells */
td {
  padding: var(--s-3) var(--s-4);
  color: var(--text);
  vertical-align: top;
  line-height: 1.5;
}

/* Code in Table Cells */
td code,
th code {
  background-color: var(--neutral--light);
  padding: 0.15em 0.4em;
  border-radius: 4px;
  font-size: 0.9em;
  color: var(--tertiary--dark);
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
}

/* Bold text in first column */
td:first-child strong,
td strong {
  color: var(--primary--dark);
  font-weight: 600;
}

/* Column Groups - ensure proper column widths */
colgroup col {
  min-width: 80px;
}

/* Responsive Table Wrapper */
@media screen and (max-width: 768px) {
  table {
    display: block;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  th, td {
    min-width: 120px;
    padding: var(--s-2) var(--s-3);
    font-size: var(--b-xs);
  }
}

/* Dark Mode Table Styles */
.dark-mode table {
  background-color: var(--neutral--dark);
  border-color: var(--neutral--medium-dark);
}

.dark-mode thead {
  background-color: rgba(0, 224, 145, 0.15);
}

.dark-mode thead tr {
  border-bottom-color: var(--primary--medium);
}

.dark-mode th {
  color: var(--primary--medium);
}

.dark-mode tbody tr:nth-child(even) {
  background-color: rgba(255, 255, 255, 0.05);
}

.dark-mode tbody tr:nth-child(odd) {
  background-color: transparent;
}

.dark-mode tbody tr:hover {
  background-color: rgba(0, 224, 145, 0.1);
}

.dark-mode tbody tr {
  border-bottom-color: var(--neutral--medium-dark);
}

.dark-mode td {
  color: var(--text);
}

.dark-mode td code,
.dark-mode th code {
  background-color: rgba(255, 255, 255, 0.1);
  color: var(--primary--light);
}

/* ========== Additional Layout Styles ========== */

/* Body max-width and padding for readability */
body {
  max-width: 1200px;
  margin: 0 auto;
  padding: var(--s-6) var(--s-5);
  line-height: 1.6;
  background-color: var(--neutral--white);
}

/* Headings */
h1, h2, h3, h4, h5, h6 {
  font-family: var(--font--headlines);
  font-weight: var(--weight--headlines);
  color: var(--headlines);
  margin-top: var(--s-6);
  margin-bottom: var(--s-4);
  line-height: 1.3;
}

h1 {
  font-size: var(--h-xxl);
  color: var(--primary--dark);
  border-bottom: 3px solid var(--primary);
  padding-bottom: var(--s-3);
  margin-bottom: var(--s-5);
}

h2 {
  font-size: var(--h-xl);
  color: var(--primary--dark);
  border-bottom: 2px solid var(--primary--medium);
  padding-bottom: var(--s-2);
}

h3 {
  font-size: var(--h-l);
  color: var(--primary--dark);
}

h4 {
  font-size: var(--h-m);
}

h5 {
  font-size: var(--h-s);
}

h6 {
  font-size: var(--h-xs);
}

/* Horizontal Rules */
hr {
  border: none;
  border-top: 2px solid var(--hr);
  margin: var(--s-6) 0;
}

/* Paragraphs */
p {
  margin-bottom: var(--s-4);
  font-size: var(--b-m);
}

/* Links */
a {
  color: var(--inline-links);
  text-decoration: none;
  transition: color 0.15s ease;
}

a:hover {
  color: var(--inline-links--hover);
  text-decoration: underline;
}

a:visited {
  color: var(--inline-links--visited);
}

/* Blockquotes */
blockquote {
  border-left: 4px solid var(--primary);
  background-color: var(--primary--extra-light);
  padding: var(--s-4) var(--s-5);
  margin: var(--s-5) 0;
  border-radius: 0 8px 8px 0;
}

blockquote p {
  margin-bottom: 0;
}

/* Lists */
ul, ol {
  margin-bottom: var(--s-4);
  padding-left: var(--s-5);
}

li {
  margin-bottom: var(--s-2);
  line-height: 1.6;
}

/* Nested lists */
ul ul, ol ol, ul ol, ol ul {
  margin-top: var(--s-2);
  margin-bottom: 0;
}

/* Task Lists */
ul.task-list {
  list-style: none;
  padding-left: 0;
}

ul.task-list li {
  padding-left: var(--s-1);
}

/* Inline code */
code {
  background-color: var(--neutral--light);
  padding: 0.15em 0.4em;
  border-radius: 4px;
  font-size: 0.9em;
  color: var(--tertiary--dark);
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
}

/* Code blocks */
pre {
  background-color: #f8f9fa;
  color: #333333;
  border: 1px solid var(--neutral--medium-light);
  padding: var(--s-4);
  border-radius: 8px;
  overflow-x: auto;
  margin: var(--s-5) 0;
  font-size: var(--b-xs);
  line-height: 1.5;
}

pre code {
  background-color: transparent;
  padding: 0;
  color: inherit;
}

/* Mermaid diagrams */
.mermaid {
  margin: var(--s-5) 0;
  text-align: center;
  background-color: var(--neutral--white);
  padding: var(--s-4);
  border-radius: 8px;
  border: 1px solid var(--neutral--medium-light);
}
  </style>
  <!-- ========== Prism.JS Syntax Highlighting ========== -->

  <!-- Prism theme (choose one theme below) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/prismjs/themes/prism.css"
  />

  <!-- Core Prism library -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs/prism.min.js"></script>

  <!-- Add languages you need -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-csharp.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-json.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-sql.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-typescript.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-yaml.js"></script>

  <!-- Automatically highlight code after page load -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      if (window.Prism) {
        Prism.highlightAll();
      }
    });
  </script>

  <!-- ========== Mermaid Rendering ========== -->

  <!-- Use stable UMD build -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Find code blocks that came from ```mermaid fences
      const mermaidCodeBlocks = document.querySelectorAll(
        'pre.mermaid > code, pre > code.language-mermaid'
      );

      mermaidCodeBlocks.forEach(code => {
        const pre = code.parentElement;
        const parent = pre?.parentElement;
        if (!pre || !parent) return;

        const text = (code.textContent || '').trim();
        if (!text) return;

        // Replace <pre><code> with <div class="mermaid">...</div>
        const div = document.createElement('div');
        div.className = 'mermaid';
        div.textContent = text;

        parent.replaceChild(div, pre);
      });

      mermaid.initialize({
        startOnLoad: true
      });
    });
  </script>
  <!-- Navigation CSS and JS -->
  <link rel="stylesheet" href="navigation.css" />
  <script src="navigation.js" defer></script>
</head>
<body>
<h1 id="azure-episode-management---architecture-design">Azure Episode
Management - Architecture Design</h1>
<p><strong>Version:</strong> 1.2<br />
<strong>Last Updated:</strong> January 15, 2026<br />
<strong>Author:</strong> Andy Bratton<br />
<strong>Parent Document:</strong> <a
href="01-AZURE-PEM-MASTER-PLAN.html">01-AZURE-PEM-MASTER-PLAN.md</a></p>
<hr />
<h2 id="architecture-overview">Architecture Overview</h2>
<p>This document details the Azure cloud backend architecture for the
Episode Management module. <strong>Azure PEM operates as a module within
the on-premises Contract Manager system</strong> - users access PEM
functionality through Contract Manager, which communicates with
Azure-hosted APIs and services.</p>
<p>The design follows Azure Well-Architected Framework principles:
Reliability, Security, Cost Optimization, Operational Excellence, and
Performance Efficiency.</p>
<h3 id="foundational-requirements">Foundational Requirements</h3>
<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 31%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th>Requirement</th>
<th>Production</th>
<th>Dev/QAE/UAT</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Availability</strong></td>
<td>99.99% uptime (zone-redundant)</td>
<td>No SLA (cost-optimized)</td>
</tr>
<tr>
<td><strong>Performance</strong></td>
<td>&lt;100ms API response</td>
<td>Standard performance</td>
</tr>
<tr>
<td><strong>Observability</strong></td>
<td>Verbose logging, full tracing</td>
<td>Standard logging</td>
</tr>
<tr>
<td><strong>Resilience</strong></td>
<td>Zero data loss, auto-failover</td>
<td>Standard backups</td>
</tr>
<tr>
<td><strong>Zone Redundancy</strong></td>
<td>✅ Required</td>
<td>❌ Not required</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Design Philosophy:</strong> <strong>Production should never
be offline</strong> - zone-redundant with no single points of failure.
Non-production environments are cost-optimized and do not require high
availability.</p>
</blockquote>
<hr />
<h2 id="architecture-diagram">Architecture Diagram</h2>
<pre class="mermaid"><code>%%{init: {&#39;theme&#39;: &#39;default&#39;}}%%
flowchart TB
    subgraph ONPREM[&quot;ON-PREMISES (Contract Manager Host)&quot;]
        subgraph CMAPP[&quot;Contract Manager Application&quot;]
            CONTRACTS[&quot;Contracts Module&quot;]
            MODELING[&quot;Modeling Module&quot;]
            PEM[&quot;PEM Module&lt;br/&gt;(Episode Mgmt)&quot;]
        end
        CLAIMSHOP[&quot;ClaimShop&lt;br/&gt;(Claims Data)&quot;]
    end

    subgraph AZURE[&quot;AZURE EPISODE MANAGEMENT&quot;]
        subgraph EDGE[&quot;EDGE &amp; GATEWAY LAYER&quot;]
            AFD[&quot;Azure Front Door&lt;br/&gt;(CDN+WAF+DDoS)&quot;]
            APIM[&quot;API Management&lt;br/&gt;(Auth, Rate Limit, Routing)&quot;]
            EG[&quot;Event Grid&lt;br/&gt;(Webhooks)&quot;]
        end

        subgraph COMPUTE[&quot;COMPUTE LAYER&quot;]
            EP_API[&quot;Episode API&quot;]
            DEF_API[&quot;Definition API&quot;]
            REP_API[&quot;Reporting API&quot;]
            WL_API[&quot;Worklist API&quot;]
            MOD_API[&quot;Modeling API&quot;]
        end

        subgraph MESSAGING[&quot;MESSAGING LAYER (Azure Service Bus)&quot;]
            QUEUES[&quot;Queues: episode-processing | bundle-calculation | claim-association&lt;br/&gt;Topics: episode-events&quot;]
        end

        subgraph WORKERS[&quot;WORKER LAYER (Azure Functions)&quot;]
            EP_W[&quot;Episode Worker&quot;]
            BUNDLE_W[&quot;Bundle Worker&quot;]
            CLAIM_W[&quot;Claim Worker&quot;]
            NOTIFY_W[&quot;Notify Worker&quot;]
        end

        subgraph DATA[&quot;DATA LAYER&quot;]
            SQL[&quot;Azure SQL&lt;br/&gt;(Episodes)&quot;]
            COSMOS[&quot;Cosmos DB&lt;br/&gt;(JSON Docs)&quot;]
            REDIS[&quot;Redis Cache&lt;br/&gt;(Hot Data)&quot;]
            BLOB[&quot;Blob Storage&lt;br/&gt;(Documents)&quot;]
        end

        subgraph PLATFORM[&quot;PLATFORM SERVICES&quot;]
            AAD[&quot;Azure AD&quot;]
            KV[&quot;Key Vault&quot;]
            AI[&quot;App Insights&quot;]
            LA[&quot;Log Analytics&quot;]
        end
    end

    PEM &lt;--&gt;|&quot;HTTPS/REST&quot;| AFD
    CLAIMSHOP -.-&gt;|&quot;Claims Data&quot;| AFD
    AFD --&gt; APIM
    APIM --&gt; COMPUTE
    COMPUTE --&gt; MESSAGING
    MESSAGING --&gt; WORKERS
    WORKERS --&gt; DATA
    NOTIFY_W --&gt; EG
    EG --&gt;|&quot;Webhook&quot;| ONPREM</code></pre>
<hr />
<h2 id="azure-services-detail">Azure Services Detail</h2>
<h3 id="compute-services">Compute Services</h3>
<h4 id="azure-app-service-apis">Azure App Service (APIs)</h4>
<p><strong>Environment-Specific Configuration:</strong></p>
<table>
<thead>
<tr>
<th>Configuration</th>
<th>PROD</th>
<th>Dev/QAE/UAT</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Plan SKU</strong></td>
<td>Premium v3 (P2v3)</td>
<td>Basic (B2) or Standard (S2)</td>
</tr>
<tr>
<td><strong>Zone Redundancy</strong></td>
<td>✅ Enabled (3 zones)</td>
<td>❌ Disabled</td>
</tr>
<tr>
<td><strong>Min Instances</strong></td>
<td>3 (one per zone)</td>
<td>1</td>
</tr>
<tr>
<td><strong>Max Instances</strong></td>
<td>15 (auto-scale)</td>
<td>3</td>
</tr>
<tr>
<td><strong>Slots</strong></td>
<td>Production + Staging</td>
<td>Production only</td>
</tr>
<tr>
<td><strong>Health Checks</strong></td>
<td>30s interval</td>
<td>60s interval</td>
</tr>
<tr>
<td><strong>Auto-Heal</strong></td>
<td>Enabled</td>
<td>Enabled</td>
</tr>
<tr>
<td><strong>Always On</strong></td>
<td>Yes</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p><strong>Terraform Configuration (Environment-Aware):</strong></p>
<pre class="hcl"><code>locals {
  is_production = var.environment == &quot;prod&quot;
  
  app_service_config = {
    prod = {
      sku_name               = &quot;P2v3&quot;
      zone_balancing_enabled = true
      worker_count           = 3
    }
    nonprod = {
      sku_name               = &quot;B2&quot;
      zone_balancing_enabled = false
      worker_count           = 1
    }
  }
  
  config = local.is_production ? local.app_service_config.prod : local.app_service_config.nonprod
}

resource &quot;azurerm_service_plan&quot; &quot;pem_apis&quot; {
  name                   = &quot;plan-pem-apis-${var.environment}&quot;
  resource_group_name    = azurerm_resource_group.compute.name
  location               = azurerm_resource_group.compute.location
  os_type                = &quot;Linux&quot;
  sku_name               = local.config.sku_name
  zone_balancing_enabled = local.config.zone_balancing_enabled
  worker_count           = local.config.worker_count
}

resource &quot;azurerm_linux_web_app&quot; &quot;episode_api&quot; {
  name                = &quot;api-pem-episodes-${var.environment}&quot;
  resource_group_name = azurerm_resource_group.compute.name
  location            = azurerm_resource_group.compute.location
  service_plan_id     = azurerm_service_plan.pem_apis.id

  site_config {
    always_on                         = true
    health_check_path                 = &quot;/health&quot;
    health_check_eviction_time_in_min = local.is_production ? 2 : 5
    
    application_stack {
      dotnet_version = &quot;10.0&quot;
    }
  }
  
  app_settings = {
    &quot;ASPNETCORE_ENVIRONMENT&quot; = var.environment
    &quot;APPLICATIONINSIGHTS_CONNECTION_STRING&quot; = azurerm_application_insights.pem.connection_string
  }
}</code></pre>
<p><strong>Features Used:</strong> - <strong>Zone redundancy (PROD
only)</strong> for high availability - Deployment slots for
zero-downtime deployments - Managed Identity for Azure resource access -
Virtual Network integration - Custom domains with managed SSL - Health
checks with auto-heal</p>
<h4 id="azure-functions-workers">Azure Functions (Workers)</h4>
<p><strong>Environment-Specific Configuration:</strong></p>
<table>
<thead>
<tr>
<th>Configuration</th>
<th>PROD</th>
<th>Dev/QAE/UAT</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Plan</strong></td>
<td>Premium (EP2)</td>
<td>Consumption (Y1)</td>
</tr>
<tr>
<td><strong>Zone Redundancy</strong></td>
<td>✅ Enabled (3 zones)</td>
<td>❌ Disabled</td>
</tr>
<tr>
<td><strong>Min Instances</strong></td>
<td>3 (one per zone)</td>
<td>0 (scale to zero)</td>
</tr>
<tr>
<td><strong>Max Instances</strong></td>
<td>30 (burst)</td>
<td>10</td>
</tr>
<tr>
<td><strong>Always On</strong></td>
<td>Yes</td>
<td>No (cold start OK)</td>
</tr>
</tbody>
</table>
<p><strong>Terraform Configuration (Environment-Aware):</strong></p>
<pre class="hcl"><code>resource &quot;azurerm_service_plan&quot; &quot;pem_functions&quot; {
  count = local.is_production ? 1 : 0  # Premium plan only in prod
  
  name                   = &quot;plan-pem-functions-${var.environment}&quot;
  resource_group_name    = azurerm_resource_group.compute.name
  location               = azurerm_resource_group.compute.location
  os_type                = &quot;Linux&quot;
  sku_name               = &quot;EP2&quot;
  zone_balancing_enabled = true
  worker_count           = 3
}

resource &quot;azurerm_linux_function_app&quot; &quot;pem_workers&quot; {
  name                       = &quot;func-pem-workers-${var.environment}&quot;
  resource_group_name        = azurerm_resource_group.compute.name
  location                   = azurerm_resource_group.compute.location
  
  # Use Premium plan in prod, Consumption in non-prod
  service_plan_id = local.is_production ? azurerm_service_plan.pem_functions[0].id : null
  
  storage_account_name       = azurerm_storage_account.functions.name
  storage_account_access_key = azurerm_storage_account.functions.primary_access_key

  site_config {
    always_on = local.is_production
    
    application_stack {
      dotnet_version              = &quot;10.0&quot;
      use_dotnet_isolated_runtime = true
    }
  }
}</code></pre>
<p><strong>Function Types:</strong></p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Episode Processing Worker</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Function</span><span class="op">(</span><span class="st">&quot;ProcessEpisode&quot;</span><span class="op">)]</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> async Task <span class="fu">ProcessEpisode</span><span class="op">(</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">ServiceBusTrigger</span><span class="op">(</span><span class="st">&quot;episode-processing&quot;</span><span class="op">)]</span> EpisodeMessage message<span class="op">,</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    FunctionContext context<span class="op">)</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Process episode creation/update</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Bundle Calculation Worker</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Function</span><span class="op">(</span><span class="st">&quot;CalculateBundle&quot;</span><span class="op">)]</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> async Task <span class="fu">CalculateBundle</span><span class="op">(</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">ServiceBusTrigger</span><span class="op">(</span><span class="st">&quot;bundle-calculation&quot;</span><span class="op">)]</span> BundleRequest request<span class="op">,</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    FunctionContext context<span class="op">)</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Calculate bundle pricing</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Scheduled Cleanup</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Function</span><span class="op">(</span><span class="st">&quot;CleanupStaleEpisodes&quot;</span><span class="op">)]</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> async Task <span class="fu">Cleanup</span><span class="op">(</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">TimerTrigger</span><span class="op">(</span><span class="st">&quot;0 0 2 * * *&quot;</span><span class="op">)]</span> TimerInfo timer<span class="op">,</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    FunctionContext context<span class="op">)</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Daily cleanup of stale episodes</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="frontend-module-in-contract-manager---not-in-azure">Frontend
(Module in Contract Manager - NOT in Azure)</h4>
<blockquote>
<p><strong>Important:</strong> The PEM UI is <strong>NOT hosted in
Azure</strong>. It is a module within the existing Contract Manager
Angular application (<code>app-cm-web-app</code>). Only the backend APIs
are hosted in Azure.</p>
</blockquote>
<table>
<colgroup>
<col style="width: 68%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Configuration</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Framework</strong></td>
<td>Angular 19+ (same as Contract Manager)</td>
</tr>
<tr>
<td><strong>Hosting</strong></td>
<td>On-prem with Contract Manager (IIS)</td>
</tr>
<tr>
<td><strong>Auth</strong></td>
<td>Uses CM’s existing Azure AD integration</td>
</tr>
<tr>
<td><strong>API Backend</strong></td>
<td>Calls Azure API Management → App Services via
<code>PEM.Client</code> SDK</td>
</tr>
</tbody>
</table>
<p><strong>Angular Architecture (Within Contract Manager):</strong></p>
<p>The PEM module is added to the existing Contract Manager Angular app,
following the <strong>exact same patterns</strong>:</p>
<table>
<colgroup>
<col style="width: 21%" />
<col style="width: 78%" />
</colgroup>
<thead>
<tr>
<th>Pattern</th>
<th>Contract Manager Implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Core Libraries</strong></td>
<td><code>@gazelle/ng-common</code>,
<code>@gazelle/ng-common-ui</code></td>
</tr>
<tr>
<td><strong>UI Components</strong></td>
<td>Angular Material + Angular CDK</td>
</tr>
<tr>
<td><strong>Grid Component</strong></td>
<td><code>gaz-grid</code> with <code>AdvancedDataSource</code></td>
</tr>
<tr>
<td><strong>Virtual Scrolling</strong></td>
<td>CDK virtual scroll via <code>DataSourceFactory</code></td>
</tr>
<tr>
<td><strong>State Management</strong></td>
<td>Store classes extending patterns like
<code>WorklistStore</code></td>
</tr>
<tr>
<td><strong>Observables</strong></td>
<td><code>BehaviorSubject</code>, <code>combineLatest</code>,
<code>switchMap</code></td>
</tr>
<tr>
<td><strong>Subscriptions</strong></td>
<td><code>SubscriberBase</code> with
<code>takeUntil(this.destroyed$)</code></td>
</tr>
<tr>
<td><strong>Change Detection</strong></td>
<td><code>ChangeDetectionStrategy.OnPush</code> throughout</td>
</tr>
<tr>
<td><strong>Dialogs</strong></td>
<td><code>@angular/cdk/dialog</code> with <code>DialogRef</code></td>
</tr>
<tr>
<td><strong>Overlays</strong></td>
<td><code>MenuOverlayService</code> for dropdowns/popovers</td>
</tr>
<tr>
<td><strong>Forms</strong></td>
<td>Reactive Forms with <code>AsyncValidatorFn</code></td>
</tr>
<tr>
<td><strong>Pipes</strong></td>
<td><code>ValueDisplayPipe</code>, <code>EnumDisplayPipe</code>,
etc.</td>
</tr>
<tr>
<td><strong>Logging</strong></td>
<td><code>LoggingService</code> via <code>LogServiceFactory</code></td>
</tr>
<tr>
<td><strong>Snackbars</strong></td>
<td><code>SnackBarService</code> for notifications</td>
</tr>
<tr>
<td><strong>Busy Indicator</strong></td>
<td><code>BusyIndicatorService</code> for loading states</td>
</tr>
</tbody>
</table>
<p><strong>Component Structure (Following CM Patterns):</strong></p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>@<span class="fu">Component</span>({</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  selector<span class="op">:</span> <span class="st">&#39;app-episode-worklist&#39;</span><span class="op">,</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  templateUrl<span class="op">:</span> <span class="st">&#39;./episode-worklist.component.html&#39;</span><span class="op">,</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  styleUrls<span class="op">:</span> [<span class="st">&#39;./episode-worklist.component.scss&#39;</span>]<span class="op">,</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  changeDetection<span class="op">:</span> ChangeDetectionStrategy<span class="op">.</span><span class="at">OnPush</span><span class="op">,</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  providers<span class="op">:</span> [CurrencyPipe<span class="op">,</span> ValueDisplayPipe<span class="op">,</span> <span class="op">...</span>]<span class="op">,</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  standalone<span class="op">:</span> <span class="kw">false</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">class</span> EpisodeWorklistComponent <span class="kw">extends</span> SubscriberBase <span class="kw">implements</span> OnInit<span class="op">,</span> OnDestroy {</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Store injection, observable patterns, takeUntil cleanup</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Dual Access Model:</strong> - <strong>Standalone:</strong>
Users access Azure PEM directly via web browser -
<strong>Embedded:</strong> Contract Manager can embed PEM views via
iframe or component library</p>
<hr />
<h3 id="repository-isolation-integration">Repository Isolation &amp;
Integration</h3>
<p>Azure PEM is maintained in a <strong>separate repository</strong>
from Contract Manager:</p>
<pre class="mermaid"><code>%%{init: {&#39;theme&#39;: &#39;default&#39;}}%%
flowchart TB
    subgraph AZPEM[&quot;azure-pem repository (Isolated, independently deployable)&quot;]
        TF[&quot;Terraform (IaC)&quot;]
        APIS[&quot;NET APIs&quot;]
        FUNC[&quot;Functions (Workers)&quot;]
        SPA[&quot;Angular SPA&quot;]
        SDK[&quot;PEM.Client SDK&quot;]
        
        TF --&gt; CLOUD[&quot;Azure Cloud&quot;]
        APIS --&gt; CLOUD
        FUNC --&gt; CLOUD
        SPA --&gt; CLOUD
        SDK --&gt;|&quot;NuGet Package&lt;br/&gt;(Published)&quot;| NUGET[&quot;NuGet Feed&quot;]
    end

    subgraph CM[&quot;contract-manager repository (Existing monorepo)&quot;]
        subgraph CMAPP[&quot;Contract Manager Application&quot;]
            REF[&quot;References PEM.Client&quot;]
            USES[&quot;Uses SDK to:&lt;br/&gt;• Call Azure PEM APIs&lt;br/&gt;• Push claims data&lt;br/&gt;• Receive episode events&quot;]
        end
    end

    NUGET --&gt;|&quot;version pinned in&lt;br/&gt;packages.config&quot;| REF</code></pre>
<h3 id="pem.client-sdk-integration-package">PEM.Client SDK (Integration
Package)</h3>
<p>The <code>PEM.Client</code> NuGet package is the <strong>only
coupling point</strong> between Azure PEM and Contract Manager:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// PEM.Client usage in Contract Manager</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ContractManagerPemService</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IPemClient _pemClient<span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">ContractManagerPemService</span><span class="op">(</span>IPemClient pemClient<span class="op">)</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        _pemClient <span class="op">=</span> pemClient<span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task<span class="op">&lt;</span>Episode<span class="op">&gt;</span> <span class="fu">GetEpisodeAsync</span><span class="op">(</span>Guid episodeId<span class="op">)</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> await _pemClient<span class="op">.</span><span class="fu">Episodes</span><span class="op">.</span><span class="fu">GetAsync</span><span class="op">(</span>episodeId<span class="op">);</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">PushClaimsAsync</span><span class="op">(</span>IEnumerable<span class="op">&lt;</span>Claim<span class="op">&gt;</span> claims<span class="op">)</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        await _pemClient<span class="op">.</span><span class="fu">Claims</span><span class="op">.</span><span class="fu">IngestAsync</span><span class="op">(</span>claims<span class="op">);</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>SDK Design Principles:</strong> - Typed client for all PEM
APIs - Handles authentication (token acquisition) - Provides retry
policies and resilience - Versioned independently (semantic versioning)
- Backward compatible within major version</p>
<hr />
<h3 id="data-services">Data Services</h3>
<blockquote>
<p><strong>Production</strong> data services are zone-redundant to
ensure no downtime from zone failures. <strong>Non-production</strong>
uses cost-optimized configurations.</p>
</blockquote>
<h4 id="database-strategy-polyglot-persistence">Database Strategy:
Polyglot Persistence</h4>
<blockquote>
<p><strong>Architecture Decision:</strong> Given that JSON is the
internal communication language between all API components, we employ a
<strong>polyglot persistence</strong> strategy using both Azure SQL and
Azure Cosmos DB, selecting the optimal store for each data type.</p>
</blockquote>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 46%" />
<col style="width: 26%" />
</colgroup>
<thead>
<tr>
<th>Data Type</th>
<th>Recommended Store</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Episodes, Claims, Definitions</strong></td>
<td>Azure SQL</td>
<td>Relational integrity, complex joins, ACID transactions, reporting
queries</td>
</tr>
<tr>
<td><strong>Modeling Scenarios &amp; Results</strong></td>
<td>Azure Cosmos DB</td>
<td>Flexible schema, JSON-native, high-throughput writes, scenario
versioning</td>
</tr>
<tr>
<td><strong>Event Sourcing / Audit Logs</strong></td>
<td>Azure Cosmos DB</td>
<td>Append-only, time-series, partition by entity</td>
</tr>
<tr>
<td><strong>User Preferences / Worklists</strong></td>
<td>Azure Cosmos DB</td>
<td>Document-per-user, flexible structure, low-latency reads</td>
</tr>
<tr>
<td><strong>Contract Profiles (JSON rules)</strong></td>
<td>Azure Cosmos DB</td>
<td>Complex nested JSON structures, versioned documents</td>
</tr>
<tr>
<td><strong>Real-time Status Updates</strong></td>
<td>Azure Cosmos DB (Change Feed)</td>
<td>Event-driven processing, SignalR integration</td>
</tr>
</tbody>
</table>
<h4 id="azure-cosmos-db">Azure Cosmos DB</h4>
<p><strong>When to Use Cosmos DB:</strong> - Data is naturally JSON
documents with flexible/evolving schema - High-throughput read/write
operations with predictable latency - Global distribution requirements
(future consideration) - Change feed processing for event-driven
architectures - Schema-less data that varies by tenant or
configuration</p>
<p><strong>Environment-Specific Configuration:</strong></p>
<table>
<thead>
<tr>
<th>Configuration</th>
<th>PROD</th>
<th>Dev/QAE/UAT</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>API</strong></td>
<td>NoSQL (Core)</td>
<td>NoSQL (Core)</td>
</tr>
<tr>
<td><strong>Consistency</strong></td>
<td>Session</td>
<td>Session</td>
</tr>
<tr>
<td><strong>Throughput Mode</strong></td>
<td>Autoscale</td>
<td>Provisioned (400 RU/s)</td>
</tr>
<tr>
<td><strong>Max RU/s</strong></td>
<td>10,000</td>
<td>1,000</td>
</tr>
<tr>
<td><strong>Zone Redundancy</strong></td>
<td>✅ Enabled</td>
<td>❌ Disabled</td>
</tr>
<tr>
<td><strong>Multi-Region</strong></td>
<td>Optional (paired region)</td>
<td>No</td>
</tr>
<tr>
<td><strong>Backup</strong></td>
<td>Continuous (7-day PITR)</td>
<td>Periodic (4-hour)</td>
</tr>
</tbody>
</table>
<p><strong>Terraform Configuration:</strong></p>
<pre class="hcl"><code>locals {
  cosmos_config = {
    prod = {
      consistency_level    = &quot;Session&quot;
      max_throughput       = 10000
      zone_redundant       = true
      backup_type          = &quot;Continuous&quot;
    }
    nonprod = {
      consistency_level    = &quot;Session&quot;
      max_throughput       = 1000
      zone_redundant       = false
      backup_type          = &quot;Periodic&quot;
    }
  }
  
  cosmos_db_config = local.is_production ? local.cosmos_config.prod : local.cosmos_config.nonprod
}

resource &quot;azurerm_cosmosdb_account&quot; &quot;pem&quot; {
  name                = &quot;cosmos-pem-${var.environment}&quot;
  resource_group_name = azurerm_resource_group.data.name
  location            = azurerm_resource_group.data.location
  offer_type          = &quot;Standard&quot;
  kind                = &quot;GlobalDocumentDB&quot;
  
  consistency_policy {
    consistency_level = local.cosmos_db_config.consistency_level
  }
  
  geo_location {
    location          = azurerm_resource_group.data.location
    failover_priority = 0
    zone_redundant    = local.cosmos_db_config.zone_redundant
  }
  
  dynamic &quot;geo_location&quot; {
    for_each = local.is_production ? [1] : []
    content {
      location          = var.secondary_region
      failover_priority = 1
      zone_redundant    = false
    }
  }
  
  backup {
    type = local.cosmos_db_config.backup_type
  }
}

resource &quot;azurerm_cosmosdb_sql_database&quot; &quot;pem&quot; {
  name                = &quot;pem-documents&quot;
  resource_group_name = azurerm_cosmosdb_account.pem.resource_group_name
  account_name        = azurerm_cosmosdb_account.pem.name
}

# Container for Modeling Scenarios
resource &quot;azurerm_cosmosdb_sql_container&quot; &quot;modeling_scenarios&quot; {
  name                = &quot;modeling-scenarios&quot;
  resource_group_name = azurerm_cosmosdb_account.pem.resource_group_name
  account_name        = azurerm_cosmosdb_account.pem.name
  database_name       = azurerm_cosmosdb_sql_database.pem.name
  partition_key_paths = [&quot;/tenantId&quot;]
  
  autoscale_settings {
    max_throughput = local.cosmos_db_config.max_throughput
  }
  
  indexing_policy {
    indexing_mode = &quot;consistent&quot;
    
    included_path {
      path = &quot;/*&quot;
    }
    
    excluded_path {
      path = &quot;/scenarioResultsJson/*&quot;
    }
  }
}

# Container for User Worklists/Preferences
resource &quot;azurerm_cosmosdb_sql_container&quot; &quot;user_worklists&quot; {
  name                = &quot;user-worklists&quot;
  resource_group_name = azurerm_cosmosdb_account.pem.resource_group_name
  account_name        = azurerm_cosmosdb_account.pem.name
  database_name       = azurerm_cosmosdb_sql_database.pem.name
  partition_key_paths = [&quot;/userId&quot;]
  
  autoscale_settings {
    max_throughput = local.cosmos_db_config.max_throughput
  }
}

# Container for Audit/Event Log
resource &quot;azurerm_cosmosdb_sql_container&quot; &quot;audit_events&quot; {
  name                = &quot;audit-events&quot;
  resource_group_name = azurerm_cosmosdb_account.pem.resource_group_name
  account_name        = azurerm_cosmosdb_account.pem.name
  database_name       = azurerm_cosmosdb_sql_database.pem.name
  partition_key_paths = [&quot;/entityType&quot;, &quot;/entityId&quot;]
  default_ttl         = 31536000  # 1 year retention
  
  autoscale_settings {
    max_throughput = local.cosmos_db_config.max_throughput
  }
}</code></pre>
<p><strong>Cosmos DB Container Design:</strong></p>
<table>
<colgroup>
<col style="width: 30%" />
<col style="width: 41%" />
<col style="width: 27%" />
</colgroup>
<thead>
<tr>
<th>Container</th>
<th>Partition Key</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>modeling-scenarios</code></td>
<td><code>/tenantId</code></td>
<td>What-if scenarios, comparison results</td>
</tr>
<tr>
<td><code>user-worklists</code></td>
<td><code>/userId</code></td>
<td>Saved worklists, user preferences</td>
</tr>
<tr>
<td><code>contract-profiles</code></td>
<td><code>/tenantId</code></td>
<td>Contract JSON configurations</td>
</tr>
<tr>
<td><code>audit-events</code></td>
<td><code>/entityType</code> + <code>/entityId</code></td>
<td>Event sourcing, change history</td>
</tr>
<tr>
<td><code>episode-snapshots</code></td>
<td><code>/tenantId</code></td>
<td>Point-in-time episode states for modeling</td>
</tr>
</tbody>
</table>
<h4 id="azure-sql-database">Azure SQL Database</h4>
<p><strong>When to Use Azure SQL:</strong> - Relational data with
foreign key constraints - Complex queries with JOINs across entities -
ACID transactions spanning multiple tables - Reporting and analytics
workloads - Entity Framework Core with migrations</p>
<p><strong>Environment-Specific Configuration:</strong></p>
<table>
<thead>
<tr>
<th>Configuration</th>
<th>PROD</th>
<th>Dev/QAE/UAT</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Tier</strong></td>
<td>Business Critical</td>
<td>General Purpose</td>
</tr>
<tr>
<td><strong>Zone Redundancy</strong></td>
<td>✅ Enabled</td>
<td>❌ Disabled</td>
</tr>
<tr>
<td><strong>vCores</strong></td>
<td>8 (scalable to 16)</td>
<td>2-4</td>
</tr>
<tr>
<td><strong>Max Storage</strong></td>
<td>500 GB</td>
<td>100 GB</td>
</tr>
<tr>
<td><strong>Backup Storage</strong></td>
<td>Zone-redundant (ZRS)</td>
<td>Locally redundant (LRS)</td>
</tr>
<tr>
<td><strong>PITR Retention</strong></td>
<td>35 days</td>
<td>7 days</td>
</tr>
<tr>
<td><strong>LTR</strong></td>
<td>1 year weekly</td>
<td>None</td>
</tr>
<tr>
<td><strong>Geo-Replication</strong></td>
<td>Yes (paired region)</td>
<td>No</td>
</tr>
<tr>
<td><strong>Read Replicas</strong></td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>
<p><strong>Terraform Configuration (Environment-Aware):</strong></p>
<pre class="hcl"><code>locals {
  sql_config = {
    prod = {
      sku_name             = &quot;BC_Gen5_8&quot;  # Business Critical
      zone_redundant       = true
      max_size_gb          = 500
      read_replica_count   = 1
      storage_account_type = &quot;Zone&quot;
      backup_retention     = 35
    }
    nonprod = {
      sku_name             = &quot;GP_Gen5_2&quot;  # General Purpose
      zone_redundant       = false
      max_size_gb          = 100
      read_replica_count   = 0
      storage_account_type = &quot;Local&quot;
      backup_retention     = 7
    }
  }
  
  db_config = local.is_production ? local.sql_config.prod : local.sql_config.nonprod
}

resource &quot;azurerm_mssql_server&quot; &quot;pem&quot; {
  name                         = &quot;sql-pem-${var.environment}&quot;
  resource_group_name          = azurerm_resource_group.data.name
  location                     = azurerm_resource_group.data.location
  version                      = &quot;12.0&quot;
  administrator_login          = &quot;pemadmin&quot;
  administrator_login_password = data.azurerm_key_vault_secret.sql_password.value
  
  azuread_administrator {
    login_username = &quot;PEM-SQL-Admins&quot;
    object_id      = data.azuread_group.sql_admins.object_id
  }
}

resource &quot;azurerm_mssql_database&quot; &quot;pem_episodes&quot; {
  name                 = &quot;pem-episodes-db&quot;
  server_id            = azurerm_mssql_server.pem.id
  sku_name             = local.db_config.sku_name
  zone_redundant       = local.db_config.zone_redundant
  max_size_gb          = local.db_config.max_size_gb
  read_replica_count   = local.db_config.read_replica_count
  storage_account_type = local.db_config.storage_account_type
  
  short_term_retention_policy {
    retention_days           = local.db_config.backup_retention
    backup_interval_in_hours = local.is_production ? 12 : 24
  }
  
  # Long-term retention only in production
  dynamic &quot;long_term_retention_policy&quot; {
    for_each = local.is_production ? [1] : []
    content {
      weekly_retention  = &quot;P4W&quot;
      monthly_retention = &quot;P12M&quot;
      yearly_retention  = &quot;P1Y&quot;
    }
  }
}</code></pre>
<p><strong>Performance Optimizations (All Environments):</strong> -
Query Store enabled for query performance insights - Automatic tuning
enabled (force good plans, create/drop indexes) - Read replicas for
reporting queries (PROD only) - Columnstore indexes on large fact
tables</p>
<p><strong>Database Schema:</strong></p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Core tables</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> Episodes (</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">Id</span> UNIQUEIDENTIFIER <span class="kw">PRIMARY</span> <span class="kw">KEY</span> <span class="kw">DEFAULT</span> NEWID(),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    TenantId UNIQUEIDENTIFIER <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    DefinitionVersionId UNIQUEIDENTIFIER <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    PatientId <span class="dt">NVARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    Status <span class="dt">NVARCHAR</span>(<span class="dv">20</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    TriggerDate <span class="dt">DATE</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    StartDate <span class="dt">DATE</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    EndDate <span class="dt">DATE</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    BundleAmount <span class="dt">DECIMAL</span>(<span class="dv">18</span>,<span class="dv">2</span>),</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    TargetPrice <span class="dt">DECIMAL</span>(<span class="dv">18</span>,<span class="dv">2</span>),</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Variance</span> <span class="dt">DECIMAL</span>(<span class="dv">18</span>,<span class="dv">2</span>),</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    CreatedAt DATETIME2 <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> SYSUTCDATETIME(),</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    ModifiedAt DATETIME2 <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> SYSUTCDATETIME(),</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">INDEX</span> IX_Episodes_Tenant_Status (TenantId, Status),</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">INDEX</span> IX_Episodes_Patient (TenantId, PatientId),</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">INDEX</span> IX_Episodes_TriggerDate (TenantId, TriggerDate)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> EpisodeClaims (</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">Id</span> UNIQUEIDENTIFIER <span class="kw">PRIMARY</span> <span class="kw">KEY</span> <span class="kw">DEFAULT</span> NEWID(),</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    EpisodeId UNIQUEIDENTIFIER <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">REFERENCES</span> Episodes(<span class="kw">Id</span>),</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    ExternalClaimId <span class="dt">NVARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    IsTriggerClaim BIT <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="dv">0</span>,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    PhaseId UNIQUEIDENTIFIER <span class="kw">NULL</span>,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    ClaimDate <span class="dt">DATE</span>,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    ClaimAmount <span class="dt">DECIMAL</span>(<span class="dv">18</span>,<span class="dv">2</span>),</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    AssociatedAt DATETIME2 <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> SYSUTCDATETIME(),</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">INDEX</span> IX_EpisodeClaims_Episode (EpisodeId),</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">INDEX</span> IX_EpisodeClaims_External (ExternalClaimId)</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<h4 id="azure-cache-for-redis">Azure Cache for Redis</h4>
<p><strong>Environment-Specific Configuration:</strong></p>
<table>
<thead>
<tr>
<th>Configuration</th>
<th>PROD</th>
<th>Dev/QAE/UAT</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Tier</strong></td>
<td>Premium (P1)</td>
<td>Basic (C0) or Standard (C1)</td>
</tr>
<tr>
<td><strong>Zone Redundancy</strong></td>
<td>✅ Enabled</td>
<td>❌ Disabled</td>
</tr>
<tr>
<td><strong>Size</strong></td>
<td>6 GB</td>
<td>250 MB - 1 GB</td>
</tr>
<tr>
<td><strong>Replicas</strong></td>
<td>2 (for failover)</td>
<td>0</td>
</tr>
<tr>
<td><strong>Clustering</strong></td>
<td>Ready</td>
<td>Disabled</td>
</tr>
<tr>
<td><strong>Persistence</strong></td>
<td>AOF enabled</td>
<td>Disabled</td>
</tr>
</tbody>
</table>
<p><strong>Terraform Configuration (Environment-Aware):</strong></p>
<pre class="hcl"><code>locals {
  redis_config = {
    prod = {
      sku_name   = &quot;Premium&quot;
      family     = &quot;P&quot;
      capacity   = 1
      zones      = [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;]
      replicas   = 2
    }
    nonprod = {
      sku_name   = &quot;Basic&quot;
      family     = &quot;C&quot;
      capacity   = 0
      zones      = null
      replicas   = 0
    }
  }
  
  cache_config = local.is_production ? local.redis_config.prod : local.redis_config.nonprod
}

resource &quot;azurerm_redis_cache&quot; &quot;pem&quot; {
  name                          = &quot;redis-pem-${var.environment}&quot;
  resource_group_name           = azurerm_resource_group.data.name
  location                      = azurerm_resource_group.data.location
  sku_name                      = local.cache_config.sku_name
  family                        = local.cache_config.family
  capacity                      = local.cache_config.capacity
  zones                         = local.cache_config.zones
  replicas_per_primary          = local.cache_config.replicas
  minimum_tls_version           = &quot;1.2&quot;
  public_network_access_enabled = false
}</code></pre>
<hr />
<h3 id="caching-strategy">Caching Strategy</h3>
<h4 id="overview">Overview</h4>
<p>PEM uses a multi-tier caching strategy to optimize performance and
reduce database load:</p>
<p><strong>Cache Hierarchy</strong></p>
<pre class="mermaid"><code>%%{init: {&#39;theme&#39;: &#39;default&#39;}}%%
flowchart LR
    subgraph CLIENT[&quot;CLIENT TIER&quot;]
        BROWSER[&quot;Browser Cache&lt;br/&gt;(HTTP Cache-Control)&quot;]
        APIM_CACHE[&quot;APIM Response Cache&lt;br/&gt;(Short-lived)&quot;]
    end

    subgraph APP[&quot;APPLICATION TIER&quot;]
        MEMORY[&quot;In-Memory Cache&lt;br/&gt;(IMemoryCache)&quot;]
        REDIS[&quot;Redis Distributed Cache&lt;br/&gt;(Shared)&quot;]
    end

    subgraph DATA[&quot;DATA TIER&quot;]
        SQL[&quot;Azure SQL&quot;]
    end

    BROWSER --&gt; MEMORY
    APIM_CACHE --&gt; MEMORY
    MEMORY --&gt; SQL
    REDIS --&gt; SQL</code></pre>
<h4 id="what-gets-cached">What Gets Cached</h4>
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 24%" />
<col style="width: 7%" />
<col style="width: 33%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th>Data Type</th>
<th>Cache Location</th>
<th>TTL</th>
<th>Invalidation Strategy</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Episode Definitions</strong></td>
<td>Redis</td>
<td>1 hour</td>
<td>Event-based</td>
<td>Rarely change, high read frequency</td>
</tr>
<tr>
<td><strong>Definition Versions</strong></td>
<td>Redis</td>
<td>1 hour</td>
<td>Event-based</td>
<td>Immutable once published</td>
</tr>
<tr>
<td><strong>Contract Profiles</strong></td>
<td>Redis</td>
<td>30 min</td>
<td>Event-based</td>
<td>Moderate change frequency</td>
</tr>
<tr>
<td><strong>Lookup Tables</strong> (status, phases)</td>
<td>Redis + Memory</td>
<td>24 hours</td>
<td>TTL only</td>
<td>Very rarely change</td>
</tr>
<tr>
<td><strong>User Preferences</strong></td>
<td>Redis</td>
<td>15 min</td>
<td>TTL + on-save</td>
<td>Moderate change frequency</td>
</tr>
<tr>
<td><strong>Episode Detail</strong></td>
<td>Redis</td>
<td>5 min</td>
<td>Event-based</td>
<td>Frequently read, can change</td>
</tr>
<tr>
<td><strong>Episode Search Results</strong></td>
<td>APIM only</td>
<td>30 sec</td>
<td>TTL only</td>
<td>Too dynamic for app-level cache</td>
</tr>
<tr>
<td><strong>Worklist Results</strong></td>
<td>APIM only</td>
<td>15 sec</td>
<td>TTL only</td>
<td>Personalized, frequently changing</td>
</tr>
<tr>
<td><strong>Bundle Calculations</strong></td>
<td>Redis</td>
<td>10 min</td>
<td>Event-based</td>
<td>Expensive to compute</td>
</tr>
<tr>
<td><strong>Modeling Scenarios</strong></td>
<td>Redis</td>
<td>30 min</td>
<td>Event-based</td>
<td>Read-heavy after creation</td>
</tr>
</tbody>
</table>
<h4 id="cache-key-structure">Cache Key Structure</h4>
<pre><code>{tenant}:{entity}:{identifier}[:{variant}]

Examples:
- tenant-abc:definition:550e8400-e29b-41d4-a716-446655440000
- tenant-abc:definition:550e8400-e29b-41d4-a716-446655440000:v3
- tenant-abc:episode:123e4567-e89b-12d3-a456-426614174000
- tenant-abc:episode:123e4567-e89b-12d3-a456-426614174000:claims
- tenant-abc:contract-profile:7890abcd-ef01-2345-6789-0abcdef01234
- tenant-abc:lookup:episode-statuses
- tenant-abc:bundle-calc:episode-id:scenario-hash</code></pre>
<h4 id="caching-patterns">Caching Patterns</h4>
<h5 id="pattern-1-cache-aside-read-through">Pattern 1: Cache-Aside
(Read-Through)</h5>
<p>Used for: <strong>Definitions, Contract Profiles,
Lookups</strong></p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> DefinitionCacheService <span class="op">:</span> IDefinitionCacheService</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IDistributedCache _cache<span class="op">;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IDefinitionRepository _repository<span class="op">;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> ILogger<span class="op">&lt;</span>DefinitionCacheService<span class="op">&gt;</span> _logger<span class="op">;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">static</span> <span class="kw">readonly</span> DistributedCacheEntryOptions CacheOptions <span class="op">=</span> <span class="kw">new</span><span class="op">()</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        AbsoluteExpirationRelativeToNow <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromHours</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        SlidingExpiration <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromMinutes</span><span class="op">(</span><span class="dv">15</span><span class="op">)</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task<span class="op">&lt;</span>EpisodeDefinition<span class="op">?&gt;</span> <span class="fu">GetDefinitionAsync</span><span class="op">(</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        Guid tenantId<span class="op">,</span> </span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        Guid definitionId<span class="op">,</span> </span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        CancellationToken ct <span class="op">=</span> <span class="kw">default</span><span class="op">)</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> cacheKey <span class="op">=</span> $<span class="st">&quot;{tenantId}:definition:{definitionId}&quot;</span><span class="op">;</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 1. Try cache first</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> cached <span class="op">=</span> await _cache<span class="op">.</span><span class="fu">GetStringAsync</span><span class="op">(</span>cacheKey<span class="op">,</span> ct<span class="op">);</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>cached <span class="kw">is</span> not <span class="kw">null</span><span class="op">)</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>            _logger<span class="op">.</span><span class="fu">LogDebug</span><span class="op">(</span><span class="st">&quot;Cache HIT for definition {DefinitionId}&quot;</span><span class="op">,</span> definitionId<span class="op">);</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> JsonSerializer<span class="op">.</span><span class="fu">Deserialize</span><span class="op">&lt;</span>EpisodeDefinition<span class="op">&gt;(</span>cached<span class="op">);</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>        _logger<span class="op">.</span><span class="fu">LogDebug</span><span class="op">(</span><span class="st">&quot;Cache MISS for definition {DefinitionId}&quot;</span><span class="op">,</span> definitionId<span class="op">);</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 2. Load from database</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> definition <span class="op">=</span> await _repository<span class="op">.</span><span class="fu">GetByIdAsync</span><span class="op">(</span>tenantId<span class="op">,</span> definitionId<span class="op">,</span> ct<span class="op">);</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 3. Populate cache (only if found)</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>definition <span class="kw">is</span> not <span class="kw">null</span><span class="op">)</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>            await _cache<span class="op">.</span><span class="fu">SetStringAsync</span><span class="op">(</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>                cacheKey<span class="op">,</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>                JsonSerializer<span class="op">.</span><span class="fu">Serialize</span><span class="op">(</span>definition<span class="op">),</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>                CacheOptions<span class="op">,</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>                ct<span class="op">);</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> definition<span class="op">;</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h5 id="pattern-2-write-through">Pattern 2: Write-Through</h5>
<p>Used for: <strong>Episode Status, Episode Notes</strong> (ensures
cache consistency on writes)</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> EpisodeWriteThroughService <span class="op">:</span> IEpisodeService</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task<span class="op">&lt;</span>Episode<span class="op">&gt;</span> <span class="fu">UpdateStatusAsync</span><span class="op">(</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        Guid tenantId<span class="op">,</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        Guid episodeId<span class="op">,</span> </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        EpisodeStatus newStatus<span class="op">,</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">string</span> reason<span class="op">,</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        CancellationToken ct <span class="op">=</span> <span class="kw">default</span><span class="op">)</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 1. Update database</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> episode <span class="op">=</span> await _repository<span class="op">.</span><span class="fu">UpdateStatusAsync</span><span class="op">(</span>episodeId<span class="op">,</span> newStatus<span class="op">,</span> reason<span class="op">,</span> ct<span class="op">);</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 2. Update cache (write-through)</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> cacheKey <span class="op">=</span> $<span class="st">&quot;{tenantId}:episode:{episodeId}&quot;</span><span class="op">;</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>        await _cache<span class="op">.</span><span class="fu">SetStringAsync</span><span class="op">(</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>            cacheKey<span class="op">,</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>            JsonSerializer<span class="op">.</span><span class="fu">Serialize</span><span class="op">(</span>episode<span class="op">),</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>            <span class="kw">new</span> DistributedCacheEntryOptions</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>                AbsoluteExpirationRelativeToNow <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromMinutes</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">},</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>            ct<span class="op">);</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 3. Publish event for other cache invalidation</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>        await _eventBus<span class="op">.</span><span class="fu">PublishAsync</span><span class="op">(</span><span class="kw">new</span> <span class="fu">EpisodeUpdatedEvent</span><span class="op">(</span>tenantId<span class="op">,</span> episodeId<span class="op">),</span> ct<span class="op">);</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> episode<span class="op">;</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h5 id="pattern-3-event-based-invalidation">Pattern 3: Event-Based
Invalidation</h5>
<p>Used for: <strong>Cross-service cache invalidation</strong></p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CacheInvalidationHandler <span class="op">:</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    IEventHandler<span class="op">&lt;</span>DefinitionUpdatedEvent<span class="op">&gt;,</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    IEventHandler<span class="op">&lt;</span>EpisodeUpdatedEvent<span class="op">&gt;,</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    IEventHandler<span class="op">&lt;</span>ContractProfileUpdatedEvent<span class="op">&gt;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IDistributedCache _cache<span class="op">;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> ILogger<span class="op">&lt;</span>CacheInvalidationHandler<span class="op">&gt;</span> _logger<span class="op">;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">HandleAsync</span><span class="op">(</span>DefinitionUpdatedEvent @event<span class="op">,</span> CancellationToken ct<span class="op">)</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> keys <span class="op">=</span> <span class="kw">new</span><span class="op">[]</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>            $<span class="st">&quot;{@event.TenantId}:definition:{@event.DefinitionId}&quot;</span><span class="op">,</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>            $<span class="st">&quot;{@event.TenantId}:definition:{@event.DefinitionId}:versions&quot;</span><span class="op">,</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>            $<span class="st">&quot;{@event.TenantId}:definition-list&quot;</span>  <span class="co">// Invalidate list cache too</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">foreach</span> <span class="op">(</span><span class="dt">var</span> key <span class="kw">in</span> keys<span class="op">)</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>            await _cache<span class="op">.</span><span class="fu">RemoveAsync</span><span class="op">(</span>key<span class="op">,</span> ct<span class="op">);</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>            _logger<span class="op">.</span><span class="fu">LogInformation</span><span class="op">(</span><span class="st">&quot;Cache invalidated: {Key}&quot;</span><span class="op">,</span> key<span class="op">);</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">HandleAsync</span><span class="op">(</span>EpisodeUpdatedEvent @event<span class="op">,</span> CancellationToken ct<span class="op">)</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>        await _cache<span class="op">.</span><span class="fu">RemoveAsync</span><span class="op">(</span>$<span class="st">&quot;{@event.TenantId}:episode:{@event.EpisodeId}&quot;</span><span class="op">,</span> ct<span class="op">);</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Also invalidate related bundle calculation cache</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>        await _cache<span class="op">.</span><span class="fu">RemoveAsync</span><span class="op">(</span>$<span class="st">&quot;{@event.TenantId}:bundle-calc:{@event.EpisodeId}:*&quot;</span><span class="op">,</span> ct<span class="op">);</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">HandleAsync</span><span class="op">(</span>ContractProfileUpdatedEvent @event<span class="op">,</span> CancellationToken ct<span class="op">)</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>        await _cache<span class="op">.</span><span class="fu">RemoveAsync</span><span class="op">(</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>            $<span class="st">&quot;{@event.TenantId}:contract-profile:{@event.ProfileId}&quot;</span><span class="op">,</span> ct<span class="op">);</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Contract changes may affect all bundle calculations - </span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">// invalidate by pattern (requires Redis SCAN)</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>        await <span class="fu">InvalidateByPatternAsync</span><span class="op">(</span>$<span class="st">&quot;{@event.TenantId}:bundle-calc:*&quot;</span><span class="op">,</span> ct<span class="op">);</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="cache-invalidation-strategy">Cache Invalidation Strategy</h4>
<p><strong>Cache Invalidation Triggers</strong></p>
<table>
<thead>
<tr>
<th>Trigger</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>TTL Expiration</td>
<td>Time-based automatic expiration</td>
</tr>
<tr>
<td>Write Operation</td>
<td>Write-through invalidation</td>
</tr>
<tr>
<td>Domain Event</td>
<td>Event-based invalidation</td>
</tr>
<tr>
<td>Manual Purge</td>
<td>Admin action</td>
</tr>
</tbody>
</table>
<p><strong>Strategy by Data Type:</strong> - Lookups: TTL only (24h) -
Definitions: Event + TTL (1h) - Episodes: Event + TTL (5m) -
Calculations: Event + TTL (10m)</p>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 37%" />
<col style="width: 17%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr>
<th>Strategy</th>
<th>When to Use</th>
<th>Pros</th>
<th>Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>TTL Only</strong></td>
<td>Lookup tables, reference data</td>
<td>Simple, no coordination needed</td>
<td>May serve stale data</td>
</tr>
<tr>
<td><strong>Event-Based</strong></td>
<td>Frequently updated entities</td>
<td>Immediate consistency</td>
<td>Requires event infrastructure</td>
</tr>
<tr>
<td><strong>Write-Through</strong></td>
<td>Critical data, single-service ownership</td>
<td>Strong consistency</td>
<td>Higher write latency</td>
</tr>
<tr>
<td><strong>Hybrid (Event + TTL)</strong></td>
<td>Most entities</td>
<td>Best of both, eventual fallback</td>
<td>More complex</td>
</tr>
</tbody>
</table>
<h4 id="cache-warming-strategy">Cache Warming Strategy</h4>
<p>Cache warming ensures critical data is pre-loaded after deployments
or cache flushes:</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CacheWarmingService <span class="op">:</span> BackgroundService</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="kw">override</span> async Task <span class="fu">ExecuteAsync</span><span class="op">(</span>CancellationToken stoppingToken<span class="op">)</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Wait for app to be fully initialized</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        await Task<span class="op">.</span><span class="fu">Delay</span><span class="op">(</span>TimeSpan<span class="op">.</span><span class="fu">FromSeconds</span><span class="op">(</span><span class="dv">10</span><span class="op">),</span> stoppingToken<span class="op">);</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        _logger<span class="op">.</span><span class="fu">LogInformation</span><span class="op">(</span><span class="st">&quot;Starting cache warming...&quot;</span><span class="op">);</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> stopwatch <span class="op">=</span> Stopwatch<span class="op">.</span><span class="fu">StartNew</span><span class="op">();</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Warm in priority order</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        await <span class="fu">WarmLookupTablesAsync</span><span class="op">(</span>stoppingToken<span class="op">);</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        await <span class="fu">WarmActiveDefinitionsAsync</span><span class="op">(</span>stoppingToken<span class="op">);</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        await <span class="fu">WarmFrequentlyAccessedEpisodesAsync</span><span class="op">(</span>stoppingToken<span class="op">);</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        stopwatch<span class="op">.</span><span class="fu">Stop</span><span class="op">();</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        _logger<span class="op">.</span><span class="fu">LogInformation</span><span class="op">(</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Cache warming completed in {Duration}ms&quot;</span><span class="op">,</span> </span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>            stopwatch<span class="op">.</span><span class="fu">ElapsedMilliseconds</span><span class="op">);</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> async Task <span class="fu">WarmLookupTablesAsync</span><span class="op">(</span>CancellationToken ct<span class="op">)</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> lookups <span class="op">=</span> <span class="kw">new</span><span class="op">[]</span> </span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span> </span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;episode-statuses&quot;</span><span class="op">,</span> </span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;episode-phases&quot;</span><span class="op">,</span> </span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;claim-types&quot;</span><span class="op">,</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;provider-types&quot;</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">foreach</span> <span class="op">(</span><span class="dt">var</span> lookup <span class="kw">in</span> lookups<span class="op">)</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> data <span class="op">=</span> await _lookupRepository<span class="op">.</span><span class="fu">GetAllAsync</span><span class="op">(</span>lookup<span class="op">,</span> ct<span class="op">);</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>            await _cache<span class="op">.</span><span class="fu">SetStringAsync</span><span class="op">(</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>                $<span class="st">&quot;global:lookup:{lookup}&quot;</span><span class="op">,</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>                JsonSerializer<span class="op">.</span><span class="fu">Serialize</span><span class="op">(</span>data<span class="op">),</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>                <span class="kw">new</span> DistributedCacheEntryOptions</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>                    AbsoluteExpirationRelativeToNow <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromHours</span><span class="op">(</span><span class="dv">24</span><span class="op">)</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>                <span class="op">},</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>                ct<span class="op">);</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>        _logger<span class="op">.</span><span class="fu">LogInformation</span><span class="op">(</span><span class="st">&quot;Warmed {Count} lookup tables&quot;</span><span class="op">,</span> lookups<span class="op">.</span><span class="fu">Length</span><span class="op">);</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> async Task <span class="fu">WarmActiveDefinitionsAsync</span><span class="op">(</span>CancellationToken ct<span class="op">)</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get all active definitions across tenants</span></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> definitions <span class="op">=</span> await _definitionRepository</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">GetActiveDefinitionsAsync</span><span class="op">(</span>ct<span class="op">);</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> tasks <span class="op">=</span> definitions<span class="op">.</span><span class="fu">Select</span><span class="op">(</span>async def <span class="op">=&gt;</span></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> cacheKey <span class="op">=</span> $<span class="st">&quot;{def.TenantId}:definition:{def.Id}&quot;</span><span class="op">;</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>            await _cache<span class="op">.</span><span class="fu">SetStringAsync</span><span class="op">(</span></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>                cacheKey<span class="op">,</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>                JsonSerializer<span class="op">.</span><span class="fu">Serialize</span><span class="op">(</span>def<span class="op">),</span></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>                <span class="kw">new</span> DistributedCacheEntryOptions</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>                    AbsoluteExpirationRelativeToNow <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromHours</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>                <span class="op">},</span></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>                ct<span class="op">);</span></span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>        await Task<span class="op">.</span><span class="fu">WhenAll</span><span class="op">(</span>tasks<span class="op">);</span></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>        _logger<span class="op">.</span><span class="fu">LogInformation</span><span class="op">(</span><span class="st">&quot;Warmed {Count} active definitions&quot;</span><span class="op">,</span> definitions<span class="op">.</span><span class="fu">Count</span><span class="op">);</span></span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> async Task <span class="fu">WarmFrequentlyAccessedEpisodesAsync</span><span class="op">(</span>CancellationToken ct<span class="op">)</span></span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Warm episodes accessed in last 24 hours (based on access log)</span></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> recentEpisodes <span class="op">=</span> await _accessLogRepository</span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">GetFrequentlyAccessedEpisodesAsync</span><span class="op">(</span></span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>                since<span class="op">:</span> DateTime<span class="op">.</span><span class="fu">UtcNow</span><span class="op">.</span><span class="fu">AddHours</span><span class="op">(-</span><span class="dv">24</span><span class="op">),</span></span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>                limit<span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>                ct<span class="op">);</span></span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> tasks <span class="op">=</span> recentEpisodes<span class="op">.</span><span class="fu">Select</span><span class="op">(</span>async ep <span class="op">=&gt;</span></span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> episode <span class="op">=</span> await _episodeRepository<span class="op">.</span><span class="fu">GetByIdAsync</span><span class="op">(</span>ep<span class="op">.</span><span class="fu">TenantId</span><span class="op">,</span> ep<span class="op">.</span><span class="fu">Id</span><span class="op">,</span> ct<span class="op">);</span></span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> <span class="op">(</span>episode <span class="kw">is</span> not <span class="kw">null</span><span class="op">)</span></span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>                await _cache<span class="op">.</span><span class="fu">SetStringAsync</span><span class="op">(</span></span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>                    $<span class="st">&quot;{ep.TenantId}:episode:{ep.Id}&quot;</span><span class="op">,</span></span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>                    JsonSerializer<span class="op">.</span><span class="fu">Serialize</span><span class="op">(</span>episode<span class="op">),</span></span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">new</span> DistributedCacheEntryOptions</span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>                    <span class="op">{</span></span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a>                        AbsoluteExpirationRelativeToNow <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromMinutes</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a>                    <span class="op">},</span></span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a>                    ct<span class="op">);</span></span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a>        await Task<span class="op">.</span><span class="fu">WhenAll</span><span class="op">(</span>tasks<span class="op">);</span></span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a>        _logger<span class="op">.</span><span class="fu">LogInformation</span><span class="op">(</span><span class="st">&quot;Warmed {Count} frequently accessed episodes&quot;</span><span class="op">,</span> recentEpisodes<span class="op">.</span><span class="fu">Count</span><span class="op">);</span></span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="api-management-response-caching">API Management Response
Caching</h4>
<p>APIM provides an additional caching layer for read-heavy
endpoints:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode xml"><code class="sourceCode xml"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- APIM Policy for Episode Search --&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">policies</span>&gt;</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">inbound</span>&gt;</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">cache-lookup</span> <span class="ot">vary-by-developer=</span><span class="st">&quot;false&quot;</span> </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>                      <span class="ot">vary-by-developer-groups=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>                      <span class="ot">vary-by-query-parameter=</span><span class="st">&quot;*&quot;</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>                      <span class="ot">caching-type=</span><span class="st">&quot;internal&quot;</span>&gt;</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">vary-by-header</span>&gt;X-Tenant-Id&lt;/<span class="kw">vary-by-header</span>&gt;</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">vary-by-header</span>&gt;Authorization&lt;/<span class="kw">vary-by-header</span>&gt;</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">cache-lookup</span>&gt;</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">inbound</span>&gt;</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">outbound</span>&gt;</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">cache-store</span> <span class="ot">duration=</span><span class="st">&quot;30&quot;</span> /&gt;</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">set-header</span> <span class="ot">name=</span><span class="st">&quot;X-Cache&quot;</span> <span class="ot">exists-action=</span><span class="st">&quot;override&quot;</span>&gt;</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">value</span>&gt;@(context.Response.Headers.GetValueOrDefault(&quot;X-Cache-Status&quot;, &quot;MISS&quot;))&lt;/<span class="kw">value</span>&gt;</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">set-header</span>&gt;</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">outbound</span>&gt;</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">policies</span>&gt;</span></code></pre></div>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>APIM Cache Duration</th>
<th>Vary By</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GET /episodes</code> (search)</td>
<td>30 seconds</td>
<td>Query params, Tenant, User</td>
</tr>
<tr>
<td><code>GET /episodes/{id}</code></td>
<td>60 seconds</td>
<td>Tenant</td>
</tr>
<tr>
<td><code>GET /definitions</code></td>
<td>5 minutes</td>
<td>Tenant</td>
</tr>
<tr>
<td><code>GET /definitions/{id}</code></td>
<td>5 minutes</td>
<td>Tenant</td>
</tr>
<tr>
<td><code>GET /lookups/*</code></td>
<td>30 minutes</td>
<td>None</td>
</tr>
<tr>
<td><code>POST /episodes/*</code></td>
<td>No cache</td>
<td>N/A</td>
</tr>
<tr>
<td><code>PUT /episodes/*</code></td>
<td>No cache</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<h4 id="cache-metrics-and-monitoring">Cache Metrics and Monitoring</h4>
<div class="sourceCode" id="cb19"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CacheMetricsDecorator <span class="op">:</span> IDistributedCache</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IDistributedCache _inner<span class="op">;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IMetricsService _metrics<span class="op">;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task<span class="op">&lt;</span><span class="dt">byte</span><span class="op">[]?&gt;</span> <span class="fu">GetAsync</span><span class="op">(</span><span class="dt">string</span> key<span class="op">,</span> CancellationToken ct <span class="op">=</span> <span class="kw">default</span><span class="op">)</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> stopwatch <span class="op">=</span> Stopwatch<span class="op">.</span><span class="fu">StartNew</span><span class="op">();</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> result <span class="op">=</span> await _inner<span class="op">.</span><span class="fu">GetAsync</span><span class="op">(</span>key<span class="op">,</span> ct<span class="op">);</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>        stopwatch<span class="op">.</span><span class="fu">Stop</span><span class="op">();</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> hit <span class="op">=</span> result <span class="kw">is</span> not <span class="kw">null</span><span class="op">;</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        _metrics<span class="op">.</span><span class="fu">RecordHistogram</span><span class="op">(</span><span class="st">&quot;cache.latency.ms&quot;</span><span class="op">,</span> stopwatch<span class="op">.</span><span class="fu">ElapsedMilliseconds</span><span class="op">,</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>            <span class="kw">new</span> Dictionary<span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">string</span><span class="op">&gt;</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>                <span class="op">[</span><span class="st">&quot;operation&quot;</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;get&quot;</span><span class="op">,</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>                <span class="op">[</span><span class="st">&quot;hit&quot;</span><span class="op">]</span> <span class="op">=</span> hit<span class="op">.</span><span class="fu">ToString</span><span class="op">().</span><span class="fu">ToLower</span><span class="op">()</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">});</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>        _metrics<span class="op">.</span><span class="fu">IncrementCounter</span><span class="op">(</span>hit <span class="op">?</span> <span class="st">&quot;cache.hits&quot;</span> <span class="op">:</span> <span class="st">&quot;cache.misses&quot;</span><span class="op">,</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>            <span class="kw">new</span> Dictionary<span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">string</span><span class="op">&gt;</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>                <span class="op">[</span><span class="st">&quot;key_prefix&quot;</span><span class="op">]</span> <span class="op">=</span> <span class="fu">ExtractKeyPrefix</span><span class="op">(</span>key<span class="op">)</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">});</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> result<span class="op">;</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">static</span> <span class="dt">string</span> <span class="fu">ExtractKeyPrefix</span><span class="op">(</span><span class="dt">string</span> key<span class="op">)</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Extract entity type from key for metrics grouping</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// e.g., &quot;tenant-abc:definition:123&quot; -&gt; &quot;definition&quot;</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> parts <span class="op">=</span> key<span class="op">.</span><span class="fu">Split</span><span class="op">(</span><span class="ch">&#39;:&#39;</span><span class="op">);</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> parts<span class="op">.</span><span class="fu">Length</span> <span class="op">&gt;=</span> <span class="dv">2</span> <span class="op">?</span> parts<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">:</span> <span class="st">&quot;unknown&quot;</span><span class="op">;</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Key Metrics to Monitor:</strong></p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Warning Threshold</th>
<th>Critical Threshold</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cache Hit Rate</td>
<td>&lt; 80%</td>
<td>&lt; 60%</td>
<td>Review TTL, warming strategy</td>
</tr>
<tr>
<td>Cache Latency (P95)</td>
<td>&gt; 10ms</td>
<td>&gt; 50ms</td>
<td>Check Redis performance</td>
</tr>
<tr>
<td>Cache Memory Usage</td>
<td>&gt; 70%</td>
<td>&gt; 90%</td>
<td>Scale Redis, review eviction</td>
</tr>
<tr>
<td>Cache Evictions/min</td>
<td>&gt; 100</td>
<td>&gt; 500</td>
<td>Increase capacity</td>
</tr>
<tr>
<td>Invalidation Lag</td>
<td>&gt; 5s</td>
<td>&gt; 30s</td>
<td>Check event processing</td>
</tr>
</tbody>
</table>
<h4 id="application-insights-query-for-cache-performance">Application
Insights Query for Cache Performance</h4>
<pre class="kusto"><code>// Cache hit rate over time
customMetrics
| where name in (&quot;cache.hits&quot;, &quot;cache.misses&quot;)
| summarize hits = sumif(value, name == &quot;cache.hits&quot;),
            misses = sumif(value, name == &quot;cache.misses&quot;)
  by bin(timestamp, 5m)
| extend hit_rate = hits / (hits + misses) * 100
| render timechart

// Cache latency by entity type
customMetrics
| where name == &quot;cache.latency.ms&quot;
| extend key_prefix = tostring(customDimensions[&quot;key_prefix&quot;])
| summarize p50 = percentile(value, 50),
            p95 = percentile(value, 95),
            p99 = percentile(value, 99)
  by bin(timestamp, 5m), key_prefix
| render timechart</code></pre>
<hr />
<h4 id="azure-blob-storage">Azure Blob Storage</h4>
<table>
<thead>
<tr>
<th>Container</th>
<th>Purpose</th>
<th>Tier</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>claim-files</code></td>
<td>Inbound claim files</td>
<td>Hot</td>
</tr>
<tr>
<td><code>reports</code></td>
<td>Generated reports</td>
<td>Cool</td>
</tr>
<tr>
<td><code>exports</code></td>
<td>Data exports</td>
<td>Cool</td>
</tr>
<tr>
<td><code>audit-logs</code></td>
<td>Audit trail</td>
<td>Archive</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="messaging-services">Messaging Services</h3>
<h4 id="azure-service-bus">Azure Service Bus</h4>
<p><strong>Environment-Specific Configuration:</strong></p>
<table>
<thead>
<tr>
<th>Configuration</th>
<th>PROD</th>
<th>Dev/QAE/UAT</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Tier</strong></td>
<td>Premium</td>
<td>Standard</td>
</tr>
<tr>
<td><strong>Zone Redundancy</strong></td>
<td>✅ Enabled</td>
<td>❌ Disabled</td>
</tr>
<tr>
<td><strong>Messaging Units</strong></td>
<td>1 (scalable to 4)</td>
<td>N/A</td>
</tr>
<tr>
<td><strong>Max Message Size</strong></td>
<td>100 MB</td>
<td>256 KB</td>
</tr>
<tr>
<td><strong>Partitioning</strong></td>
<td>Disabled (Premium)</td>
<td>Optional</td>
</tr>
<tr>
<td><strong>Geo-DR</strong></td>
<td>Enabled</td>
<td>Disabled</td>
</tr>
</tbody>
</table>
<p><strong>Terraform Configuration (Environment-Aware):</strong></p>
<pre class="hcl"><code>resource &quot;azurerm_servicebus_namespace&quot; &quot;pem&quot; {
  name                          = &quot;sb-pem-${var.environment}&quot;
  resource_group_name           = azurerm_resource_group.messaging.name
  location                      = azurerm_resource_group.messaging.location
  sku                           = local.is_production ? &quot;Premium&quot; : &quot;Standard&quot;
  capacity                      = local.is_production ? 1 : 0
  zone_redundant                = local.is_production
  premium_messaging_partitions  = local.is_production ? 1 : 0
  minimum_tls_version           = &quot;1.2&quot;
  public_network_access_enabled = false
}</code></pre>
<p><strong>Queues and Topics:</strong></p>
<table>
<thead>
<tr>
<th>Resource</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>episode-processing</code></td>
<td>Queue</td>
<td>Episode lifecycle processing</td>
</tr>
<tr>
<td><code>bundle-calculation</code></td>
<td>Queue</td>
<td>Bundle price calculations</td>
</tr>
<tr>
<td><code>claim-association</code></td>
<td>Queue</td>
<td>Claim matching and association</td>
</tr>
<tr>
<td><code>notification-queue</code></td>
<td>Queue</td>
<td>Notifications and webhooks</td>
</tr>
<tr>
<td><code>episode-events</code></td>
<td>Topic</td>
<td>Event distribution to subscribers</td>
</tr>
</tbody>
</table>
<p><strong>Message Flow:</strong></p>
<pre class="mermaid"><code>%%{init: {&#39;theme&#39;: &#39;default&#39;}}%%
sequenceDiagram
    participant API as API Request
    participant SB as Service Bus
    participant Worker as Worker

    API-&gt;&gt;SB: POST /episodes
    SB-&gt;&gt;Worker: Message: CreateEpisode
    SB--&gt;&gt;API: 202 Accepted (EpisodeId)
    Worker-&gt;&gt;SB: Process Episode
    SB-&gt;&gt;Worker: Publish: EpisodeCreated</code></pre>
<hr />
<h3 id="api-gateway">API Gateway</h3>
<h4 id="azure-api-management">Azure API Management</h4>
<table>
<thead>
<tr>
<th>Configuration</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Tier</strong></td>
<td>Standard</td>
</tr>
<tr>
<td><strong>Policies</strong></td>
<td>Rate limiting, JWT validation, CORS</td>
</tr>
<tr>
<td><strong>Products</strong></td>
<td>Internal, Partner, Public</td>
</tr>
</tbody>
</table>
<p><strong>API Structure:</strong></p>
<pre><code>https://api.pem.example.com/
├── /v1/episodes                    → Episode API
│   ├── GET     /                   → List episodes
│   ├── POST    /                   → Create episode
│   ├── GET     /{id}               → Get episode
│   ├── PUT     /{id}               → Update episode
│   ├── DELETE  /{id}               → Delete episode
│   ├── POST    /{id}/claims        → Add claims
│   └── POST    /{id}/calculate     → Trigger bundle calculation
│
├── /v1/definitions                 → Definition API
│   ├── GET     /                   → List definitions
│   ├── POST    /                   → Create definition
│   ├── GET     /{id}               → Get definition
│   ├── PUT     /{id}               → Update definition
│   └── POST    /{id}/activate      → Activate definition
│
├── /v1/contracts                   → Contract Profile API
│   ├── GET     /                   → List contract profiles
│   ├── POST    /                   → Create contract profile
│   ├── GET     /{id}               → Get contract profile
│   ├── PUT     /{id}               → Update contract profile
│   └── GET     /{id}/definitions   → Get definitions for contract
│
├── /v1/modeling                    → Modeling API
│   ├── GET     /scenarios          → List modeling scenarios
│   ├── POST    /scenarios          → Create scenario
│   ├── GET     /scenarios/{id}     → Get scenario with results
│   ├── DELETE  /scenarios/{id}     → Delete scenario
│   ├── POST    /scenarios/{id}/run → Execute bundling for scenario
│   ├── GET     /scenarios/{id}/compare → Compare results across contracts
│   └── POST    /scenarios/{id}/export  → Export comparison report
│
├── /v1/worklists                   → Worklist API (Saved Searches)
│   ├── GET     /                   → List user&#39;s saved worklists
│   ├── POST    /                   → Save new worklist
│   ├── GET     /{id}               → Get worklist configuration
│   ├── PUT     /{id}               → Update worklist
│   ├── DELETE  /{id}               → Delete worklist
│   ├── POST    /{id}/rename        → Rename worklist
│   ├── GET     /shared             → List shared worklists
│   └── POST    /exists             → Check if worklist name exists
│
├── /v1/search                      → Search API (Worklist Data)
│   ├── POST    /episodes           → Search episodes (paginated)
│   ├── POST    /episodes/facets    → Get facet counts for filters
│   ├── POST    /episodes/export    → Export search results to CSV
│   └── GET     /columns            → Get available columns/definitions
│
└── /v1/reports                     → Reporting API
    ├── GET     /episodes/summary   → Episode summary
    ├── GET     /episodes/{id}      → Episode detail report
    └── POST    /episodes/export    → Export episodes</code></pre>
<hr />
<h3 id="security-services">Security Services</h3>
<h4 id="azure-ad-entra-id">Azure AD / Entra ID</h4>
<p><strong>Authentication Flow (Contract Manager to Azure
PEM):</strong></p>
<pre class="mermaid"><code>%%{init: {&#39;theme&#39;: &#39;default&#39;}}%%
sequenceDiagram
    participant User
    participant CM as Contract Manager
    participant AAD as Azure AD
    participant PEM as Azure PEM APIs

    User-&gt;&gt;CM: 1. Login to Contract Mgr
    CM-&gt;&gt;AAD: 2. Request token for Azure PEM
    AAD--&gt;&gt;CM: 3. Access token
    User-&gt;&gt;CM: 4. Access PEM Module
    CM-&gt;&gt;PEM: 5. API call with Bearer token
    PEM-&gt;&gt;AAD: 6. Validate token
    PEM--&gt;&gt;CM: 7. API Response
    CM--&gt;&gt;User: 8. Display PEM data in UI</code></pre>
<p><strong>Note:</strong> Contract Manager handles user authentication
and obtains tokens for Azure PEM API access. End users do not directly
authenticate with Azure AD for PEM access.</p>
<h4 id="azure-key-vault">Azure Key Vault</h4>
<p><strong>Secrets Stored:</strong> - Database connection strings -
Service Bus connection strings - Third-party API keys - Encryption
keys</p>
<p><strong>Access Pattern:</strong></p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In Program.cs</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Configuration</span><span class="op">.</span><span class="fu">AddAzureKeyVault</span><span class="op">(</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="fu">Uri</span><span class="op">(</span>$<span class="st">&quot;https://{keyVaultName}.vault.azure.net/&quot;</span><span class="op">),</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="fu">DefaultAzureCredential</span><span class="op">());</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">// In services</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> connectionString <span class="op">=</span> builder<span class="op">.</span><span class="fu">Configuration</span><span class="op">[</span><span class="st">&quot;ConnectionStrings:SqlDatabase&quot;</span><span class="op">];</span></span></code></pre></div>
<h4 id="azure-app-configuration-feature-flags">Azure App Configuration
(Feature Flags)</h4>
<p>Azure App Configuration provides centralized feature flag management,
enabling <strong>Deployment/Release separation</strong>:</p>
<ul>
<li><strong>Deployments</strong> are controlled by Engineering (code
deployed behind flags)</li>
<li><strong>Releases</strong> are controlled by Product Owners (toggle
flags to enable features)</li>
</ul>
<p><strong>Resources per Environment:</strong></p>
<table>
<colgroup>
<col style="width: 31%" />
<col style="width: 40%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Resource</th>
<th>Environment</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>appconfig-pem-nonprod</code></td>
<td>dev, qae (shared)</td>
<td>Feature flags for non-prod</td>
</tr>
<tr>
<td><code>appconfig-pem-uat</code></td>
<td>uat (isolated)</td>
<td>Feature flags for UAT</td>
</tr>
<tr>
<td><code>appconfig-pem-prod</code></td>
<td>prod (isolated)</td>
<td>Feature flags for production</td>
</tr>
</tbody>
</table>
<p><strong>Configuration (Program.cs):</strong></p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Configuration</span><span class="op">.</span><span class="fu">AddAzureAppConfiguration</span><span class="op">(</span>options <span class="op">=&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    options<span class="op">.</span><span class="fu">Connect</span><span class="op">(</span><span class="kw">new</span> <span class="fu">Uri</span><span class="op">(</span>appConfigEndpoint<span class="op">),</span> <span class="kw">new</span> <span class="fu">DefaultAzureCredential</span><span class="op">())</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>           <span class="op">.</span><span class="fu">UseFeatureFlags</span><span class="op">(</span>featureOptions <span class="op">=&gt;</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>           <span class="op">{</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>               featureOptions<span class="op">.</span><span class="fu">Label</span> <span class="op">=</span> builder<span class="op">.</span><span class="fu">Environment</span><span class="op">.</span><span class="fu">EnvironmentName</span><span class="op">;</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>               featureOptions<span class="op">.</span><span class="fu">CacheExpirationInterval</span> <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromSeconds</span><span class="op">(</span><span class="dv">30</span><span class="op">);</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>           <span class="op">});</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddFeatureManagement</span><span class="op">();</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddAzureAppConfiguration</span><span class="op">();</span></span></code></pre></div>
<p><strong>Usage in Endpoints:</strong></p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Entire endpoint protected by feature flag</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">FeatureGate</span><span class="op">(</span><span class="st">&quot;PEM.Modeling.ContractComparison&quot;</span><span class="op">)]</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> async Task<span class="op">&lt;</span>IActionResult<span class="op">&gt;</span> <span class="fu">CompareContracts</span><span class="op">(</span>CompareRequest request<span class="op">)</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Only accessible when feature is released</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Conditional logic within service</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="op">(</span>await _featureManager<span class="op">.</span><span class="fu">IsEnabledAsync</span><span class="op">(</span><span class="st">&quot;PEM.Worklist.AdvancedFilters&quot;</span><span class="op">))</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use advanced filtering logic</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Governance:</strong></p>
<table>
<thead>
<tr>
<th>Role</th>
<th>Access Level</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td>Developers</td>
<td>nonprod only</td>
<td>Create and test feature flags</td>
</tr>
<tr>
<td>QA Team</td>
<td>nonprod only</td>
<td>Toggle flags for testing</td>
</tr>
<tr>
<td>Product Owners</td>
<td>All environments</td>
<td>Control feature releases</td>
</tr>
<tr>
<td>SRE/Ops</td>
<td>prod (emergency)</td>
<td>Kill switch for problematic features</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="real-time-communication-azure-signalr-service">Real-Time
Communication (Azure SignalR Service)</h3>
<p>Azure PEM uses <strong>Azure SignalR Service</strong> to push
real-time updates to the Angular frontend, eliminating the need for
polling.</p>
<h4 id="signalr-architecture">SignalR Architecture</h4>
<p><strong>SignalR Real-Time Architecture</strong></p>
<pre class="mermaid"><code>%%{init: {&#39;theme&#39;: &#39;default&#39;}}%%
flowchart LR
    subgraph SPA[&quot;ANGULAR SPA (Browser)&quot;]
        HUB[&quot;EpisodeHub Service&quot;]
        STORE[&quot;WorklistStore&quot;]
        GRID[&quot;Grid Component&lt;br/&gt;(reflects UI)&quot;]
        HUB --&gt; STORE --&gt; GRID
    end

    subgraph SIGNALR[&quot;AZURE SIGNALR SERVICE&quot;]
        WS[&quot;Managed WebSocket&lt;br/&gt;100K+ connections&lt;br/&gt;Auto-scaling&lt;br/&gt;Reconnection&quot;]
    end

    subgraph BACKEND[&quot;BACKEND SERVICES&quot;]
        SB[&quot;Service Bus (Events)&quot;]
        FUNC[&quot;Azure Functions (Workers)&quot;]
        API[&quot;Episode API (Hub endpoint)&quot;]
        SB --&gt; FUNC --&gt; API
    end

    SPA &lt;--&gt;|&quot;WebSocket&quot;| SIGNALR
    SIGNALR &lt;--&gt;|&quot;Events&quot;| BACKEND
    API --&gt;|&quot;Broadcast to clients&quot;| SIGNALR</code></pre>
<h4 id="signalr-events-server-client">SignalR Events (Server →
Client)</h4>
<table style="width:100%;">
<colgroup>
<col style="width: 20%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Event</th>
<th>Trigger</th>
<th>Payload</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>EpisodeCreated</code></td>
<td>New episode created</td>
<td>Episode summary</td>
<td>Add row to worklist grid</td>
</tr>
<tr>
<td><code>EpisodeUpdated</code></td>
<td>Episode modified</td>
<td>Episode summary</td>
<td>Update row in grid</td>
</tr>
<tr>
<td><code>EpisodeStatusChanged</code></td>
<td>Status transition</td>
<td>Episode ID, old/new status</td>
<td>Update status badge</td>
</tr>
<tr>
<td><code>ClaimAssociated</code></td>
<td>Claim added to episode</td>
<td>Episode ID, claim count</td>
<td>Update claim count</td>
</tr>
<tr>
<td><code>BundleCalculated</code></td>
<td>Bundle pricing complete</td>
<td>Episode ID, amounts</td>
<td>Update financial columns</td>
</tr>
<tr>
<td><code>EpisodeDeleted</code></td>
<td>Episode removed</td>
<td>Episode ID</td>
<td>Remove row from grid</td>
</tr>
<tr>
<td><code>ModelingComplete</code></td>
<td>Scenario finished</td>
<td>Scenario ID, summary</td>
<td>Notify user, refresh results</td>
</tr>
</tbody>
</table>
<h4 id="hub-implementation-.net">Hub Implementation (.NET)</h4>
<div class="sourceCode" id="cb29"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">// EpisodeHub.cs</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> EpisodeHub <span class="op">:</span> Hub</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">override</span> async Task <span class="fu">OnConnectedAsync</span><span class="op">()</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add user to their organization group for targeted broadcasts</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> orgId <span class="op">=</span> Context<span class="op">.</span><span class="fu">User</span><span class="op">?.</span><span class="fu">FindFirst</span><span class="op">(</span><span class="st">&quot;org_id&quot;</span><span class="op">)?.</span><span class="fu">Value</span><span class="op">;</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(!</span><span class="dt">string</span><span class="op">.</span><span class="fu">IsNullOrEmpty</span><span class="op">(</span>orgId<span class="op">))</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>            await Groups<span class="op">.</span><span class="fu">AddToGroupAsync</span><span class="op">(</span>Context<span class="op">.</span><span class="fu">ConnectionId</span><span class="op">,</span> $<span class="st">&quot;org-{orgId}&quot;</span><span class="op">);</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>        await <span class="kw">base</span><span class="op">.</span><span class="fu">OnConnectedAsync</span><span class="op">();</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Client can subscribe to specific episode updates</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">SubscribeToEpisode</span><span class="op">(</span>Guid episodeId<span class="op">)</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>        await Groups<span class="op">.</span><span class="fu">AddToGroupAsync</span><span class="op">(</span>Context<span class="op">.</span><span class="fu">ConnectionId</span><span class="op">,</span> $<span class="st">&quot;episode-{episodeId}&quot;</span><span class="op">);</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">UnsubscribeFromEpisode</span><span class="op">(</span>Guid episodeId<span class="op">)</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>        await Groups<span class="op">.</span><span class="fu">RemoveFromGroupAsync</span><span class="op">(</span>Context<span class="op">.</span><span class="fu">ConnectionId</span><span class="op">,</span> $<span class="st">&quot;episode-{episodeId}&quot;</span><span class="op">);</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="co">// Broadcasting from API/Worker</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> EpisodeNotificationService</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">readonly</span> IHubContext<span class="op">&lt;</span>EpisodeHub<span class="op">&gt;</span> _hubContext<span class="op">;</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> async Task <span class="fu">NotifyEpisodeUpdatedAsync</span><span class="op">(</span>Episode episode<span class="op">)</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Broadcast to all users in the organization</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>        await _hubContext<span class="op">.</span><span class="fu">Clients</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">Group</span><span class="op">(</span>$<span class="st">&quot;org-{episode.TenantId}&quot;</span><span class="op">)</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">SendAsync</span><span class="op">(</span><span class="st">&quot;EpisodeUpdated&quot;</span><span class="op">,</span> <span class="kw">new</span> <span class="fu">EpisodeSummaryDto</span><span class="op">(</span>episode<span class="op">));</span></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Also notify anyone specifically watching this episode</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>        await _hubContext<span class="op">.</span><span class="fu">Clients</span></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">Group</span><span class="op">(</span>$<span class="st">&quot;episode-{episode.Id}&quot;</span><span class="op">)</span></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">SendAsync</span><span class="op">(</span><span class="st">&quot;EpisodeUpdated&quot;</span><span class="op">,</span> <span class="kw">new</span> <span class="fu">EpisodeSummaryDto</span><span class="op">(</span>episode<span class="op">));</span></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="angular-client-implementation">Angular Client
Implementation</h4>
<div class="sourceCode" id="cb30"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">// services/episode-hub.service.ts</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>@<span class="fu">Injectable</span>({ providedIn<span class="op">:</span> <span class="st">&#39;root&#39;</span> })</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">class</span> EpisodeHubService <span class="kw">extends</span> SubscriberBase {</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">private</span> hubConnection<span class="op">:</span> signalR<span class="op">.</span><span class="at">HubConnection</span> <span class="op">|</span> <span class="dt">null</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Event streams for components to subscribe to</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">public</span> <span class="kw">readonly</span> episodeCreated$ <span class="op">=</span> <span class="kw">new</span> <span class="fu">Subject</span><span class="op">&lt;</span>EpisodeSummary<span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">public</span> <span class="kw">readonly</span> episodeUpdated$ <span class="op">=</span> <span class="kw">new</span> <span class="fu">Subject</span><span class="op">&lt;</span>EpisodeSummary<span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">public</span> <span class="kw">readonly</span> episodeStatusChanged$ <span class="op">=</span> <span class="kw">new</span> <span class="fu">Subject</span><span class="op">&lt;</span>StatusChangeEvent<span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">public</span> <span class="kw">readonly</span> bundleCalculated$ <span class="op">=</span> <span class="kw">new</span> <span class="fu">Subject</span><span class="op">&lt;</span>BundleCalculatedEvent<span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">public</span> <span class="kw">readonly</span> connectionState$ <span class="op">=</span> <span class="kw">new</span> <span class="fu">BehaviorSubject</span><span class="op">&lt;</span>HubConnectionState<span class="op">&gt;</span>(</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    HubConnectionState<span class="op">.</span><span class="at">Disconnected</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">constructor</span>(</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> authService<span class="op">:</span> AuthService<span class="op">,</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> configService<span class="op">:</span> ConfigService<span class="op">,</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> logService<span class="op">:</span> LoggingService</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  ) {</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">public</span> <span class="kw">async</span> <span class="fu">connect</span>()<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> {</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> token <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="at">authService</span><span class="op">.</span><span class="fu">getAccessToken</span>()<span class="op">;</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">hubConnection</span> <span class="op">=</span> <span class="kw">new</span> signalR<span class="op">.</span><span class="fu">HubConnectionBuilder</span>()</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">withUrl</span>(<span class="vs">`</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">configService</span><span class="op">.</span><span class="at">apiBaseUrl</span><span class="sc">}</span><span class="vs">/hubs/episodes`</span><span class="op">,</span> {</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>        accessTokenFactory<span class="op">:</span> () <span class="kw">=&gt;</span> token</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">withAutomaticReconnect</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">2000</span><span class="op">,</span> <span class="dv">5000</span><span class="op">,</span> <span class="dv">10000</span><span class="op">,</span> <span class="dv">30000</span>])</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">configureLogging</span>(signalR<span class="op">.</span><span class="at">LogLevel</span><span class="op">.</span><span class="at">Warning</span>)</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">build</span>()<span class="op">;</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">registerEventHandlers</span>()<span class="op">;</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="at">hubConnection</span><span class="op">.</span><span class="fu">start</span>()<span class="op">;</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">connectionState$</span><span class="op">.</span><span class="fu">next</span>(HubConnectionState<span class="op">.</span><span class="at">Connected</span>)<span class="op">;</span></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">logService</span><span class="op">.</span><span class="fu">info</span>(<span class="st">&#39;SignalR connected&#39;</span>)<span class="op">;</span></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (err) {</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">logService</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;SignalR connection failed&#39;</span><span class="op">,</span> err)<span class="op">;</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> err<span class="op">;</span></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>  <span class="kw">private</span> <span class="fu">registerEventHandlers</span>()<span class="op">:</span> <span class="dt">void</span> {</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">hubConnection</span><span class="op">!.</span><span class="fu">on</span>(<span class="st">&#39;EpisodeCreated&#39;</span><span class="op">,</span> (episode<span class="op">:</span> EpisodeSummary) <span class="kw">=&gt;</span> {</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">episodeCreated$</span><span class="op">.</span><span class="fu">next</span>(episode)<span class="op">;</span></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">hubConnection</span><span class="op">!.</span><span class="fu">on</span>(<span class="st">&#39;EpisodeUpdated&#39;</span><span class="op">,</span> (episode<span class="op">:</span> EpisodeSummary) <span class="kw">=&gt;</span> {</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">episodeUpdated$</span><span class="op">.</span><span class="fu">next</span>(episode)<span class="op">;</span></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">hubConnection</span><span class="op">!.</span><span class="fu">on</span>(<span class="st">&#39;EpisodeStatusChanged&#39;</span><span class="op">,</span> (event<span class="op">:</span> StatusChangeEvent) <span class="kw">=&gt;</span> {</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">episodeStatusChanged$</span><span class="op">.</span><span class="fu">next</span>(<span class="bu">event</span>)<span class="op">;</span></span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">hubConnection</span><span class="op">!.</span><span class="fu">on</span>(<span class="st">&#39;BundleCalculated&#39;</span><span class="op">,</span> (event<span class="op">:</span> BundleCalculatedEvent) <span class="kw">=&gt;</span> {</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">bundleCalculated$</span><span class="op">.</span><span class="fu">next</span>(<span class="bu">event</span>)<span class="op">;</span></span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">hubConnection</span><span class="op">!.</span><span class="fu">onreconnecting</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">connectionState$</span><span class="op">.</span><span class="fu">next</span>(HubConnectionState<span class="op">.</span><span class="at">Reconnecting</span>)<span class="op">;</span></span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">hubConnection</span><span class="op">!.</span><span class="fu">onreconnected</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">connectionState$</span><span class="op">.</span><span class="fu">next</span>(HubConnectionState<span class="op">.</span><span class="at">Connected</span>)<span class="op">;</span></span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a>  <span class="kw">public</span> <span class="kw">async</span> <span class="fu">subscribeToEpisode</span>(episodeId<span class="op">:</span> <span class="dt">string</span>)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> {</span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="at">hubConnection</span><span class="op">?.</span><span class="fu">invoke</span>(<span class="st">&#39;SubscribeToEpisode&#39;</span><span class="op">,</span> episodeId)<span class="op">;</span></span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h4 id="integration-with-worklist-grid">Integration with Worklist
Grid</h4>
<div class="sourceCode" id="cb31"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">// worklist.component.ts (following Contract Manager patterns)</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>@<span class="fu">Component</span>({</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  selector<span class="op">:</span> <span class="st">&#39;app-episode-worklist&#39;</span><span class="op">,</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  changeDetection<span class="op">:</span> ChangeDetectionStrategy<span class="op">.</span><span class="at">OnPush</span><span class="op">,</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  providers<span class="op">:</span> [<span class="co">/* ... */</span>]</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">class</span> EpisodeWorklistComponent <span class="kw">extends</span> SubscriberBase <span class="kw">implements</span> OnInit {</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">constructor</span>(</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> store<span class="op">:</span> WorklistStore<span class="op">,</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> hubService<span class="op">:</span> EpisodeHubService<span class="op">,</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> snackBar<span class="op">:</span> SnackBarService</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  ) {</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ngOnInit</span>()<span class="op">:</span> <span class="dt">void</span> {</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Real-time: New episode appears in grid</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">hubService</span><span class="op">.</span><span class="at">episodeCreated$</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">pipe</span>(<span class="fu">takeUntil</span>(<span class="kw">this</span><span class="op">.</span><span class="at">destroyed$</span>))</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">subscribe</span>(episode <span class="kw">=&gt;</span> {</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">store</span><span class="op">.</span><span class="fu">addEpisodeToGrid</span>(episode)<span class="op">;</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">snackBar</span><span class="op">.</span><span class="fu">openInfoSnack</span>(<span class="vs">`New episode created: </span><span class="sc">${</span>episode<span class="op">.</span><span class="at">patientName</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Real-time: Episode updates reflect immediately</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">hubService</span><span class="op">.</span><span class="at">episodeUpdated$</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">pipe</span>(<span class="fu">takeUntil</span>(<span class="kw">this</span><span class="op">.</span><span class="at">destroyed$</span>))</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">subscribe</span>(episode <span class="kw">=&gt;</span> {</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">store</span><span class="op">.</span><span class="fu">updateEpisodeInGrid</span>(episode)<span class="op">;</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Real-time: Bundle calculation complete</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">hubService</span><span class="op">.</span><span class="at">bundleCalculated$</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">pipe</span>(<span class="fu">takeUntil</span>(<span class="kw">this</span><span class="op">.</span><span class="at">destroyed$</span>))</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">subscribe</span>(<span class="bu">event</span> <span class="kw">=&gt;</span> {</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">store</span><span class="op">.</span><span class="fu">updateEpisodeBundleAmount</span>(<span class="bu">event</span><span class="op">.</span><span class="at">episodeId</span><span class="op">,</span> <span class="bu">event</span><span class="op">.</span><span class="at">bundleAmount</span>)<span class="op">;</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h4 id="azure-signalr-service-configuration">Azure SignalR Service
Configuration</h4>
<table>
<thead>
<tr>
<th>Configuration</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>SKU</strong></td>
<td>Standard (100 concurrent connections per unit)</td>
</tr>
<tr>
<td><strong>Units</strong></td>
<td>1 (dev/qae), 2 (uat), 5 (prod)</td>
</tr>
<tr>
<td><strong>Service Mode</strong></td>
<td>Default (Hub hosted in App Service)</td>
</tr>
<tr>
<td><strong>Connectivity</strong></td>
<td>Public endpoint with AAD auth</td>
</tr>
</tbody>
</table>
<p><strong>Terraform:</strong></p>
<pre class="hcl"><code>resource &quot;azurerm_signalr_service&quot; &quot;pem&quot; {
  name                = &quot;pem-signalr-${var.environment}&quot;
  location            = azurerm_resource_group.main.location
  resource_group_name = azurerm_resource_group.main.name

  sku {
    name     = &quot;Standard_S1&quot;
    capacity = var.environment == &quot;prod&quot; ? 5 : 1
  }

  cors {
    allowed_origins = var.allowed_origins
  }

  upstream_endpoint {
    category_pattern = [&quot;*&quot;]
    event_pattern    = [&quot;*&quot;]
    hub_pattern      = [&quot;*&quot;]
    url_template     = &quot;https://${var.api_hostname}/hubs/episodes&quot;
  }
}</code></pre>
<hr />
<h3 id="monitoring-observability">Monitoring &amp; Observability</h3>
<h4 id="application-insights">Application Insights</h4>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td>Request tracking</td>
<td>API performance</td>
</tr>
<tr>
<td>Dependency tracking</td>
<td>Database, Service Bus</td>
</tr>
<tr>
<td>Custom metrics</td>
<td>Episode counts, processing times</td>
</tr>
<tr>
<td>Alerts</td>
<td>Error rates, latency thresholds</td>
</tr>
<tr>
<td>Live metrics</td>
<td>Real-time monitoring</td>
</tr>
</tbody>
</table>
<p><strong>Instrumentation:</strong></p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Program.cs</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>builder<span class="op">.</span><span class="fu">Services</span><span class="op">.</span><span class="fu">AddApplicationInsightsTelemetry</span><span class="op">();</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Custom metrics</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>_telemetry<span class="op">.</span><span class="fu">TrackMetric</span><span class="op">(</span><span class="st">&quot;EpisodeCreated&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> Dictionary<span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">string</span><span class="op">&gt;</span> <span class="op">{</span> <span class="op">[</span><span class="st">&quot;DefinitionType&quot;</span><span class="op">]</span> <span class="op">=</span> definition<span class="op">.</span><span class="fu">Name</span> <span class="op">});</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>_telemetry<span class="op">.</span><span class="fu">TrackEvent</span><span class="op">(</span><span class="st">&quot;BundleCalculated&quot;</span><span class="op">,</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> Dictionary<span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">string</span><span class="op">&gt;</span> </span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> </span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span><span class="st">&quot;EpisodeId&quot;</span><span class="op">]</span> <span class="op">=</span> episode<span class="op">.</span><span class="fu">Id</span><span class="op">.</span><span class="fu">ToString</span><span class="op">(),</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span><span class="st">&quot;Amount&quot;</span><span class="op">]</span> <span class="op">=</span> bundle<span class="op">.</span><span class="fu">Amount</span><span class="op">.</span><span class="fu">ToString</span><span class="op">()</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span></code></pre></div>
<h4 id="log-analytics">Log Analytics</h4>
<table>
<thead>
<tr>
<th>Data Source</th>
<th>Retention</th>
</tr>
</thead>
<tbody>
<tr>
<td>Application logs</td>
<td>30 days</td>
</tr>
<tr>
<td>Audit logs</td>
<td>1 year</td>
</tr>
<tr>
<td>Metrics</td>
<td>90 days</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="network-architecture">Network Architecture</h2>
<h3 id="environment-accessibility">Environment Accessibility</h3>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 26%" />
<col style="width: 26%" />
<col style="width: 19%" />
</colgroup>
<thead>
<tr>
<th>Environment</th>
<th>API Access</th>
<th>SPA Access</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>dev</strong></td>
<td>Internal only (VPN/VNet)</td>
<td>Internal only</td>
<td>Development testing</td>
</tr>
<tr>
<td><strong>qae</strong></td>
<td>Internal only (VPN/VNet)</td>
<td>Internal only</td>
<td>QA/Engineering testing</td>
</tr>
<tr>
<td><strong>uat</strong></td>
<td><strong>Public internet</strong></td>
<td><strong>Public internet</strong></td>
<td>User acceptance testing</td>
</tr>
<tr>
<td><strong>prod</strong></td>
<td><strong>Public internet</strong></td>
<td><strong>Public internet</strong></td>
<td>Production</td>
</tr>
</tbody>
</table>
<p><strong>Internal Environments (dev, qae):</strong> - Protected by
Azure Front Door with IP restrictions - Accessible only via corporate
VPN or Azure VNet peering - Used by development and QA teams</p>
<p><strong>Public Environments (uat, prod):</strong> - Accessible from
public internet - Protected by Azure Front Door WAF - Azure AD
authentication required - Rate limiting and DDoS protection enabled</p>
<h3 id="virtual-network-design">Virtual Network Design</h3>
<pre class="mermaid"><code>%%{init: {&#39;theme&#39;: &#39;default&#39;}}%%
flowchart TB
    subgraph VNET[&quot;VNET: pem-vnet-{env} (10.0.0.0/16)&quot;]
        subgraph APP[&quot;Subnet: app-subnet (10.0.1.0/24)&quot;]
            AS[&quot;App Service VNet Integration&quot;]
            AF[&quot;Azure Functions VNet Integration&quot;]
        end

        subgraph DATA[&quot;Subnet: data-subnet (10.0.2.0/24)&quot;]
            SQL_PE[&quot;Azure SQL Private Endpoint&quot;]
            COSMOS_PE[&quot;Cosmos DB Private Endpoint&quot;]
            REDIS_PE[&quot;Redis Private Endpoint&quot;]
            STORAGE_PE[&quot;Storage Private Endpoint&quot;]
        end

        subgraph INTEGRATION[&quot;Subnet: integration-subnet (10.0.3.0/24)&quot;]
            SB_PE[&quot;Service Bus Private Endpoint&quot;]
            APIM_PE[&quot;API Management (if Premium)&quot;]
        end
    end</code></pre>
<h3 id="front-door-configuration-by-environment">Front Door
Configuration by Environment</h3>
<table>
<colgroup>
<col style="width: 22%" />
<col style="width: 21%" />
<col style="width: 29%" />
<col style="width: 26%" />
</colgroup>
<thead>
<tr>
<th>Environment</th>
<th>WAF Policy</th>
<th>IP Restrictions</th>
<th>Custom Domain</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>dev</strong></td>
<td>Detection mode</td>
<td>Corporate IPs only</td>
<td>pem-dev.internal.finthrive.com</td>
</tr>
<tr>
<td><strong>qae</strong></td>
<td>Detection mode</td>
<td>Corporate IPs only</td>
<td>pem-qae.internal.finthrive.com</td>
</tr>
<tr>
<td><strong>uat</strong></td>
<td>Prevention mode</td>
<td>None (public)</td>
<td>pem-uat.finthrive.com</td>
</tr>
<tr>
<td><strong>prod</strong></td>
<td>Prevention mode</td>
<td>None (public)</td>
<td>pem.finthrive.com</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="on-premises-to-azure-connectivity">On-Premises to Azure
Connectivity</h2>
<p>This section details the network connectivity architecture between
the on-premises Contract Manager infrastructure and Azure PEM services.
The design leverages the existing <strong>ExpressRoute</strong> circuit
for secure, low-latency, high-bandwidth connectivity.</p>
<h3 id="connectivity-architecture-overview">Connectivity Architecture
Overview</h3>
<p><strong>ExpressRoute Network Architecture</strong></p>
<pre class="mermaid"><code>%%{init: {&#39;theme&#39;: &#39;default&#39;}}%%
flowchart TB
    subgraph ONPREM[&quot;ON-PREMISES DATA CENTER&quot;]
        subgraph APPSERVERS[&quot;APPLICATION SERVERS&quot;]
            CM_SRV[&quot;Contract Manager Servers&quot;]
            CS_SRV[&quot;ClaimShop Servers&quot;]
        end
        subgraph CORP[&quot;CORPORATE NETWORK&quot;]
            FW[&quot;On-Prem Firewall&quot;]
            ROUTER[&quot;Edge Router&quot;]
        end
        APPSERVERS --&gt; FW --&gt; ROUTER
    end

    subgraph ER[&quot;EXPRESSROUTE&quot;]
        ER_CIRCUIT[&quot;ExpressRoute Circuit&lt;br/&gt;(Primary + Secondary)&quot;]
    end

    subgraph AZURE[&quot;AZURE&quot;]
        subgraph HUB[&quot;HUB VNET (Connectivity)&quot;]
            AZ_FW[&quot;Azure Firewall&lt;br/&gt;(Central Egress)&quot;]
            ER_GW[&quot;ExpressRoute Gateway&quot;]
        end

        subgraph SPOKE[&quot;PEM VNET (Spoke)&quot;]
            subgraph PRIVATE[&quot;Private Endpoints&quot;]
                PE_APIM[&quot;API Management PE&quot;]
                PE_SQL[&quot;SQL Private Endpoint&quot;]
                PE_COSMOS[&quot;Cosmos DB Private Endpoint&quot;]
                PE_REDIS[&quot;Redis Private Endpoint&quot;]
                PE_SB[&quot;Service Bus Private Endpoint&quot;]
            end

            subgraph COMPUTE[&quot;Compute (VNet Integrated)&quot;]
                APP[&quot;App Services&quot;]
                FUNC[&quot;Functions&quot;]
            end
        end
    end

    ROUTER &lt;--&gt;|&quot;ExpressRoute&lt;br/&gt;Private Peering&quot;| ER_CIRCUIT
    ER_CIRCUIT &lt;--&gt; ER_GW
    ER_GW &lt;--&gt; AZ_FW
    AZ_FW &lt;--&gt;|&quot;VNet Peering&quot;| SPOKE</code></pre>
<h3 id="expressroute-configuration">ExpressRoute Configuration</h3>
<h4 id="circuit-specifications">Circuit Specifications</h4>
<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 27%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr>
<th>Specification</th>
<th>Production</th>
<th>Non-Production</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Circuit SKU</strong></td>
<td>Premium</td>
<td>Standard</td>
</tr>
<tr>
<td><strong>Bandwidth</strong></td>
<td>1 Gbps (scalable to 10 Gbps)</td>
<td>200 Mbps (shared)</td>
</tr>
<tr>
<td><strong>Peering Type</strong></td>
<td>Private Peering</td>
<td>Private Peering</td>
</tr>
<tr>
<td><strong>Redundancy</strong></td>
<td>Dual circuits (primary + secondary)</td>
<td>Single circuit</td>
</tr>
<tr>
<td><strong>Global Reach</strong></td>
<td>Enabled (if multi-region DR needed)</td>
<td>Disabled</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Note:</strong> PEM uses the existing corporate ExpressRoute
circuit. Coordinate with Network Operations to ensure sufficient
bandwidth allocation for PEM traffic.</p>
</blockquote>
<h4 id="expressroute-gateway-configuration">ExpressRoute Gateway
Configuration</h4>
<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 27%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr>
<th>Configuration</th>
<th>Production</th>
<th>Non-Production</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Gateway SKU</strong></td>
<td>ErGw3AZ (Zone-redundant)</td>
<td>ErGw1Az</td>
</tr>
<tr>
<td><strong>Throughput</strong></td>
<td>Up to 10 Gbps</td>
<td>Up to 1 Gbps</td>
</tr>
<tr>
<td><strong>Zone Redundancy</strong></td>
<td>✅ Enabled</td>
<td>❌ Disabled</td>
</tr>
<tr>
<td><strong>FastPath</strong></td>
<td>✅ Enabled (bypasses gateway for data plane)</td>
<td>❌ Disabled</td>
</tr>
</tbody>
</table>
<h4 id="network-address-space">Network Address Space</h4>
<table>
<colgroup>
<col style="width: 37%" />
<col style="width: 25%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr>
<th>Network</th>
<th>CIDR</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>On-Premises Corporate</strong></td>
<td>10.x.x.x/8 (existing)</td>
<td>Corporate data center</td>
</tr>
<tr>
<td><strong>Contract Manager Servers</strong></td>
<td>(existing subnet)</td>
<td>CM application tier</td>
</tr>
<tr>
<td><strong>ClaimShop Servers</strong></td>
<td>(existing subnet)</td>
<td>Claims data source</td>
</tr>
<tr>
<td><strong>Azure Hub VNet</strong></td>
<td>10.200.0.0/16</td>
<td>Connectivity hub</td>
</tr>
<tr>
<td><strong>Azure PEM VNet (Prod)</strong></td>
<td>10.201.0.0/16</td>
<td>Production workloads</td>
</tr>
<tr>
<td><strong>Azure PEM VNet (Non-Prod)</strong></td>
<td>10.202.0.0/16</td>
<td>Dev/QAE/UAT workloads</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Important:</strong> Verify no IP address overlap between
on-premises and Azure networks before provisioning. Coordinate with
Network Operations for address allocation.</p>
</blockquote>
<hr />
<h3 id="latency-requirements-and-expectations">Latency Requirements and
Expectations</h3>
<h4 id="latency-budget-breakdown">Latency Budget Breakdown</h4>
<p><strong>End-to-End Latency Budget - Target: &lt; 200ms
P95</strong></p>
<pre><code>Contract Manager ──► On-Prem Network ──► ExpressRoute ──► Azure Network ──► API Management ──► App Service ──► Database
     (~20ms)            (~5ms)           (~10-30ms)         (~5ms)           (~10ms)          (~50-100ms)    (~20-50ms)</code></pre>
<h4 id="latency-targets-by-operation">Latency Targets by Operation</h4>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Target Latency (P95)</th>
<th>Network Portion</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>API Health Check</strong></td>
<td>&lt; 50ms</td>
<td>~40ms</td>
<td>Minimal processing</td>
</tr>
<tr>
<td><strong>Episode Search</strong></td>
<td>&lt; 200ms</td>
<td>~50ms</td>
<td>Includes SQL query</td>
</tr>
<tr>
<td><strong>Episode Detail</strong></td>
<td>&lt; 150ms</td>
<td>~50ms</td>
<td>Cached in Redis</td>
</tr>
<tr>
<td><strong>Create Episode</strong></td>
<td>&lt; 300ms</td>
<td>~50ms</td>
<td>Write operation</td>
</tr>
<tr>
<td><strong>Bundle Calculation</strong></td>
<td>&lt; 2s</td>
<td>~50ms</td>
<td>CPU-intensive</td>
</tr>
<tr>
<td><strong>Bulk Claim Ingestion</strong></td>
<td>&lt; 5s per batch</td>
<td>~100ms</td>
<td>Large payload</td>
</tr>
<tr>
<td><strong>SignalR Connection</strong></td>
<td>&lt; 100ms</td>
<td>~50ms</td>
<td>WebSocket upgrade</td>
</tr>
</tbody>
</table>
<h4 id="latency-monitoring-query-application-insights">Latency
Monitoring Query (Application Insights)</h4>
<pre class="kusto"><code>dependencies
| where timestamp &gt; ago(1h)
| where type == &quot;HTTP&quot; and target contains &quot;pem&quot;
| summarize 
    avg_latency = avg(duration),
    p50_latency = percentile(duration, 50),
    p95_latency = percentile(duration, 95),
    p99_latency = percentile(duration, 99)
  by bin(timestamp, 5m)
| render timechart</code></pre>
<hr />
<h3 id="private-endpoints-strategy">Private Endpoints Strategy</h3>
<p>All Azure PEM services are accessed via <strong>Private
Endpoints</strong>, ensuring traffic between on-premises and Azure never
traverses the public internet.</p>
<h4 id="why-private-endpoints">Why Private Endpoints?</h4>
<table>
<colgroup>
<col style="width: 40%" />
<col style="width: 59%" />
</colgroup>
<thead>
<tr>
<th>Benefit</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Security</strong></td>
<td>Traffic stays on Microsoft backbone via ExpressRoute</td>
</tr>
<tr>
<td><strong>Compliance</strong></td>
<td>PHI/healthcare data never exposed to public networks</td>
</tr>
<tr>
<td><strong>Performance</strong></td>
<td>Lower latency than public endpoints</td>
</tr>
<tr>
<td><strong>Simplified Firewall</strong></td>
<td>No need to allowlist public IPs</td>
</tr>
</tbody>
</table>
<h4 id="private-endpoint-configuration">Private Endpoint
Configuration</h4>
<table style="width:100%;">
<colgroup>
<col style="width: 25%" />
<col style="width: 30%" />
<col style="width: 30%" />
<col style="width: 13%" />
</colgroup>
<thead>
<tr>
<th>Azure Service</th>
<th>Private Endpoint</th>
<th>Private DNS Zone</th>
<th>Subnet</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>API Management</strong></td>
<td><code>pe-apim-pem-{env}</code></td>
<td><code>privatelink.azure-api.net</code></td>
<td>integration-subnet</td>
</tr>
<tr>
<td><strong>Azure SQL</strong></td>
<td><code>pe-sql-pem-{env}</code></td>
<td><code>privatelink.database.windows.net</code></td>
<td>data-subnet</td>
</tr>
<tr>
<td><strong>Cosmos DB</strong></td>
<td><code>pe-cosmos-pem-{env}</code></td>
<td><code>privatelink.documents.azure.com</code></td>
<td>data-subnet</td>
</tr>
<tr>
<td><strong>Redis Cache</strong></td>
<td><code>pe-redis-pem-{env}</code></td>
<td><code>privatelink.redis.cache.windows.net</code></td>
<td>data-subnet</td>
</tr>
<tr>
<td><strong>Service Bus</strong></td>
<td><code>pe-sb-pem-{env}</code></td>
<td><code>privatelink.servicebus.windows.net</code></td>
<td>integration-subnet</td>
</tr>
<tr>
<td><strong>Storage Account</strong></td>
<td><code>pe-storage-pem-{env}</code></td>
<td><code>privatelink.blob.core.windows.net</code></td>
<td>data-subnet</td>
</tr>
<tr>
<td><strong>Key Vault</strong></td>
<td><code>pe-kv-pem-{env}</code></td>
<td><code>privatelink.vaultcore.azure.net</code></td>
<td>data-subnet</td>
</tr>
<tr>
<td><strong>SignalR Service</strong></td>
<td><code>pe-signalr-pem-{env}</code></td>
<td><code>privatelink.service.signalr.net</code></td>
<td>integration-subnet</td>
</tr>
<tr>
<td><strong>App Configuration</strong></td>
<td><code>pe-appconfig-pem-{env}</code></td>
<td><code>privatelink.azconfig.io</code></td>
<td>data-subnet</td>
</tr>
</tbody>
</table>
<h4 id="private-dns-resolution">Private DNS Resolution</h4>
<p><strong>DNS Resolution Flow</strong></p>
<pre class="mermaid"><code>%%{init: {&#39;theme&#39;: &#39;default&#39;}}%%
flowchart LR
    subgraph ONPREM[&quot;ON-PREMISES&quot;]
        CM[&quot;Contract Manager&quot;]
        DNS[&quot;On-Prem DNS&lt;br/&gt;(Conditional Forwarder)&quot;]
        CM --&gt;|&quot;api-pem.azure-api.net&quot;| DNS
    end

    subgraph AZURE[&quot;AZURE&quot;]
        AZ_DNS[&quot;Azure DNS Private Resolver&quot;]
        ZONES[&quot;Private DNS Zones&lt;br/&gt;(*.privatelink.*)&quot;]
        PE[&quot;Private Endpoints&lt;br/&gt;(10.201.x.x)&quot;]
        AZ_DNS --&gt; ZONES --&gt;|&quot;Resolves to private IP&quot;| PE
    end

    DNS --&gt;|&quot;Forward to Azure&quot;| AZ_DNS</code></pre>
<p><strong>DNS Configuration Requirements:</strong></p>
<p>On-Premises DNS Servers must have <strong>conditional
forwarders</strong> for Azure Private DNS zones pointing to the Azure
DNS Private Resolver:</p>
<table>
<thead>
<tr>
<th>DNS Zone</th>
<th>Forward To</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>*.database.windows.net</code></td>
<td>Azure DNS Private Resolver IP</td>
</tr>
<tr>
<td><code>*.redis.cache.windows.net</code></td>
<td>Azure DNS Private Resolver IP</td>
</tr>
<tr>
<td><code>*.servicebus.windows.net</code></td>
<td>Azure DNS Private Resolver IP</td>
</tr>
<tr>
<td><code>*.azure-api.net</code></td>
<td>Azure DNS Private Resolver IP</td>
</tr>
<tr>
<td><code>*.blob.core.windows.net</code></td>
<td>Azure DNS Private Resolver IP</td>
</tr>
<tr>
<td><code>*.vaultcore.azure.net</code></td>
<td>Azure DNS Private Resolver IP</td>
</tr>
<tr>
<td><code>*.signalr.net</code></td>
<td>Azure DNS Private Resolver IP</td>
</tr>
<tr>
<td><code>*.azconfig.io</code></td>
<td>Azure DNS Private Resolver IP</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Action Required:</strong> Coordinate with Network Operations
to configure conditional forwarders on corporate DNS servers.</p>
</blockquote>
<hr />
<h3 id="firewall-rules-and-network-security-groups">Firewall Rules and
Network Security Groups</h3>
<h4 id="on-premises-firewall-rules-outbound-to-azure">On-Premises
Firewall Rules (Outbound to Azure)</h4>
<table>
<colgroup>
<col style="width: 11%" />
<col style="width: 15%" />
<col style="width: 25%" />
<col style="width: 11%" />
<col style="width: 19%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr>
<th>Rule</th>
<th>Source</th>
<th>Destination</th>
<th>Port</th>
<th>Protocol</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>HTTPS to Azure PEM</strong></td>
<td>CM Servers</td>
<td>Azure PEM VNet (10.201.0.0/16)</td>
<td>443</td>
<td>TCP</td>
<td>API calls</td>
</tr>
<tr>
<td><strong>SignalR WebSocket</strong></td>
<td>CM Servers</td>
<td>Azure PEM VNet (10.201.0.0/16)</td>
<td>443</td>
<td>TCP (WSS)</td>
<td>Real-time updates</td>
</tr>
<tr>
<td><strong>DNS to Azure</strong></td>
<td>On-Prem DNS Servers</td>
<td>Azure DNS Resolver</td>
<td>53</td>
<td>UDP/TCP</td>
<td>Private DNS resolution</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Note:</strong> Since traffic flows over ExpressRoute Private
Peering, no public internet rules are required.</p>
</blockquote>
<h4 id="azure-network-security-groups-nsgs">Azure Network Security
Groups (NSGs)</h4>
<p><strong>NSG: nsg-pem-app-{env}</strong> (Applied to app-subnet)</p>
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 9%" />
<col style="width: 17%" />
<col style="width: 12%" />
<col style="width: 20%" />
<col style="width: 9%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr>
<th>Priority</th>
<th>Name</th>
<th>Direction</th>
<th>Source</th>
<th>Destination</th>
<th>Port</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>100</td>
<td>AllowOnPremHttps</td>
<td>Inbound</td>
<td>10.0.0.0/8</td>
<td>VirtualNetwork</td>
<td>443</td>
<td>Allow</td>
</tr>
<tr>
<td>110</td>
<td>AllowAzureFrontDoor</td>
<td>Inbound</td>
<td>AzureFrontDoor.Backend</td>
<td>VirtualNetwork</td>
<td>443</td>
<td>Allow</td>
</tr>
<tr>
<td>120</td>
<td>AllowHealthProbes</td>
<td>Inbound</td>
<td>AzureLoadBalancer</td>
<td>VirtualNetwork</td>
<td>443</td>
<td>Allow</td>
</tr>
<tr>
<td>200</td>
<td>AllowVNetInternal</td>
<td>Inbound</td>
<td>VirtualNetwork</td>
<td>VirtualNetwork</td>
<td>*</td>
<td>Allow</td>
</tr>
<tr>
<td>4096</td>
<td>DenyAllInbound</td>
<td>Inbound</td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>Deny</td>
</tr>
</tbody>
</table>
<p><strong>NSG: nsg-pem-data-{env}</strong> (Applied to data-subnet)</p>
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 9%" />
<col style="width: 17%" />
<col style="width: 12%" />
<col style="width: 20%" />
<col style="width: 9%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr>
<th>Priority</th>
<th>Name</th>
<th>Direction</th>
<th>Source</th>
<th>Destination</th>
<th>Port</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>100</td>
<td>AllowAppSubnet</td>
<td>Inbound</td>
<td>10.201.1.0/24</td>
<td>VirtualNetwork</td>
<td>1433,6380,443</td>
<td>Allow</td>
</tr>
<tr>
<td>110</td>
<td>AllowFunctionsSubnet</td>
<td>Inbound</td>
<td>10.201.4.0/24</td>
<td>VirtualNetwork</td>
<td>1433,6380,443</td>
<td>Allow</td>
</tr>
<tr>
<td>200</td>
<td>AllowPrivateEndpoints</td>
<td>Inbound</td>
<td>VirtualNetwork</td>
<td>VirtualNetwork</td>
<td>*</td>
<td>Allow</td>
</tr>
<tr>
<td>4096</td>
<td>DenyAllInbound</td>
<td>Inbound</td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>Deny</td>
</tr>
</tbody>
</table>
<p><strong>NSG: nsg-pem-integration-{env}</strong> (Applied to
integration-subnet)</p>
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 9%" />
<col style="width: 17%" />
<col style="width: 12%" />
<col style="width: 20%" />
<col style="width: 9%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr>
<th>Priority</th>
<th>Name</th>
<th>Direction</th>
<th>Source</th>
<th>Destination</th>
<th>Port</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>100</td>
<td>AllowOnPremToApim</td>
<td>Inbound</td>
<td>10.0.0.0/8</td>
<td>VirtualNetwork</td>
<td>443</td>
<td>Allow</td>
</tr>
<tr>
<td>110</td>
<td>AllowAppSubnetToSB</td>
<td>Inbound</td>
<td>10.201.1.0/24</td>
<td>VirtualNetwork</td>
<td>5671,5672,443</td>
<td>Allow</td>
</tr>
<tr>
<td>120</td>
<td>AllowApimManagement</td>
<td>Inbound</td>
<td>ApiManagement</td>
<td>VirtualNetwork</td>
<td>3443</td>
<td>Allow</td>
</tr>
<tr>
<td>4096</td>
<td>DenyAllInbound</td>
<td>Inbound</td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>Deny</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="connectivity-resilience-and-failover">Connectivity Resilience
and Failover</h3>
<h4 id="expressroute-redundancy">ExpressRoute Redundancy</h4>
<p><strong>ExpressRoute Redundancy</strong></p>
<pre class="mermaid"><code>%%{init: {&#39;theme&#39;: &#39;default&#39;}}%%
flowchart LR
    subgraph ONPREM[&quot;ON-PREMISES&quot;]
        PRIMARY_R[&quot;Primary Edge Router&quot;]
        SECONDARY_R[&quot;Secondary Edge Router&quot;]
    end

    subgraph PROVIDER[&quot;EXPRESSROUTE PROVIDER&quot;]
        PRIMARY_C[&quot;Primary Circuit&lt;br/&gt;(Meet-Me Location A)&quot;]
        SECONDARY_C[&quot;Secondary Circuit&lt;br/&gt;(Meet-Me Location B)&quot;]
    end

    subgraph AZURE[&quot;AZURE (East US 2)&quot;]
        ER_GW[&quot;ExpressRoute Gateway&lt;br/&gt;(Zone-Redundant)&quot;]
    end

    PRIMARY_R &lt;--&gt; PRIMARY_C &lt;--&gt; ER_GW
    SECONDARY_R &lt;--&gt; SECONDARY_C &lt;--&gt; ER_GW</code></pre>
<p><strong>Failover Scenarios:</strong></p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 28%" />
<col style="width: 28%" />
<col style="width: 24%" />
</colgroup>
<thead>
<tr>
<th>Scenario</th>
<th>Detection Time</th>
<th>Failover Time</th>
<th>User Impact</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Primary circuit failure</strong></td>
<td>~30 seconds (BGP)</td>
<td>~60 seconds</td>
<td>Brief latency spike</td>
</tr>
<tr>
<td><strong>Provider location failure</strong></td>
<td>~30 seconds</td>
<td>~60 seconds</td>
<td>Automatic reroute</td>
</tr>
<tr>
<td><strong>Azure zone failure</strong></td>
<td>Immediate</td>
<td>Automatic</td>
<td>None (zone-redundant)</td>
</tr>
<tr>
<td><strong>Complete ExpressRoute failure</strong></td>
<td>~60 seconds</td>
<td>Manual VPN activation</td>
<td>See degraded mode</td>
</tr>
</tbody>
</table>
<h4 id="site-to-site-vpn-fallback-emergency-only">Site-to-Site VPN
Fallback (Emergency Only)</h4>
<p>If ExpressRoute becomes completely unavailable, a
<strong>Site-to-Site VPN</strong> can be activated as an emergency
fallback:</p>
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 25%" />
<col style="width: 30%" />
<col style="width: 27%" />
</colgroup>
<thead>
<tr>
<th>Path</th>
<th>Latency</th>
<th>Bandwidth</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ExpressRoute (Primary)</strong></td>
<td>~20ms</td>
<td>1 Gbps</td>
<td>Normal operation</td>
</tr>
<tr>
<td><strong>ExpressRoute (Secondary)</strong></td>
<td>~25ms</td>
<td>1 Gbps</td>
<td>Primary circuit failure</td>
</tr>
<tr>
<td><strong>Site-to-Site VPN (Emergency)</strong></td>
<td>~80-100ms</td>
<td>200 Mbps</td>
<td>Complete ER outage only</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Warning:</strong> VPN fallback requires manual activation by
Network Operations and results in degraded performance. It should only
be used during extended ExpressRoute outages.</p>
</blockquote>
<hr />
<h3 id="degraded-mode-and-offline-handling">Degraded Mode and Offline
Handling</h3>
<p>When Azure PEM connectivity is lost, Contract Manager operates in
<strong>degraded mode</strong> to maintain limited functionality.</p>
<h4 id="connectivity-loss-detection">Connectivity Loss Detection</h4>
<p>The PEM.Client SDK implements a circuit breaker pattern:</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">// PEM.Client SDK - Resilience Configuration</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>services<span class="op">.</span><span class="fu">AddPemClient</span><span class="op">(</span>options <span class="op">=&gt;</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    options<span class="op">.</span><span class="fu">BaseUrl</span> <span class="op">=</span> <span class="st">&quot;https://api-pem.azure-api.net&quot;</span><span class="op">;</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Circuit Breaker: Opens after 5 failures in 30 seconds</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    options<span class="op">.</span><span class="fu">CircuitBreaker</span> <span class="op">=</span> <span class="kw">new</span> CircuitBreakerOptions</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>        FailureThreshold <span class="op">=</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>        SamplingDuration <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromSeconds</span><span class="op">(</span><span class="dv">30</span><span class="op">),</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>        BreakDuration <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromSeconds</span><span class="op">(</span><span class="dv">60</span><span class="op">),</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>        OnBreak <span class="op">=</span> <span class="op">(</span>ex<span class="op">,</span> duration<span class="op">)</span> <span class="op">=&gt;</span> </span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>            _logger<span class="op">.</span><span class="fu">LogWarning</span><span class="op">(</span><span class="st">&quot;PEM circuit opened for {Duration}s&quot;</span><span class="op">,</span> duration<span class="op">.</span><span class="fu">TotalSeconds</span><span class="op">)</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Retry: 3 attempts with exponential backoff</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    options<span class="op">.</span><span class="fu">RetryPolicy</span> <span class="op">=</span> <span class="kw">new</span> RetryPolicyOptions</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>        MaxRetries <span class="op">=</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>        InitialDelay <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromMilliseconds</span><span class="op">(</span><span class="dv">200</span><span class="op">),</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>        MaxDelay <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromSeconds</span><span class="op">(</span><span class="dv">5</span><span class="op">),</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>        BackoffType <span class="op">=</span> BackoffType<span class="op">.</span><span class="fu">ExponentialWithJitter</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    options<span class="op">.</span><span class="fu">Timeout</span> <span class="op">=</span> TimeSpan<span class="op">.</span><span class="fu">FromSeconds</span><span class="op">(</span><span class="dv">30</span><span class="op">);</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span></code></pre></div>
<h4 id="degraded-mode-behavior">Degraded Mode Behavior</h4>
<p><strong>Degraded Mode Behavior</strong></p>
<table>
<thead>
<tr>
<th>Phase</th>
<th>Step</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>1. Detection</strong></td>
<td>Health Check Fails</td>
<td>3 consecutive failures</td>
</tr>
<tr>
<td></td>
<td>Circuit Breaker Opens</td>
<td>Stops calling Azure</td>
</tr>
<tr>
<td></td>
<td>Notify User</td>
<td>“PEM temporarily unavailable”</td>
</tr>
<tr>
<td><strong>2. Degraded Mode</strong></td>
<td>Queue Writes</td>
<td>Queue write operations locally</td>
</tr>
<tr>
<td></td>
<td>Serve Cache</td>
<td>Serve cached data (read-only)</td>
</tr>
<tr>
<td></td>
<td>Disable Features</td>
<td>Disable Azure-dependent features</td>
</tr>
<tr>
<td><strong>3. Recovery</strong></td>
<td>Health Probes</td>
<td>Every 60 seconds</td>
</tr>
<tr>
<td></td>
<td>Reconnect</td>
<td>Connection restored</td>
</tr>
<tr>
<td></td>
<td>Sync</td>
<td>Replay queued operations</td>
</tr>
<tr>
<td></td>
<td>Resume</td>
<td>Normal operation</td>
</tr>
</tbody>
</table>
<h4 id="feature-availability-during-degraded-mode">Feature Availability
During Degraded Mode</h4>
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 23%" />
<col style="width: 26%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Feature</th>
<th>Normal Mode</th>
<th>Degraded Mode</th>
<th>User Notification</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>View Episodes</strong></td>
<td>Live data</td>
<td>Cached (may be stale)</td>
<td>“Data may be up to X minutes old”</td>
</tr>
<tr>
<td><strong>Search Episodes</strong></td>
<td>Full search</td>
<td>Limited to cache</td>
<td>“Limited search available”</td>
</tr>
<tr>
<td><strong>Episode Detail</strong></td>
<td>Live</td>
<td>Cached</td>
<td>“Showing cached data”</td>
</tr>
<tr>
<td><strong>Create Episode</strong></td>
<td>Immediate</td>
<td>Disabled</td>
<td>“Unavailable during connectivity issues”</td>
</tr>
<tr>
<td><strong>Change Status</strong></td>
<td>Immediate</td>
<td>Queued</td>
<td>“Queued - will sync when connected”</td>
</tr>
<tr>
<td><strong>Ingest Claims</strong></td>
<td>Immediate</td>
<td>Queued</td>
<td>“Queued for processing”</td>
</tr>
<tr>
<td><strong>Bundle Calculation</strong></td>
<td>Available</td>
<td>Disabled</td>
<td>“Requires Azure connectivity”</td>
</tr>
<tr>
<td><strong>Contract Modeling</strong></td>
<td>Available</td>
<td>Disabled</td>
<td>“Requires Azure connectivity”</td>
</tr>
<tr>
<td><strong>Real-time Updates</strong></td>
<td>SignalR active</td>
<td>Disconnected</td>
<td>“Live updates paused”</td>
</tr>
</tbody>
</table>
<h4 id="local-queue-for-offline-operations">Local Queue for Offline
Operations</h4>
<p>Critical operations are queued locally in Contract Manager’s database
when Azure is unreachable:</p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Queueable?</th>
<th>Max Queue Size</th>
<th>Sync Priority</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Claim Ingestion</strong></td>
<td>Yes</td>
<td>10,000 claims</td>
<td>High</td>
</tr>
<tr>
<td><strong>Episode Status Change</strong></td>
<td>Yes</td>
<td>1,000 operations</td>
<td>High</td>
</tr>
<tr>
<td><strong>Add Note</strong></td>
<td>Yes</td>
<td>500 notes</td>
<td>Medium</td>
</tr>
<tr>
<td><strong>Bundle Calculation</strong></td>
<td>No</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td><strong>Modeling Scenarios</strong></td>
<td>No</td>
<td>N/A</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<p><strong>Queue Table Schema (Contract Manager on-prem):</strong></p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> PEM_OfflineQueue (</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">Id</span> UNIQUEIDENTIFIER <span class="kw">PRIMARY</span> <span class="kw">KEY</span> <span class="kw">DEFAULT</span> NEWID(),</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    OperationType <span class="dt">NVARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    PayloadJson <span class="dt">NVARCHAR</span>(<span class="fu">MAX</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    CreatedAt DATETIME2 <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> SYSUTCDATETIME(),</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    RetryCount <span class="dt">INT</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="dv">0</span>,</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    LastAttemptAt DATETIME2 <span class="kw">NULL</span>,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    Status <span class="dt">NVARCHAR</span>(<span class="dv">20</span>) <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="st">&#39;Pending&#39;</span>,</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    ErrorMessage <span class="dt">NVARCHAR</span>(<span class="fu">MAX</span>) <span class="kw">NULL</span>,</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">INDEX</span> IX_Status_Created (Status, CreatedAt)</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>);</span></code></pre></div>
<p>When connectivity is restored, a background service replays queued
operations in order.</p>
<hr />
<h3 id="connectivity-monitoring-and-alerting">Connectivity Monitoring
and Alerting</h3>
<h4 id="key-metrics">Key Metrics</h4>
<table style="width:100%;">
<colgroup>
<col style="width: 22%" />
<col style="width: 22%" />
<col style="width: 25%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Metric</th>
<th>Source</th>
<th>Warning</th>
<th>Critical</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ExpressRoute Circuit State</strong></td>
<td>Azure Monitor</td>
<td>N/A</td>
<td>Circuit down</td>
</tr>
<tr>
<td><strong>ExpressRoute BGP Availability</strong></td>
<td>Azure Monitor</td>
<td>&lt; 99.9%</td>
<td>&lt; 99%</td>
</tr>
<tr>
<td><strong>ExpressRoute Throughput</strong></td>
<td>Azure Monitor</td>
<td>&gt; 80% capacity</td>
<td>&gt; 95%</td>
</tr>
<tr>
<td><strong>API Latency (P95)</strong></td>
<td>App Insights</td>
<td>&gt; 150ms</td>
<td>&gt; 300ms</td>
</tr>
<tr>
<td><strong>Circuit Breaker State</strong></td>
<td>PEM.Client Metrics</td>
<td>Half-open</td>
<td>Open</td>
</tr>
<tr>
<td><strong>Offline Queue Depth</strong></td>
<td>CM Custom Metrics</td>
<td>&gt; 100 items</td>
<td>&gt; 1000 items</td>
</tr>
</tbody>
</table>
<h4 id="alert-configuration">Alert Configuration</h4>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 27%" />
<col style="width: 30%" />
<col style="width: 22%" />
</colgroup>
<thead>
<tr>
<th>Alert</th>
<th>Severity</th>
<th>Condition</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ExpressRoute Down</strong></td>
<td>Sev-0</td>
<td>Circuit bits/sec = 0 for 5 min</td>
<td>Page Network Ops + DevOps</td>
</tr>
<tr>
<td><strong>High Latency</strong></td>
<td>Sev-2</td>
<td>P95 &gt; 300ms for 5 min</td>
<td>Email DevOps</td>
</tr>
<tr>
<td><strong>Circuit Breaker Open</strong></td>
<td>Sev-1</td>
<td>Breaker in Open state</td>
<td>Page on-call engineer</td>
</tr>
<tr>
<td><strong>Queue Growing</strong></td>
<td>Sev-1</td>
<td>Queue &gt; 500 for 15 min</td>
<td>Email DevOps</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="terraform-configuration-for-connectivity">Terraform
Configuration for Connectivity</h3>
<pre class="hcl"><code># infrastructure/terraform/modules/connectivity/main.tf

# ExpressRoute Gateway (connects to existing circuit)
resource &quot;azurerm_virtual_network_gateway&quot; &quot;expressroute&quot; {
  name                = &quot;ergw-pem-${var.environment}&quot;
  location            = var.location
  resource_group_name = var.resource_group_name
  
  type = &quot;ExpressRoute&quot;
  sku  = var.is_production ? &quot;ErGw3AZ&quot; : &quot;ErGw1Az&quot;
  
  ip_configuration {
    name                          = &quot;ergw-ipconfig&quot;
    public_ip_address_id          = azurerm_public_ip.ergw.id
    private_ip_address_allocation = &quot;Dynamic&quot;
    subnet_id                     = var.gateway_subnet_id
  }
}

# Connection to existing ExpressRoute circuit
resource &quot;azurerm_express_route_circuit_connection&quot; &quot;pem&quot; {
  name                     = &quot;erconn-pem-${var.environment}&quot;
  peering_id               = var.expressroute_peering_id
  express_route_gateway_id = azurerm_virtual_network_gateway.expressroute.id
  authorization_key        = var.expressroute_auth_key
}

# Private DNS Zones for Private Endpoints
locals {
  private_dns_zones = [
    &quot;privatelink.database.windows.net&quot;,
    &quot;privatelink.documents.azure.com&quot;,
    &quot;privatelink.redis.cache.windows.net&quot;,
    &quot;privatelink.servicebus.windows.net&quot;,
    &quot;privatelink.azure-api.net&quot;,
    &quot;privatelink.blob.core.windows.net&quot;,
    &quot;privatelink.vaultcore.azure.net&quot;,
    &quot;privatelink.service.signalr.net&quot;,
    &quot;privatelink.azconfig.io&quot;
  ]
}

resource &quot;azurerm_private_dns_zone&quot; &quot;zones&quot; {
  for_each            = toset(local.private_dns_zones)
  name                = each.value
  resource_group_name = var.resource_group_name
}

# Link Private DNS to Hub VNet
resource &quot;azurerm_private_dns_zone_virtual_network_link&quot; &quot;hub_links&quot; {
  for_each = azurerm_private_dns_zone.zones
  
  name                  = &quot;link-hub-${replace(each.key, &quot;.&quot;, &quot;-&quot;)}&quot;
  resource_group_name   = var.resource_group_name
  private_dns_zone_name = each.value.name
  virtual_network_id    = var.hub_vnet_id
}

# Azure DNS Private Resolver for on-prem resolution
resource &quot;azurerm_private_dns_resolver&quot; &quot;main&quot; {
  name                = &quot;dnspr-pem-${var.environment}&quot;
  resource_group_name = var.resource_group_name
  location            = var.location
  virtual_network_id  = var.hub_vnet_id
}

resource &quot;azurerm_private_dns_resolver_inbound_endpoint&quot; &quot;main&quot; {
  name                    = &quot;inbound&quot;
  private_dns_resolver_id = azurerm_private_dns_resolver.main.id
  location                = var.location
  
  ip_configurations {
    private_ip_allocation_method = &quot;Dynamic&quot;
    subnet_id                    = var.dns_resolver_subnet_id
  }
}

output &quot;dns_resolver_ip&quot; {
  description = &quot;IP address for on-prem DNS conditional forwarder&quot;
  value       = azurerm_private_dns_resolver_inbound_endpoint.main.ip_configurations[0].private_ip_address
}</code></pre>
<hr />
<h2 id="scaling-strategy">Scaling Strategy</h2>
<h3 id="horizontal-scaling">Horizontal Scaling</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Trigger</th>
<th>Scale Range</th>
</tr>
</thead>
<tbody>
<tr>
<td>App Service</td>
<td>CPU &gt; 70%</td>
<td>1-10 instances</td>
</tr>
<tr>
<td>Azure Functions</td>
<td>Queue depth</td>
<td>0-100+ instances</td>
</tr>
<tr>
<td>Azure SQL</td>
<td>Manual/scheduled</td>
<td>4-16 vCores</td>
</tr>
<tr>
<td>Redis</td>
<td>Manual</td>
<td>Upgrade tier</td>
</tr>
</tbody>
</table>
<h3 id="performance-targets">Performance Targets</h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Target</th>
</tr>
</thead>
<tbody>
<tr>
<td>API response time (p95)</td>
<td>&lt; 500ms</td>
</tr>
<tr>
<td>Episode creation</td>
<td>&lt; 2 seconds</td>
</tr>
<tr>
<td>Bundle calculation</td>
<td>&lt; 5 seconds</td>
</tr>
<tr>
<td>Search (1000 results)</td>
<td>&lt; 1 second</td>
</tr>
</tbody>
</table>
<hr />
<p><strong>Document Status:</strong> ✅ <strong>Complete</strong><br />
<strong>Next Steps:</strong> Review with cloud architecture team,
finalize Azure resource decisions</p>
</body>
</html>
